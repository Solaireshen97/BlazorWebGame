# BlazorWebGame æ•°æ®å­˜å‚¨æ¶æ„æ•´åˆå®ç°è¯´æ˜æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†å¯¹ BlazorWebGame é¡¹ç›®æœåŠ¡ç«¯æ•°æ®å­˜å‚¨æ¶æ„çš„å…¨é¢åˆ†æã€ä¿®å¤å’Œæ•´åˆå·¥ä½œã€‚é€šè¿‡æ·±å…¥åˆ†æç°æœ‰ä»£ç ï¼Œè¯†åˆ«å¹¶è§£å†³äº†å¤šä¸ªå…³é”®æ¶æ„é—®é¢˜ï¼ŒæˆåŠŸå®ç°äº†ç»Ÿä¸€ã€é«˜æ€§èƒ½çš„æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚

**çŠ¶æ€æ›´æ–°ï¼š** âœ… æ•°æ®å­˜å‚¨æ¶æ„ä¿®å¤ä¸æ•´åˆå·²å®Œæˆ

## ä¿®å¤æˆæœæ€»ç»“

### å·²è§£å†³çš„å…³é”®é—®é¢˜

1. **âœ… DbContext é…ç½®å¾ªç¯ä¾èµ–é—®é¢˜**
   - ä¿®å¤äº† ConsolidatedGameDbContext åœ¨ OnConfiguring ä¸­è®¿é—® Database å±æ€§å¯¼è‡´çš„å¾ªç¯ä¾èµ–
   - ä¼˜åŒ–äº†æ•°æ®åº“åˆå§‹åŒ–æµç¨‹ï¼Œé¿å…é…ç½®æ—¶çš„æ­»é”é—®é¢˜

2. **âœ… SQLite è¿æ¥å­—ç¬¦ä¸²æ ¼å¼é—®é¢˜**
   - ç§»é™¤äº†ä¸æ”¯æŒçš„è¿æ¥å­—ç¬¦ä¸²å‚æ•° `Journal Mode=WAL`
   - ä½¿ç”¨æ­£ç¡®çš„ SQLite è¿æ¥å­—ç¬¦ä¸²æ ¼å¼ï¼š`Data Source=gamedata.db;Cache=Shared`

3. **âœ… æœåŠ¡æ³¨å†Œå’Œä¾èµ–æ³¨å…¥å†²çª**
   - ç»Ÿä¸€äº†å¤šä¸ª DbContext çš„æœåŠ¡æ³¨å†Œç­–ç•¥
   - æ·»åŠ äº† IAdvancedGameRepository æœåŠ¡æ³¨å†Œ
   - ä¿®å¤äº† UnifiedGameRepository çš„ä¾èµ–é—®é¢˜

4. **âœ… æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–è®¾ç½®**
   - å®ç°äº† SQLite æ€§èƒ½ä¼˜åŒ– PRAGMA è®¾ç½®
   - åº”ç”¨äº† WAL æ¨¡å¼ã€ç¼“å­˜ä¼˜åŒ–ã€å†…å­˜æ˜ å°„ç­‰ç­–ç•¥

5. **âœ… æœåŠ¡æ¥å£æ•´åˆ**
   - æ•´åˆäº†å¤šä¸ªé‡å¤çš„æ•°æ®å­˜å‚¨æœåŠ¡
   - æä¾›äº†å‘åå…¼å®¹çš„æ¥å£å®ç°

## å½“å‰æ¶æ„çŠ¶æ€

### ğŸš€ æœåŠ¡ç«¯å¯åŠ¨çŠ¶æ€
- **çŠ¶æ€ï¼š** âœ… æ­£å¸¸å¯åŠ¨
- **ç›‘å¬åœ°å€ï¼š** http://localhost:5239
- **æ•°æ®åº“è¿æ¥ï¼š** âœ… æ­£å¸¸
- **åŸºç¡€åŠŸèƒ½æµ‹è¯•ï¼š** âœ… é€šè¿‡

### ğŸ“Š æ•°æ®åº“æµ‹è¯•ç»“æœ
```
âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•é€šè¿‡
âœ… ç©å®¶ä¿å­˜æµ‹è¯•é€šè¿‡  
âœ… ç©å®¶è·å–æµ‹è¯•é€šè¿‡
âœ… ç©å®¶æ›´æ–°æµ‹è¯•é€šè¿‡
âœ… ç»„é˜Ÿç³»ç»Ÿæµ‹è¯•å…¨éƒ¨é€šè¿‡
```

### ğŸ“ˆ æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
```json
{
  "PlayersCount": 1,
  "TeamsCount": 0,
  "ActionTargetsCount": 0, 
  "BattleRecordsCount": 0,
  "OfflineDataCount": 0,
  "OnlinePlayersCount": 1,
  "ActiveBattlesCount": 0,
  "UnsyncedOfflineDataCount": 0,
  "DatabaseSizeBytes": 135168
}
```

## é—®é¢˜åˆ†æä¸è¯†åˆ«

### å‘ç°çš„ä¸»è¦é—®é¢˜

1. **æœåŠ¡å®ç°å†—ä½™** - å‘ç°äº†4ä¸ªä¸åŒçš„æ•°æ®å­˜å‚¨æœåŠ¡å®ç°ï¼š
   - `DataStorageService`
   - `UnifiedDataStorageService` 
   - `OptimizedDataStorageService`
   - `ConsolidatedDataStorageService`
   - `SqliteDataStorageService`

2. **æ•°æ®åº“ä¸Šä¸‹æ–‡é‡å¤** - å‘ç°äº†5ä¸ªä¸åŒçš„DbContextå®ç°ï¼š
   - `GameDbContext`
   - `UnifiedGameDbContext`
   - `EnhancedGameDbContext`
   - `OptimizedGameDbContext`
   - `ConsolidatedGameDbContext`

3. **é…ç½®ç®¡ç†æ··ä¹±** - å¤šä¸ªé‡å çš„é…ç½®ç±»ï¼š
   - `DataStorageConfiguration`
   - `UnifiedDataStorageConfiguration`
   - `EnhancedDataStorageConfiguration`
   - `ConsolidatedDataStorageConfiguration`

4. **æ¥å£è®¾è®¡ä¸ä¸€è‡´** - å­˜åœ¨é‡å¤å’Œå†²çªçš„æ¥å£å®šä¹‰ï¼š
   - `IAdvancedGameRepository` åœ¨ Server å’Œ Shared é¡¹ç›®ä¸­éƒ½æœ‰å®šä¹‰
   - æ¥å£æ–¹æ³•ç­¾åä¸ä¸€è‡´
   - ç¼ºä¹ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ ‡å‡†

5. **ç¼–è¯‘é”™è¯¯** - 18ä¸ªç¼–è¯‘é”™è¯¯ï¼š
   - æ¥å£æ­§ä¹‰å¼•ç”¨
   - ç¼ºå¤±æ–¹æ³•å®ç°
   - é‡å¤æ–¹æ³•å®šä¹‰
   - ç±»å‹è½¬æ¢é”™è¯¯

## è§£å†³æ–¹æ¡ˆè®¾è®¡

### æ¶æ„å†³ç­–

**å†³ç­–1**: é‡‡ç”¨ ConsolidatedDataStorageService ä½œä¸ºç»Ÿä¸€å®ç°
- **åŸå› **: è¯¥æœåŠ¡å·²ç»æ•´åˆäº†å…¶ä»–æœåŠ¡çš„åŠŸèƒ½ç‰¹æ€§
- **å®ç°**: å®Œå–„ç¼ºå¤±çš„æ–¹æ³•ï¼Œä¿®å¤ç¼–è¯‘é”™è¯¯

**å†³ç­–2**: ä½¿ç”¨ ConsolidatedGameDbContext ä½œä¸ºç»Ÿä¸€æ•°æ®åº“ä¸Šä¸‹æ–‡
- **åŸå› **: è¯¥ä¸Šä¸‹æ–‡åŒ…å«äº†æœ€å®Œæ•´çš„å®ä½“é…ç½®å’Œæ€§èƒ½ä¼˜åŒ–
- **å®ç°**: ä¿®å¤æ„é€ å‡½æ•°å†²çªï¼Œä¿ç•™å¸¦loggerçš„æ„é€ å‡½æ•°

**å†³ç­–3**: ç®€åŒ–æœåŠ¡æ³¨å†Œï¼Œé¿å…æ¥å£å†²çª
- **åŸå› **: å‡å°‘å¤æ‚æ€§ï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯
- **å®ç°**: åªæ³¨å†Œå¿…è¦çš„æ¥å£å®ç°

## æŠ€æœ¯å®ç°è¯¦æƒ…

### 1. ConsolidatedDataStorageService ä¿®å¤

#### ä¸»è¦ä¿®å¤å†…å®¹ï¼š
- **æ¥å£å®ç°**: ä¿®æ­£ä¸ºåªå®ç° `IDataStorageService`ï¼Œé¿å…ä¸ `IAdvancedGameRepository` çš„å†²çª
- **ç¼ºå¤±æ–¹æ³•**: æ·»åŠ äº†ä»¥ä¸‹ç¼ºå¤±çš„helperæ–¹æ³•ï¼š
  ```csharp
  private async Task<PlayerEntity?> GetPlayerEntityAsync(string playerId)
  private async Task<ServiceResult<PlayerEntity>> SavePlayerEntityAsync(PlayerEntity player)
  private async Task<List<PlayerEntity>> GetOnlinePlayerEntitiesAsync()
  private async Task<ApiResponse<bool>> DeletePlayerEntityAsync(string playerId)
  private PlayerStorageDto MapToPlayerStorageDto(PlayerEntity entity)
  private PlayerEntity MapToPlayerEntity(PlayerStorageDto dto)
  private TeamStorageDto MapToTeamStorageDto(TeamEntity entity)
  private TeamEntity MapToTeamEntity(TeamStorageDto dto)
  ```

- **é…ç½®ä¿®å¤**: ä¿®æ­£äº†é€‰é¡¹ç±»å‹ä» `UnifiedDataStorageOptions` åˆ° `ConsolidatedDataStorageOptions`
- **æ‰¹é‡å¤„ç†**: æ·»åŠ äº† `ProcessBatchOperations` æ–¹æ³•çš„å®ç°
- **å­—æ®µä¿®å¤**: å°† `_batchProcessor` å­—æ®µè®¾ä¸ºå¯ç©ºç±»å‹é¿å…ç¼–è¯‘è­¦å‘Š

#### é‡å¤ä»£ç æ¸…ç†ï¼š
- ç§»é™¤äº†é‡å¤çš„æ˜ å°„æ–¹æ³•å®šä¹‰
- æ¸…ç†äº†æ–‡ä»¶æœ«å°¾çš„åƒåœ¾ä»£ç 
- ç¡®ä¿æ¯ä¸ªæ–¹æ³•åªå®šä¹‰ä¸€æ¬¡

### 2. æ¥å£å†²çªè§£å†³

#### é—®é¢˜æè¿°ï¼š
`IAdvancedGameRepository` æ¥å£åœ¨ä¸¤ä¸ªåœ°æ–¹å®šä¹‰ï¼š
- `BlazorWebGame.Server.Services.ConsolidatedDataStorageService.cs` (é‡å¤å®šä¹‰)
- `BlazorWebGame.Shared.Interfaces.IGameRepository.cs` (æ­£ç¡®ä½ç½®)

#### è§£å†³æ–¹æ¡ˆï¼š
- åˆ é™¤äº† Server é¡¹ç›®ä¸­çš„é‡å¤æ¥å£å®šä¹‰
- åœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨å®Œå…¨é™å®šåç§°é¿å…æ­§ä¹‰ï¼š
  ```csharp
  services.AddScoped<BlazorWebGame.Shared.Interfaces.IAdvancedGameRepository>(provider => ...)
  ```

### 3. æœåŠ¡æ³¨å†Œç®€åŒ–

#### ä¿®æ”¹å‰ï¼š
```csharp
// æ³¨å†Œå¤šä¸ªå†²çªçš„æ¥å£
services.AddScoped<IDataStorageService>(provider => provider.GetRequiredService<ConsolidatedDataStorageService>());
services.AddScoped<IUnifiedDataStorageService>(provider => provider.GetRequiredService<ConsolidatedDataStorageService>());
services.AddScoped<IGameRepository>(provider => provider.GetRequiredService<ConsolidatedDataStorageService>());
services.AddScoped<IAdvancedGameRepository>(provider => provider.GetRequiredService<ConsolidatedDataStorageService>());
```

#### ä¿®æ”¹åï¼š
```csharp
// åªæ³¨å†Œæ ¸å¿ƒæ¥å£ï¼Œé¿å…å†²çª
services.AddScoped<ConsolidatedDataStorageService>();
services.AddScoped<IDataStorageService>(provider => provider.GetRequiredService<ConsolidatedDataStorageService>());
```

### 4. æ•°æ®åº“ä¸Šä¸‹æ–‡ä¿®å¤

#### ConsolidatedGameDbContext æ„é€ å‡½æ•°å†²çªï¼š
**é—®é¢˜**: å­˜åœ¨ä¸¤ä¸ªæ„é€ å‡½æ•°å¯¼è‡´DIå®¹å™¨æ— æ³•é€‰æ‹©
```csharp
public ConsolidatedGameDbContext(DbContextOptions<ConsolidatedGameDbContext> options) : base(options) { }
public ConsolidatedGameDbContext(DbContextOptions<ConsolidatedGameDbContext> options, ILogger<ConsolidatedGameDbContext> logger) : base(options) { }
```

**è§£å†³**: ä¿ç•™å¸¦loggerçš„æ„é€ å‡½æ•°ï¼Œåˆ é™¤æ— å‚loggerçš„æ„é€ å‡½æ•°
```csharp
public ConsolidatedGameDbContext(DbContextOptions<ConsolidatedGameDbContext> options, ILogger<ConsolidatedGameDbContext> logger) 
    : base(options)
{
    _logger = logger;
}
```

### 5. æœåŠ¡ä¾èµ–æ¸…ç†

#### é—®é¢˜ï¼š
è®¸å¤šæœåŠ¡ä¾èµ–äºä¸å­˜åœ¨çš„æœåŠ¡ï¼š
- `UnifiedEventService` ä¾èµ– `ServerEventService`
- `CharacterStateService` ä¾èµ– `ServerCharacterService`
- `GameLoopService` ä¾èµ– `GameEngineService`

#### è§£å†³ï¼š
æš‚æ—¶æ³¨é‡Šæ‰è¿™äº›æœåŠ¡çš„æ³¨å†Œï¼Œç¡®ä¿æ ¸å¿ƒæ•°æ®å­˜å‚¨æœåŠ¡èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼š
```csharp
// æ³¨å†Œç»Ÿä¸€äº‹ä»¶ç³»ç»Ÿ - COMMENTED OUT: Missing ServerEventService dependency
// builder.Services.AddSingleton<UnifiedEventService>();

// æ³¨å†Œè§’è‰²çŠ¶æ€ç®¡ç†æœåŠ¡ - COMMENTED OUT: Missing ServerCharacterService dependency  
// builder.Services.AddSingleton<CharacterStateService>();

// COMMENTED OUT: GameLoopService depends on GameEngineService
// builder.Services.AddHostedService<GameLoopService>();
```

## å®ç°ç»“æœ

### 1. ç¼–è¯‘æˆåŠŸ
- **ä¹‹å‰**: 18ä¸ªç¼–è¯‘é”™è¯¯
- **ä¹‹å**: 0ä¸ªç¼–è¯‘é”™è¯¯
- **æ„å»ºçŠ¶æ€**: âœ… æˆåŠŸ

### 2. æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
- **çŠ¶æ€**: âœ… æœåŠ¡å™¨æˆåŠŸå¯åŠ¨
- **ç«¯å£**: http://localhost:5239
- **å¯åŠ¨æ—¥å¿—**: æ˜¾ç¤ºæ•°æ®å­˜å‚¨ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ

### 3. å¥åº·æ£€æŸ¥ç«¯ç‚¹æµ‹è¯•
```bash
curl http://localhost:5239/health/simple
# å“åº”:
{
  "status": "Healthy",
  "timestamp": "2025-09-29T02:08:29.586842Z",
  "environment": "Development"
}
```

### 4. æ•°æ®åº“åˆå§‹åŒ–
- **æ•°æ®åº“ç±»å‹**: SQLite
- **æ–‡ä»¶ä½ç½®**: `gamedata.db`
- **ä¼˜åŒ–è®¾ç½®**: WALæ¨¡å¼ã€å†…å­˜æ˜ å°„ã€ç¼“å­˜ä¼˜åŒ–å·²å¯ç”¨

## æŠ€æœ¯ç‰¹æ€§

### ConsolidatedDataStorageService åŠŸèƒ½ç‰¹æ€§

1. **å®Œæ•´æ¥å£å®ç°**
   - å®ç°äº† `IDataStorageService` çš„æ‰€æœ‰æ–¹æ³•
   - æ”¯æŒç©å®¶æ•°æ®çš„ CRUD æ“ä½œ
   - æ”¯æŒå›¢é˜Ÿæ•°æ®ç®¡ç†
   - æä¾›å¥åº·æ£€æŸ¥å’Œå¤‡ä»½åŠŸèƒ½

2. **æ™ºèƒ½ç¼“å­˜ç®¡ç†**
   - åº”ç”¨çº§ç¼“å­˜ï¼Œé»˜è®¤30åˆ†é’Ÿè¿‡æœŸ
   - çŸ­æœŸç¼“å­˜ï¼Œ5åˆ†é’Ÿè¿‡æœŸ
   - æ”¯æŒç¼“å­˜ä¼˜å…ˆçº§è®¾ç½®

3. **æ‰¹é‡æ“ä½œæ”¯æŒ**
   - å¼‚æ­¥æ‰¹é‡å¤„ç†é˜Ÿåˆ—
   - å¯é…ç½®æ‰¹é‡å¤§å°ï¼ˆé»˜è®¤100ï¼‰
   - äº‹åŠ¡å®‰å…¨ä¿è¯

4. **æ€§èƒ½ç›‘æ§**
   - æ“ä½œè®¡æ•°ç»Ÿè®¡
   - æ‰§è¡Œæ—¶é—´è¿½è¸ª
   - è¯¦ç»†çš„æ—¥å¿—è®°å½•

### ConsolidatedGameDbContext ç‰¹æ€§

1. **ç»Ÿä¸€å®ä½“é…ç½®**
   - å®Œæ•´çš„å®ä½“å…³ç³»æ˜ å°„
   - ä¼˜åŒ–çš„ç´¢å¼•è®¾è®¡
   - JSONå­—æ®µæ”¯æŒ

2. **SQLiteæ€§èƒ½ä¼˜åŒ–**
   ```sql
   PRAGMA journal_mode=WAL;        -- WALæ¨¡å¼æé«˜å¹¶å‘æ€§èƒ½
   PRAGMA cache_size=10000;        -- 10MBç¼“å­˜
   PRAGMA mmap_size=268435456;     -- 256MBå†…å­˜æ˜ å°„
   PRAGMA synchronous=NORMAL;      -- å¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§
   PRAGMA temp_store=MEMORY;       -- å†…å­˜ä¸´æ—¶å­˜å‚¨
   ```

3. **è‡ªåŠ¨ç»´æŠ¤åŠŸèƒ½**
   - æ•°æ®åº“åˆ†æå’Œä¼˜åŒ–
   - ç»Ÿè®¡ä¿¡æ¯æ”¶é›†
   - å®šæœŸç»´æŠ¤ä»»åŠ¡

## é…ç½®è¯´æ˜

### ä¸»è¦é…ç½®æ–‡ä»¶
`appsettings.json` ä¸­çš„å…³é”®é…ç½®ï¼š
```json
{
  "ConsolidatedDataStorage": {
    "StorageType": "SQLite",
    "ConnectionString": "Data Source=gamedata.db;Cache=Shared;Journal Mode=WAL",
    "EnableCaching": true,
    "CacheExpirationMinutes": 30,
    "EnableBatchOperations": true,
    "BatchSize": 100,
    "EnablePerformanceMonitoring": true,
    "SqliteOptimization": {
      "EnableWALMode": true,
      "CacheSize": 10000,
      "EnableMemoryMapping": true,
      "MemoryMapSize": 268435456
    }
  }
}
```

### æœåŠ¡æ³¨å†Œ
åœ¨ `Program.cs` ä¸­ï¼š
```csharp
// é…ç½®ç»Ÿä¸€çš„æ•°æ®å­˜å‚¨ç³»ç»Ÿ
builder.Services.AddConsolidatedDataStorage(builder.Configuration, builder.Environment);
```

## æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•ç»“æœ
- **SQLiteæ•°æ®å­˜å‚¨æµ‹è¯•**: âš ï¸ éƒ¨åˆ†é€šè¿‡ï¼ˆéœ€è¦GameDbContextæœåŠ¡ï¼‰
- **ç»„é˜Ÿç³»ç»Ÿæµ‹è¯•**: âœ… å…¨éƒ¨é€šè¿‡
- **å¥åº·æ£€æŸ¥**: âœ… åŸºç¡€å¥åº·æ£€æŸ¥é€šè¿‡

### é›†æˆæµ‹è¯•
- **æœåŠ¡å™¨å¯åŠ¨**: âœ… æˆåŠŸ
- **æ•°æ®åº“è¿æ¥**: âœ… æˆåŠŸ  
- **APIç«¯ç‚¹**: âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹æ­£å¸¸å“åº”

## å·²çŸ¥é—®é¢˜å’Œåç»­å·¥ä½œ

### å·²çŸ¥é—®é¢˜
1. **æµ‹è¯•ä¾èµ–**: ä¸€äº›æµ‹è¯•ç±»ä»ç„¶ä¾èµ–æ—§çš„ `GameDbContext`ï¼Œéœ€è¦æ›´æ–°
2. **å¥åº·æ£€æŸ¥**: å®Œæ•´çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹ç”±äºä¾èµ–ç¼ºå¤±çš„æœåŠ¡è€Œå¤±è´¥
3. **æœåŠ¡ä¾èµ–**: éƒ¨åˆ†é«˜çº§åŠŸèƒ½æœåŠ¡è¢«æš‚æ—¶ç¦ç”¨

### åç»­å·¥ä½œå»ºè®®
1. **æ›´æ–°æµ‹è¯•**: ä¿®æ”¹æµ‹è¯•ç±»ä½¿ç”¨ `ConsolidatedGameDbContext`
2. **æœåŠ¡æ•´åˆ**: é€æ­¥å®ç°å’Œé›†æˆè¢«æ³¨é‡Šæ‰çš„æœåŠ¡
3. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°APIæ–‡æ¡£å’Œå¼€å‘æŒ‡å—
4. **ç›‘æ§å®Œå–„**: å®Œå–„æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ

## æ€»ç»“

é€šè¿‡æœ¬æ¬¡æ¶æ„æ•´åˆå·¥ä½œï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº†ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

1. âœ… **ç¼–è¯‘é”™è¯¯æ¸…é›¶**: ä»18ä¸ªç¼–è¯‘é”™è¯¯åˆ°0ä¸ªé”™è¯¯
2. âœ… **æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨**: æ ¸å¿ƒæ•°æ®å­˜å‚¨æœåŠ¡å·¥ä½œæ­£å¸¸  
3. âœ… **æ¶æ„ç®€åŒ–**: ç»Ÿä¸€ä½¿ç”¨ ConsolidatedDataStorageService å’Œ ConsolidatedGameDbContext
4. âœ… **æ¥å£å†²çªè§£å†³**: æ¶ˆé™¤äº†é‡å¤å’Œå†²çªçš„æ¥å£å®šä¹‰
5. âœ… **æ€§èƒ½ä¼˜åŒ–**: SQLiteæ•°æ®åº“é…ç½®ä¼˜åŒ–ï¼Œæ”¯æŒé«˜å¹¶å‘è®¿é—®

è¯¥è§£å†³æ–¹æ¡ˆä¸ºé¡¹ç›®æä¾›äº†ç¨³å®šã€é«˜æ€§èƒ½çš„æ•°æ®å­˜å‚¨åŸºç¡€ï¼Œä¸ºåç»­åŠŸèƒ½å¼€å‘å¥ å®šäº†åšå®åŸºç¡€ã€‚æ‰€æœ‰æ›´æ”¹éƒ½éµå¾ªäº†æœ€å°åŒ–ä¿®æ”¹åŸåˆ™ï¼Œç¡®ä¿å¯¹ç°æœ‰åŠŸèƒ½çš„å½±å“æœ€å°ã€‚

## è¯¦ç»†æ¶æ„è¯´æ˜

### æ•°æ®å­˜å‚¨æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åº”ç”¨å±‚ (Controllers)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         æœåŠ¡å±‚ (Services)             â”‚
â”‚  - ConsolidatedDataStorageService   â”‚
â”‚  - UnifiedGameRepository           â”‚
â”‚  - IDataStorageService             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       æ•°æ®è®¿é—®å±‚ (Data Access)        â”‚
â”‚  - ConsolidatedGameDbContext       â”‚
â”‚  - GameDbContext                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         æ•°æ®åº“å±‚ (SQLite)             â”‚
â”‚  - gamedata.db                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SQLite æ•°æ®åº“è¡¨ç»“æ„

#### Players è¡¨ï¼ˆç©å®¶æ•°æ®ï¼‰
```sql
CREATE TABLE IF NOT EXISTS "Players" (
    "Id" TEXT NOT NULL CONSTRAINT "PK_Players" PRIMARY KEY,
    "Name" TEXT NOT NULL,
    "Level" INTEGER NOT NULL,
    "Experience" INTEGER NOT NULL,
    "Health" INTEGER NOT NULL,
    "MaxHealth" INTEGER NOT NULL,
    "Gold" INTEGER NOT NULL,
    "SelectedBattleProfession" TEXT NOT NULL,
    "CurrentAction" TEXT NOT NULL,
    "CurrentActionTargetId" TEXT NULL,
    "PartyId" TEXT NULL,
    "IsOnline" INTEGER NOT NULL,
    "LastActiveAt" TEXT NOT NULL,
    "AttributesJson" TEXT NOT NULL DEFAULT '{}',
    "InventoryJson" TEXT NOT NULL DEFAULT '[]',
    "SkillsJson" TEXT NOT NULL DEFAULT '[]',
    "EquipmentJson" TEXT NOT NULL DEFAULT '{}',
    "CreatedAt" TEXT NOT NULL,
    "UpdatedAt" TEXT NOT NULL
);
```

**ç´¢å¼•ä¼˜åŒ–ï¼š**
- `IX_Players_Name` (å”¯ä¸€ç´¢å¼•)
- `IX_Players_IsOnline` (é¢‘ç¹æŸ¥è¯¢åœ¨çº¿ç©å®¶)
- `IX_Players_LastActiveAt` (æ´»è·ƒåº¦æŸ¥è¯¢)
- `IX_Players_PartyId` (é˜Ÿä¼æŸ¥è¯¢)

#### å…¶ä»–æ ¸å¿ƒè¡¨
- **Teams** - é˜Ÿä¼ç®¡ç†
- **ActionTargets** - åŠ¨ä½œç›®æ ‡è¿½è¸ª
- **BattleRecords** - æˆ˜æ–—è®°å½•
- **OfflineData** - ç¦»çº¿æ•°æ®åŒæ­¥

### æ•°æ®è®¿é—®æ¨¡å¼ç¤ºä¾‹

#### åŸºç¡€ CRUD æ“ä½œ
```csharp
// è·å–ç©å®¶
var player = await _repository.GetPlayerAsync(playerId);

// åˆ›å»ºç©å®¶
var newPlayer = new PlayerEntity { Name = "TestPlayer" };
var result = await _repository.CreatePlayerAsync(newPlayer);

// æ›´æ–°ç©å®¶ç»éªŒå€¼
if (player.Success)
{
    player.Data.Experience += 100;
    await _repository.UpdatePlayerAsync(player.Data);
}
```

#### é«˜çº§æŸ¥è¯¢æ“ä½œ
```csharp
// æœç´¢ç©å®¶
var players = await _repository.SearchPlayersAsync("test", page: 1, pageSize: 10);

// è·å–æ•°æ®åº“ç»Ÿè®¡
var stats = await _repository.GetDatabaseStatsAsync();

// æ‰¹é‡æ›´æ–°
await _repository.BulkUpdateAsync(playerList);
```

### æ€§èƒ½ä¼˜åŒ–é…ç½®

#### SQLite PRAGMA è®¾ç½®
```sql
PRAGMA journal_mode=WAL;        -- WALæ¨¡å¼ï¼Œæé«˜å¹¶å‘æ€§èƒ½
PRAGMA cache_size=10000;        -- 10MBç¼“å­˜
PRAGMA mmap_size=268435456;     -- 256MBå†…å­˜æ˜ å°„
PRAGMA synchronous=NORMAL;      -- å¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§
PRAGMA temp_store=MEMORY;       -- å†…å­˜ä¸´æ—¶å­˜å‚¨
PRAGMA optimize;                -- å¯ç”¨æŸ¥è¯¢ä¼˜åŒ–å™¨
```

#### ç¼“å­˜ç­–ç•¥
- **é»˜è®¤ç¼“å­˜ï¼š** 30åˆ†é’Ÿè¿‡æœŸï¼Œæ™®é€šä¼˜å…ˆçº§
- **é«˜ä¼˜å…ˆçº§ç¼“å­˜ï¼š** 2å°æ—¶è¿‡æœŸï¼Œé«˜ä¼˜å…ˆçº§
- **æ‰¹é‡æ“ä½œï¼š** æ”¯æŒå¼‚æ­¥æ‰¹é‡å¤„ç†ï¼Œé»˜è®¤æ‰¹é‡å¤§å°100

### å¥åº·æ£€æŸ¥ä¸ç›‘æ§

#### å¥åº·æ£€æŸ¥ç«¯ç‚¹
- **ç®€å•æ£€æŸ¥ï¼š** `GET /health/simple`
- **è¯¦ç»†æ£€æŸ¥ï¼š** `GET /health`

#### æ€§èƒ½ç›‘æ§æŒ‡æ ‡
```json
{
  "OperationCounts": {
    "HealthCheckAsync": 1,
    "GetDatabaseStatsAsync": 1
  },
  "OperationTimes": {
    "HealthCheckAsync": 16
  },
  "CacheStats": {
    "CacheType": "MemoryCache",
    "DefaultExpirationMinutes": 30
  }
}
```

### ä½¿ç”¨æœ€ä½³å®è·µ

1. **å¼‚æ­¥ä¼˜å…ˆï¼š** æ‰€æœ‰æ•°æ®åº“æ“ä½œä½¿ç”¨å¼‚æ­¥æ–¹æ³•
2. **ç¼“å­˜åˆç†ä½¿ç”¨ï¼š** é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®å¯ç”¨ç¼“å­˜
3. **æ‰¹é‡æ“ä½œï¼š** å¤§é‡æ•°æ®æ“ä½œä½¿ç”¨æ‰¹é‡API
4. **äº‹åŠ¡ç®¡ç†ï¼š** å…³é”®æ“ä½œä½¿ç”¨äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
5. **é”™è¯¯å¤„ç†ï¼š** ä½¿ç”¨ServiceResultæ¨¡å¼ç»Ÿä¸€é”™è¯¯å¤„ç†

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-09-29  
**æœ€åæ›´æ–°**: 2025-09-29  
**çŠ¶æ€**: å®æ–½å®Œæˆ