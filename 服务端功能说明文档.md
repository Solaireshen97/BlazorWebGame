# BlazorWebGame 服务端功能说明文档

## 项目概述

BlazorWebGame 是一个基于 ASP.NET Core 8.0 的现代化Web游戏后端服务，采用微服务架构设计，提供了完整的MMORPG游戏功能支持。

### 技术栈
- **框架**: ASP.NET Core 8.0
- **实时通信**: SignalR
- **身份认证**: JWT Bearer Token
- **日志系统**: Serilog
- **API文档**: Swagger/OpenAPI 3.0
- **依赖注入**: Microsoft.Extensions.DependencyInjection

## 核心架构组件

### 1. 应用程序入口 (Program.cs)
**配置特性**：
- 完整的中间件管道配置
- JWT身份验证和授权
- CORS跨域资源共享配置
- 速率限制防护
- Serilog结构化日志
- 健康检查系统

**服务注册模式**：
```csharp
// 单例服务 - 游戏核心组件
builder.Services.AddSingleton<GameEngineService>();
builder.Services.AddSingleton<UnifiedEventService>();

// 后台服务 - 持续运行的任务
builder.Services.AddHostedService<GameLoopService>();
builder.Services.AddHostedService<ServerOptimizationService>();
```

### 2. 中间件管道架构
执行顺序（重要）：
1. **HTTPS重定向** - 强制HTTPS连接
2. **CORS** - 跨域资源共享
3. **请求日志** - 记录所有HTTP请求
4. **速率限制** - 防止API滥用
5. **错误处理** - 全局异常捕获
6. **身份认证** - JWT令牌验证
7. **授权** - 权限检查

## API接口详细文档

### 🔐 认证模块 (AuthController)

#### 用户登录
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "string",
  "password": "string"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "string",
    "expiresAt": "2024-01-01T00:00:00Z",
    "userId": "string",
    "username": "string"
  },
  "message": "Login successful",
  "timestamp": "2024-01-01T00:00:00Z"
}
```

#### 用户注册
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "string",
  "password": "string",
  "email": "string"
}
```

#### 令牌刷新
```http
POST /api/auth/refresh
Content-Type: application/json

{
  "refreshToken": "string"
}
```

#### 用户登出
```http
POST /api/auth/logout
Authorization: Bearer {token}
```

### ⚔️ 战斗模块 (BattleController)

#### 开始战斗
```http
POST /api/battle/start
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "enemyId": "string",
  "partyId": "string" // 可选
}
```

**安全验证**:
- ✅ 角色归属权验证
- ✅ 游戏状态验证  
- ✅ 队伍权限验证（如果是组队战斗）

**响应**:
```json
{
  "success": true,
  "data": {
    "battleId": "guid",
    "characterId": "string",
    "enemyId": "string",
    "partyId": "string",
    "isActive": true,
    "playerHealth": 100,
    "playerMaxHealth": 100,
    "enemyHealth": 80,
    "enemyMaxHealth": 80,
    "lastUpdated": "2024-01-01T00:00:00Z",
    "battleType": "Normal",
    "partyMemberIds": ["string"],
    "players": [...],
    "enemies": [...],
    "status": "Active"
  }
}
```

#### 获取战斗状态
```http
GET /api/battle/state/{battleId}
Authorization: Bearer {token}
```

#### 执行战斗动作
```http
POST /api/battle/action
Authorization: Bearer {token}
Content-Type: application/json

{
  "battleId": "guid",
  "playerId": "string",
  "actionType": "Attack", // Attack, Skill, Item, Defend
  "targetId": "string",
  "skillId": "string" // 可选，使用技能时需要
}
```

#### 停止战斗
```http
POST /api/battle/stop/{battleId}
Authorization: Bearer {token}
```

#### 获取活跃战斗列表
```http
GET /api/battle/active
Authorization: Bearer {token}
```

### 👤 角色管理模块 (CharacterController)

#### 获取角色列表
```http
GET /api/character
Authorization: Bearer {token}
```

#### 获取角色详情
```http
GET /api/character/{characterId}
Authorization: Bearer {token}
```

#### 创建角色
```http
POST /api/character
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "string",
  "characterClass": "Warrior", // Warrior, Mage, Archer等
  "attributes": {
    "strength": 10,
    "intelligence": 10,
    "agility": 10
  }
}
```

#### 更新角色
```http
PUT /api/character/{characterId}
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "string",
  "attributes": {...}
}
```

### 👥 队伍管理模块 (PartyController)

#### 创建队伍
```http
POST /api/party/create
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "string",
  "maxMembers": 5,
  "isPublic": true,
  "description": "string"
}
```

#### 加入队伍
```http
POST /api/party/join
Authorization: Bearer {token}
Content-Type: application/json

{
  "partyId": "string",
  "characterId": "string"
}
```

#### 离开队伍
```http
POST /api/party/leave/{partyId}
Authorization: Bearer {token}
```

#### 获取队伍信息
```http
GET /api/party/{partyId}
Authorization: Bearer {token}
```

### 🎒 背包管理模块 (InventoryController)

#### 获取背包内容
```http
GET /api/inventory/{characterId}
Authorization: Bearer {token}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "characterId": "string",
    "items": [
      {
        "itemId": "string",
        "name": "Health Potion",
        "quantity": 5,
        "rarity": "Common",
        "type": "Consumable",
        "description": "Restores 50 HP"
      }
    ],
    "capacity": 50,
    "usedSlots": 25
  }
}
```

#### 使用物品
```http
POST /api/inventory/use
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "itemId": "string",
  "quantity": 1
}
```

#### 丢弃物品
```http
DELETE /api/inventory/item/{itemId}
Authorization: Bearer {token}
```

### ⚔️ 装备管理模块 (EquipmentController)

#### 装备物品
```http
POST /api/equipment/equip
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "itemId": "string",
  "slot": "MainHand" // MainHand, OffHand, Helmet, Armor等
}
```

#### 卸下装备
```http
POST /api/equipment/unequip
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "slot": "MainHand"
}
```

#### 获取装备信息
```http
GET /api/equipment/{characterId}
Authorization: Bearer {token}
```

### 🔨 生产制作模块 (ProductionController)

#### 开始制作
```http
POST /api/production/craft
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "recipeId": "string",
  "quantity": 1
}
```

#### 获取制作状态
```http
GET /api/production/status/{characterId}
Authorization: Bearer {token}
```

#### 学习配方
```http
POST /api/production/learn-recipe
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "recipeId": "string"
}
```

### 📜 任务系统模块 (QuestController)

#### 获取可接任务
```http
GET /api/quest/available/{characterId}
Authorization: Bearer {token}
```

#### 接受任务
```http
POST /api/quest/accept
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "questId": "string"
}
```

#### 完成任务
```http
POST /api/quest/complete
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "questId": "string"
}
```

#### 获取任务进度
```http
GET /api/quest/progress/{characterId}
Authorization: Bearer {token}
```

### 🛒 商店系统模块 (ShopController)

#### 获取商店物品
```http
GET /api/shop/{shopId}/items
Authorization: Bearer {token}
```

#### 购买物品
```http
POST /api/shop/buy
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "shopId": "string",
  "itemId": "string",
  "quantity": 1
}
```

#### 出售物品
```http
POST /api/shop/sell
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "shopId": "string",
  "itemId": "string",
  "quantity": 1
}
```

### 🏆 声望系统模块 (ReputationController)

#### 获取声望信息
```http
GET /api/reputation/{characterId}
Authorization: Bearer {token}
```

#### 更新声望
```http
POST /api/reputation/update
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "factionId": "string",
  "reputationChange": 100
}
```

### 💾 数据存储模块 (DataStorageController)

#### 保存游戏数据
```http
POST /api/datastorage/save
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "gameData": {
    "position": {"x": 100, "y": 200},
    "questProgress": {...},
    "settings": {...}
  }
}
```

#### 加载游戏数据
```http
GET /api/datastorage/load/{characterId}
Authorization: Bearer {token}
```

### 🌙 离线结算模块 (OfflineSettlementController)

#### 获取离线收益
```http
GET /api/offline/settlement/{characterId}
Authorization: Bearer {token}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "experienceGained": 1250,
    "goldGained": 500,
    "itemsGained": [
      {"itemId": "iron_ore", "quantity": 10}
    ],
    "offlineTime": "02:30:00",
    "activities": [
      {
        "activityType": "Mining",
        "duration": "02:30:00",
        "efficiency": 0.8
      }
    ]
  }
}
```

#### 确认离线结算
```http
POST /api/offline/confirm
Authorization: Bearer {token}
Content-Type: application/json

{
  "characterId": "string",
  "settlementId": "string"
}
```

### 📊 监控模块 (MonitoringController)

#### 系统健康状态
```http
GET /api/monitoring/health
Authorization: Bearer {token}
```

#### 性能指标
```http
GET /api/monitoring/metrics
Authorization: Bearer {token}
```

#### 活跃用户统计
```http
GET /api/monitoring/active-users
Authorization: Bearer {token}
```

### 📖 API文档模块 (ApiDocumentationController)

#### 获取API文档
```http
GET /api/documentation
```

## SignalR 实时通信系统

### GameHub 连接管理

SignalR提供双向实时通信，支持以下功能：

#### 客户端调用的方法

**加入战斗群组**
```javascript
connection.invoke("JoinBattle", battleId);
```

**离开战斗群组**
```javascript
connection.invoke("LeaveBattle", battleId);
```

**加入队伍群组**
```javascript
connection.invoke("JoinParty", partyId);
```

**离开队伍群组**
```javascript
connection.invoke("LeaveParty", partyId);
```

**订阅角色更新**
```javascript
connection.invoke("JoinCharacterUpdates", characterId);
```

**取消角色更新订阅**
```javascript
connection.invoke("LeaveCharacterUpdates", characterId);
```

#### 服务端推送的事件

**战斗状态更新**
```javascript
connection.on("BattleUpdate", function (battleState) {
    // 处理战斗状态更新
    console.log("Battle updated:", battleState);
});
```

**队伍状态更新**
```javascript
connection.on("PartyUpdate", function (partyState) {
    // 处理队伍状态更新
    console.log("Party updated:", partyState);
});
```

**角色状态更新**
```javascript
connection.on("CharacterUpdate", function (character) {
    // 处理角色状态更新
    console.log("Character updated:", character);
});
```

**系统通知**
```javascript
connection.on("Notification", function (notification) {
    // 处理系统通知
    console.log("Notification:", notification.message);
});
```

### 连接管理

**建立连接**
```javascript
const connection = new signalR.HubConnectionBuilder()
    .withUrl("/gamehub", {
        accessTokenFactory: () => localStorage.getItem("accessToken")
    })
    .withAutomaticReconnect()
    .build();

await connection.start();
```

**连接状态监听**
```javascript
connection.onclose(async () => {
    console.log("Connection closed");
    // 重连逻辑
});

connection.onreconnected(() => {
    console.log("Reconnected");
});
```

## 核心服务架构详解

### 🎮 游戏引擎服务 (GameEngineService)

**核心职责**：
- 战斗逻辑处理
- 游戏状态管理
- 事件触发和处理
- 实时状态同步

**关键特性**：
- 单例模式，全局唯一实例
- 线程安全的并发处理
- 基于事件驱动的架构
- 支持组队战斗

**主要方法**：
```csharp
public BattleStateDto StartBattle(StartBattleRequest request)
public BattleStateDto? GetBattleState(Guid battleId)
public bool ExecuteBattleAction(BattleActionRequest request)
public bool StopBattle(Guid battleId)
public void ProcessBattleTick(double deltaTime)
```

### ⏰ 游戏循环服务 (GameLoopService)

**核心职责**：
- 后台持续运行的游戏逻辑处理
- 定时更新游戏状态
- 战斗tick处理
- 客户端状态同步

**运行特性**：
- 后台服务（HostedService）
- 500ms执行间隔
- 异常恢复机制
- 性能监控

**处理流程**：
```csharp
// 每500ms执行一次
while (await timer.WaitForNextTickAsync(stoppingToken))
{
    var deltaTime = CalculateDeltaTime();
    _gameEngine.ProcessBattleTick(deltaTime);
    await NotifyClients();
}
```

### 🔄 统一事件服务 (UnifiedEventService)

**核心职责**：
- 游戏事件的队列管理
- 事件优先级处理
- 事件持久化
- 跨服务事件通信

**事件类型**：
- 战斗相关事件
- 角色状态变化事件  
- 队伍管理事件
- 系统通知事件

**事件处理流程**：
```csharp
// 事件入队
_eventService.EnqueueBattleEvent(GameEventTypes.BATTLE_STARTED, battleId, characterId);

// 事件处理
await _eventService.ProcessEvents();
```

### 🔧 服务定位器 (ServerServiceLocator)

**核心职责**：
- 全局服务实例管理
- 服务生命周期控制
- 依赖注入补充
- 静态服务访问

**使用模式**：
```csharp
// 初始化（在Program.cs中）
ServerServiceLocator.Initialize(app.Services);

// 获取服务实例
var gameEngine = ServerServiceLocator.GetService<GameEngineService>();
```

### 🔐 安全认证服务 (GameAuthenticationService)

**核心职责**：
- JWT令牌生成和验证
- 用户身份认证
- 令牌刷新管理
- 安全策略实施

**安全特性**：
- HMAC-SHA256签名算法
- 可配置的令牌过期时间
- 防重放攻击机制
- 安全的密钥管理

**令牌结构**：
```json
{
  "sub": "userId",
  "username": "playerName",
  "iat": 1640995200,
  "exp": 1640998800,
  "iss": "BlazorWebGame",
  "aud": "BlazorWebGame.Client"
}
```

### 💾 数据存储服务 (DataStorageService)

**核心职责**：
- 角色数据持久化
- 游戏进度保存
- 背包和装备管理
- 数据版本控制

**存储模式**：
- 开发环境：内存存储
- 生产环境：数据库存储（可配置）
- 异步操作支持
- 数据压缩和序列化

**数据结构**：
```csharp
public class GameData
{
    public string CharacterId { get; set; }
    public DateTime LastSaved { get; set; }
    public Dictionary<string, object> Properties { get; set; }
    public int Version { get; set; }
}
```

### 📈 性能监控服务 (PerformanceMonitoringService)

**核心职责**：
- 系统性能实时监控
- 内存使用统计
- API响应时间监控
- 错误率统计分析

**监控指标**：
- CPU使用率
- 内存使用量
- 活跃连接数
- 请求响应时间
- 错误发生率

**报告生成**：
```csharp
public class PerformanceReport
{
    public double CpuUsage { get; set; }
    public long MemoryUsage { get; set; }
    public int ActiveConnections { get; set; }
    public double AverageResponseTime { get; set; }
    public double ErrorRate { get; set; }
    public DateTime Timestamp { get; set; }
}
```

## 安全机制详解

### 🛡️ 身份认证系统

**JWT配置**：
```csharp
services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = "BlazorWebGame",
            ValidAudience = "BlazorWebGame.Client",
            IssuerSigningKey = new SymmetricSecurityKey(key),
            ClockSkew = TimeSpan.FromMinutes(1)
        };
    });
```

**SignalR认证**：
```csharp
// 支持通过查询参数传递Token
options.Events = new JwtBearerEvents
{
    OnMessageReceived = context =>
    {
        var accessToken = context.Request.Query["access_token"];
        var path = context.HttpContext.Request.Path;
        
        if (!string.IsNullOrEmpty(accessToken) && 
            path.StartsWithSegments("/gamehub"))
        {
            context.Token = accessToken;
        }
        return Task.CompletedTask;
    }
};
```

### 🔒 资源权限验证

**自定义验证属性**：
```csharp
[ValidateResourceOwnership("CharacterId", ResourceType.Character)]
[ValidateGameState(GameStateValidationType.BattleCanStart)]
public ActionResult<ApiResponse<BattleStateDto>> StartBattle(StartBattleRequest request)
```

**验证类型**：
- `ResourceType.Character`: 角色归属验证
- `ResourceType.Battle`: 战斗参与权验证
- `ResourceType.Party`: 队伍成员权限验证

**验证流程**：
1. 提取用户ID从JWT令牌
2. 检查资源归属关系
3. 验证操作权限
4. 记录安全事件日志

### 🚦 速率限制系统

**限制规则**：
```csharp
public class RateLimitOptions
{
    public RateLimitRule IpRateLimit { get; set; } = new()
    {
        MaxRequests = 100,
        TimeWindow = TimeSpan.FromMinutes(1)
    };
    
    public RateLimitRule UserRateLimit { get; set; } = new()
    {
        MaxRequests = 200,
        TimeWindow = TimeSpan.FromMinutes(1)
    };
}
```

**实现原理**：
- 滑动窗口算法
- 内存存储计数器
- IP和用户双重限制
- 超限自动阻断

### 🌐 CORS跨域配置

**安全策略**：
```csharp
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy.WithOrigins(allowedOrigins)  // 配置文件指定
              .AllowAnyHeader()
              .AllowAnyMethod()
              .AllowCredentials();            // 支持认证Cookie
    });
});
```

**配置要点**：
- 明确指定允许的来源域名
- 支持所有HTTP方法
- 允许所有请求头
- 启用凭据传递

### ⚠️ 错误处理机制

**全局异常处理**：
```csharp
public class ErrorHandlingMiddleware
{
    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        try
        {
            await next(context);
        }
        catch (Exception ex)
        {
            await HandleExceptionAsync(context, ex);
        }
    }
}
```

**错误响应格式**：
```json
{
  "success": false,
  "message": "User-friendly error message",
  "errors": ["Detailed error info"],
  "timestamp": "2024-01-01T00:00:00Z"
}
```

**安全考量**：
- 不泄露敏感信息
- 详细错误仅记录到日志
- 用户友好的错误消息
- 异常堆栈跟踪保护

## 数据传输对象 (DTOs) 详解

### 📊 统一响应格式

**ApiResponse<T>**：
```csharp
public class ApiResponse<T>
{
    public bool Success { get; set; }           // 操作是否成功
    public string Message { get; set; }         // 用户友好消息
    public T? Data { get; set; }               // 实际数据负载
    public List<string> Errors { get; set; }   // 错误详情列表
    public DateTime Timestamp { get; set; }    // 响应时间戳
}
```

### ⚔️ 战斗相关DTOs

**BattleStateDto - 战斗状态**：
```csharp
public class BattleStateDto
{
    public Guid BattleId { get; set; }              // 战斗唯一标识
    public string CharacterId { get; set; }         // 主角色ID
    public string EnemyId { get; set; }             // 敌人ID
    public string? PartyId { get; set; }            // 队伍ID（可选）
    public bool IsActive { get; set; }              // 战斗是否活跃
    public int PlayerHealth { get; set; }           // 玩家生命值
    public int PlayerMaxHealth { get; set; }        // 玩家最大生命值
    public int EnemyHealth { get; set; }            // 敌人生命值
    public int EnemyMaxHealth { get; set; }         // 敌人最大生命值
    public DateTime LastUpdated { get; set; }       // 最后更新时间
    public BattleType BattleType { get; set; }      // 战斗类型
    public List<string> PartyMemberIds { get; set; } // 队伍成员列表
    
    // 扩展战斗信息
    public List<BattleParticipantDto> Players { get; set; }     // 玩家参与者
    public List<BattleParticipantDto> Enemies { get; set; }     // 敌人参与者
    public BattleStatus Status { get; set; }                    // 战斗状态
    public Dictionary<string, string> PlayerTargets { get; set; } // 目标映射
    public List<BattleActionDto> RecentActions { get; set; }    // 最近动作
    public BattleResultDto? Result { get; set; }               // 战斗结果
}
```

**BattleParticipantDto - 战斗参与者**：
```csharp
public class BattleParticipantDto
{
    public string Id { get; set; }                    // 参与者ID
    public string Name { get; set; }                  // 显示名称
    public int Health { get; set; }                   // 当前生命值
    public int MaxHealth { get; set; }                // 最大生命值
    public int AttackPower { get; set; }              // 攻击力
    public double AttacksPerSecond { get; set; }      // 攻击速度
    public double AttackCooldown { get; set; }        // 攻击冷却时间
    public List<string> EquippedSkills { get; set; }  // 装备的技能
    public Dictionary<string, double> SkillCooldowns { get; set; } // 技能冷却
    public bool IsPlayer { get; set; }                // 是否为玩家
}
```

### 👤 角色相关DTOs

**CharacterDto - 角色信息**：
```csharp
public class CharacterDto
{
    public string Id { get; set; }                    // 角色ID
    public string Name { get; set; }                  // 角色名称
    public string UserId { get; set; }                // 所属用户ID
    public CharacterClass Class { get; set; }         // 角色职业
    public int Level { get; set; }                    // 等级
    public long Experience { get; set; }              // 经验值
    public CharacterStats Stats { get; set; }         // 属性统计
    public EquipmentSetDto Equipment { get; set; }    // 装备信息
    public InventoryDto Inventory { get; set; }       // 背包信息
    public List<string> LearnedSkills { get; set; }   // 已学技能
    public Dictionary<string, int> Reputation { get; set; } // 声望值
    public Vector3 Position { get; set; }             // 位置坐标
    public DateTime LastLogin { get; set; }           // 最后登录时间
    public DateTime CreatedAt { get; set; }           // 创建时间
}
```

### 👥 队伍相关DTOs

**PartyDto - 队伍信息**：
```csharp
public class PartyDto
{
    public string Id { get; set; }                    // 队伍ID
    public string Name { get; set; }                  // 队伍名称
    public string LeaderId { get; set; }              // 队长ID
    public List<PartyMemberDto> Members { get; set; } // 队伍成员
    public int MaxMembers { get; set; }               // 最大成员数
    public bool IsPublic { get; set; }                // 是否公开
    public string Description { get; set; }           // 队伍描述
    public PartyStatus Status { get; set; }           // 队伍状态
    public DateTime CreatedAt { get; set; }           // 创建时间
}
```

### 🎒 背包相关DTOs

**InventoryDto - 背包信息**：
```csharp
public class InventoryDto
{
    public string CharacterId { get; set; }           // 角色ID
    public List<ItemStackDto> Items { get; set; }     // 物品堆栈
    public int Capacity { get; set; }                 // 背包容量
    public int UsedSlots { get; set; }                // 已使用槽位
    public Dictionary<string, int> ItemCounts { get; set; } // 物品数量统计
}
```

**ItemStackDto - 物品堆栈**：
```csharp
public class ItemStackDto
{
    public string ItemId { get; set; }                // 物品ID
    public string Name { get; set; }                  // 物品名称
    public int Quantity { get; set; }                 // 数量
    public ItemRarity Rarity { get; set; }            // 稀有度
    public ItemType Type { get; set; }                // 物品类型
    public string Description { get; set; }           // 物品描述
    public Dictionary<string, object> Properties { get; set; } // 物品属性
    public bool IsStackable { get; set; }             // 是否可堆叠
    public int SlotPosition { get; set; }             // 槽位位置
}
```

## 配置系统详解

### ⚙️ 配置选项类

**GameServerOptions - 游戏服务器配置**：
```csharp
public class GameServerOptions
{
    public const string SectionName = "GameServer";
    
    [Required]
    public string ServerName { get; set; } = "BlazorWebGame Server";
    
    [Range(1, 65535)]
    public int Port { get; set; } = 5000;
    
    public bool EnableDevelopmentTests { get; set; } = false;
    
    [Range(100, 5000)]
    public int GameLoopIntervalMs { get; set; } = 500;
    
    public bool EnablePerformanceMonitoring { get; set; } = true;
    
    [Range(1, 1000)]
    public int MaxConcurrentBattles { get; set; } = 100;
}
```

**SecurityOptions - 安全配置**：
```csharp
public class SecurityOptions
{
    public const string SectionName = "Security";
    
    public JwtOptions Jwt { get; set; } = new();
    public CorsOptions Cors { get; set; } = new();
    public RateLimitOptions RateLimit { get; set; } = new();
    
    public class JwtOptions
    {
        [Required]
        public string Key { get; set; } = string.Empty;
        
        [Required]
        public string Issuer { get; set; } = "BlazorWebGame";
        
        [Required]
        public string Audience { get; set; } = "BlazorWebGame.Client";
        
        [Range(1, 1440)]
        public int ExpirationMinutes { get; set; } = 15;
        
        [Range(1, 43200)]
        public int RefreshTokenExpirationMinutes { get; set; } = 10080; // 7 days
    }
}
```

**MonitoringOptions - 监控配置**：
```csharp
public class MonitoringOptions
{
    public const string SectionName = "Monitoring";
    
    public bool EnableHealthChecks { get; set; } = true;
    public bool EnableMetricsCollection { get; set; } = true;
    public bool EnablePerformanceCounters { get; set; } = true;
    
    [Range(1, 300)]
    public int HealthCheckIntervalSeconds { get; set; } = 30;
    
    [Range(1, 3600)]
    public int MetricsCollectionIntervalSeconds { get; set; } = 60;
    
    public List<string> AlertEmailAddresses { get; set; } = new();
}
```

### 📝 配置文件示例

**appsettings.json**：
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "BlazorWebGame": "Debug"
    }
  },
  
  "GameServer": {
    "ServerName": "BlazorWebGame Development Server",
    "Port": 5000,
    "EnableDevelopmentTests": true,
    "GameLoopIntervalMs": 500,
    "EnablePerformanceMonitoring": true,
    "MaxConcurrentBattles": 50
  },
  
  "Security": {
    "Jwt": {
      "Key": "your-super-secret-jwt-key-here-must-be-at-least-32-characters",
      "Issuer": "BlazorWebGame",
      "Audience": "BlazorWebGame.Client",
      "ExpirationMinutes": 15,
      "RefreshTokenExpirationMinutes": 10080
    },
    "Cors": {
      "AllowedOrigins": [
        "https://localhost:7051",
        "http://localhost:5190"
      ]
    },
    "RateLimit": {
      "IpRateLimit": {
        "MaxRequests": 100,
        "TimeWindowMinutes": 1
      },
      "UserRateLimit": {
        "MaxRequests": 200,
        "TimeWindowMinutes": 1
      }
    }
  },
  
  "Monitoring": {
    "EnableHealthChecks": true,
    "EnableMetricsCollection": true,
    "EnablePerformanceCounters": true,
    "HealthCheckIntervalSeconds": 30,
    "MetricsCollectionIntervalSeconds": 60,
    "AlertEmailAddresses": [
      "admin@blazorwebgame.com"
    ]
  },
  
  "Serilog": {
    "Using": ["Serilog.Sinks.Console", "Serilog.Sinks.File"],
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "Console",
        "Args": {
          "outputTemplate": "[{Timestamp:HH:mm:ss} {Level:u3}] [{SourceContext}] {Message:lj}{NewLine}{Exception}"
        }
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/blazorwebgame-.log",
          "rollingInterval": "Day",
          "outputTemplate": "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} {Level:u3}] [{SourceContext}] {Message:lj}{NewLine}{Exception}"
        }
      }
    ]
  }
}
```

### 🔧 配置验证

**启动时验证**：
```csharp
// 绑定配置并验证
builder.Services.AddOptions<GameServerOptions>()
    .Bind(builder.Configuration.GetSection(GameServerOptions.SectionName))
    .ValidateDataAnnotations()        // 验证数据注解
    .ValidateOnStart();              // 启动时验证

// 自定义验证
builder.Services.AddOptions<SecurityOptions>()
    .Bind(builder.Configuration.GetSection(SecurityOptions.SectionName))
    .Validate(options => 
    {
        // 自定义验证逻辑
        return options.Jwt.Key.Length >= 32;
    }, "JWT Key must be at least 32 characters long")
    .ValidateOnStart();
```

## 健康检查系统

### 🏥 健康检查配置

**注册健康检查**：
```csharp
builder.Services.AddHealthChecks()
    .AddCheck<GameHealthCheckService>("game-health")
    .AddDbContextCheck<GameDbContext>()      // 数据库检查（如果配置）
    .AddRedisCheck("redis-connection");      // Redis检查（如果配置）
```

**自定义健康检查**：
```csharp
public class GameHealthCheckService : IHealthCheck
{
    private readonly GameEngineService _gameEngine;
    private readonly PerformanceMonitoringService _performanceService;

    public async Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var activeBattles = _gameEngine.GetActiveBattleCount();
            var memoryUsage = _performanceService.GetMemoryUsage();
            var uptime = _performanceService.GetUptime();

            var data = new Dictionary<string, object>
            {
                ["active_battles"] = activeBattles,
                ["memory_usage_mb"] = memoryUsage / 1024 / 1024,
                ["uptime"] = uptime.ToString(@"dd\.hh\:mm\:ss"),
                ["status"] = "All systems operational"
            };

            // 健康状态判断
            if (activeBattles > 90 || memoryUsage > 1000 * 1024 * 1024) // 90场战斗或1GB内存
            {
                return HealthCheckResult.Degraded("System under high load", null, data);
            }

            return HealthCheckResult.Healthy("Game engine is running normally", data);
        }
        catch (Exception ex)
        {
            return HealthCheckResult.Unhealthy("Game engine error", ex);
        }
    }
}
```

### 📊 健康检查端点

**详细健康报告** - `/health`:
```json
{
  "Status": "Healthy",
  "Checks": [
    {
      "Name": "game-health",
      "Status": "Healthy",
      "Description": "Game engine is running normally",
      "Data": {
        "active_battles": 15,
        "memory_usage_mb": 256,
        "uptime": "01.05:30:45",
        "status": "All systems operational"
      }
    }
  ],
  "Duration": 125.7
}
```

**简单健康状态** - `/health/simple`:
```json
{
  "Status": "Healthy",
  "Timestamp": "2024-01-01T12:00:00Z",
  "Environment": "Development"
}
```

**API信息** - `/api/info`:
```json
{
  "Name": "BlazorWebGame Server API",
  "Version": "1.0.0",
  "Environment": "Development",
  "Timestamp": "2024-01-01T12:00:00Z"
}
```

## 日志系统详解

### 📝 日志配置

**Serilog配置**：
```csharp
Log.Logger = new LoggerConfiguration()
    .ReadFrom.Configuration(builder.Configuration)
    .Enrich.FromLogContext()
    .WriteTo.Console(outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] [{SourceContext}] {Message:lj}{NewLine}{Exception}")
    .WriteTo.File("logs/blazorwebgame-.log", 
        rollingInterval: RollingInterval.Day,
        outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} {Level:u3}] [{SourceContext}] {Message:lj}{NewLine}{Exception}")
    .CreateLogger();
```

### 📊 日志级别和内容

**Debug级别** - 调试信息：
```csharp
_logger.LogDebug("Battle action executed for user {UserId} in battle {BattleId}", userId, battleId);
```

**Information级别** - 一般信息：
```csharp
_logger.LogInformation("Battle {BattleId} started by user {UserId}", battleId, userId);
```

**Warning级别** - 警告信息：
```csharp
_logger.LogWarning("Invalid battle start request from user {UserId}: missing required fields", userId);
```

**Error级别** - 错误信息：
```csharp
_logger.LogError(ex, "Error starting battle for user {UserId}", userId);
```

**Fatal级别** - 致命错误：
```csharp
Log.Fatal(ex, "Application terminated unexpectedly");
```

### 🔍 结构化日志

**安全事件日志**：
```csharp
_logger.LogWarning("Unauthorized access attempt: User {UserId} tried to access character {CharacterId} from IP {ClientIp}", 
    userId, characterId, clientIp);
```

**性能监控日志**：
```csharp
_logger.LogInformation("Performance metrics: CPU {CpuUsage}%, Memory {MemoryUsage}MB, Active battles {ActiveBattles}", 
    cpuUsage, memoryUsage, activeBattles);
```

**业务流程日志**：
```csharp
_logger.LogInformation("Character {CharacterId} leveled up from {OldLevel} to {NewLevel}, gained {ExperienceGained} XP", 
    characterId, oldLevel, newLevel, experienceGained);
```

## 开发工具和调试

### 🔧 Swagger/OpenAPI文档

**配置**：
```csharp
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "BlazorWebGame API V1");
        c.RoutePrefix = "swagger";
        c.DefaultModelExpandDepth(2);
        c.DefaultModelRendering(ModelRendering.Model);
        c.DocExpansion(DocExpansion.List);
        c.EnableDeepLinking();
        c.DisplayOperationId();
    });
}
```

**访问地址**：
- Swagger UI: `https://localhost:5001/swagger`
- OpenAPI规范: `https://localhost:5001/swagger/v1/swagger.json`

### 🧪 开发环境测试

**自动化测试**：
```csharp
if (app.Environment.IsDevelopment() && gameServerOptions.EnableDevelopmentTests)
{
    // 战斗系统测试
    TestBattleSystem.RunBattleTest(app.Services, logger);
    
    // 队伍系统测试
    TestPartySystem.RunPartyTest(logger);
    
    // 事件系统测试
    UnifiedEventSystemTest.RunEventSystemTest(app.Services, logger);
    UnifiedEventSystemTest.RunPerformanceBenchmark(logger);
}
```

**测试内容**：
- 战斗系统完整流程测试
- 队伍创建和管理测试
- 事件系统性能基准测试
- SignalR连接和消息传递测试

### 🔍 调试功能

**详细异常信息**：
```csharp
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
}
```

**请求响应日志**：
```csharp
public class RequestLoggingMiddleware
{
    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        var stopwatch = Stopwatch.StartNew();
        
        _logger.LogInformation("Request {Method} {Path} started", 
            context.Request.Method, context.Request.Path);
        
        await next(context);
        
        stopwatch.Stop();
        _logger.LogInformation("Request {Method} {Path} completed in {ElapsedMilliseconds}ms with status {StatusCode}", 
            context.Request.Method, context.Request.Path, stopwatch.ElapsedMilliseconds, context.Response.StatusCode);
    }
}
```

## 部署和运维

### 🚀 部署配置

**生产环境配置**：
```json
{
  "GameServer": {
    "EnableDevelopmentTests": false,
    "EnablePerformanceMonitoring": true,
    "MaxConcurrentBattles": 200
  },
  "Security": {
    "Jwt": {
      "ExpirationMinutes": 60,
      "RefreshTokenExpirationMinutes": 43200
    },
    "RateLimit": {
      "IpRateLimit": {
        "MaxRequests": 1000,
        "TimeWindowMinutes": 1
      }
    }
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Warning"
    }
  }
}
```

### 📊 监控指标

**关键性能指标**：
- **响应时间**: API平均响应时间 < 200ms
- **吞吐量**: 每秒处理请求数 > 100 RPS
- **错误率**: 错误率 < 1%
- **内存使用**: 内存使用率 < 80%
- **活跃连接**: SignalR连接数监控

**业务指标**：
- 活跃用户数
- 并发战斗数
- 平均战斗时长
- 用户留存率

### 🔄 扩展性考虑

**水平扩展**：
- 无状态API设计
- 外部状态存储（Redis）
- 负载均衡支持
- 容器化部署

**垂直扩展**：
- 资源监控和自动扩容
- 数据库连接池优化
- 内存使用优化
- CPU使用效率提升

---

## 总结

BlazorWebGame服务端是一个功能完备、架构先进的Web游戏后端系统，具备以下核心优势：

### ✅ 技术优势
1. **现代化架构**: 基于.NET 8.0和ASP.NET Core的最新技术栈
2. **实时通信**: SignalR提供低延迟的双向通信能力
3. **安全保障**: 完善的JWT认证、权限验证和速率限制机制
4. **高可观测性**: 详细的日志记录、健康检查和性能监控
5. **开发友好**: 完整的API文档、自动化测试和调试工具

### ✅ 功能完整性
- **用户管理**: 注册、登录、角色管理
- **游戏核心**: 战斗系统、队伍管理、技能系统
- **内容系统**: 任务、商店、声望、制作系统
- **数据管理**: 背包、装备、数据存储、离线结算
- **运维支持**: 监控、健康检查、性能分析

### ✅ 架构特点
- **模块化设计**: 清晰的功能边界和职责分离
- **事件驱动**: 统一的事件系统支持复杂业务流程
- **可配置**: 灵活的配置系统适应不同部署环境
- **可扩展**: 支持水平和垂直扩展的架构设计

该服务端架构为Web游戏提供了坚实的技术基础，能够支持大规模、高并发的游戏运营需求。