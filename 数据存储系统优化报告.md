# æ•°æ®å­˜å‚¨ç³»ç»Ÿæœªæ¥ä¼˜åŒ–æŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘ŠåŸºäºå¯¹BlazorWebGameé¡¹ç›®æ•°æ®å­˜å‚¨ç³»ç»Ÿçš„æ·±å…¥åˆ†æï¼Œç¡®è®¤äº†å·¥å‚æ¨¡å¼çš„æ­£ç¡®å®ç°ï¼ŒéªŒè¯äº†SqliteDataStorageServiceçš„å®Œæ•´åŠŸèƒ½ï¼Œå¹¶æˆåŠŸç§»é™¤äº†ä¸å®Œæ•´çš„SimpleSqliteDataStorageServiceã€‚

## å½“å‰çŠ¶æ€è¯„ä¼°

### âœ… å·²å®Œæˆä¼˜åŒ–
1. **å·¥å‚æ¨¡å¼å®ç°å®Œæ•´** - DataStorageServiceFactoryæä¾›äº†å®Œæ•´çš„æŠ½è±¡å·¥å‚å®ç°
2. **SqliteDataStorageServiceåŠŸèƒ½å®Œæ•´** - å®ç°äº†IDataStorageServiceæ¥å£çš„æ‰€æœ‰43ä¸ªæ–¹æ³•
3. **ä»£ç æ¸…ç†å®Œæˆ** - å·²ç§»é™¤SimpleSqliteDataStorageServiceåŠç›¸å…³å¼•ç”¨

### ğŸ“Š ç³»ç»Ÿæ¶æ„åˆ†æ

#### æ•°æ®å­˜å‚¨å±‚æ¶æ„
```
IDataStorageService (æ¥å£å±‚)
â”œâ”€â”€ DataStorageService (å†…å­˜å®ç°)
â”œâ”€â”€ SqliteDataStorageService (SQLiteå®ç°) âœ… å®Œæ•´
â””â”€â”€ [Future] SqlServerDataStorageService (SQL Serverå®ç°)

IDataStorageServiceFactory (å·¥å‚æ¥å£) âœ… å®Œæ•´
â””â”€â”€ DataStorageServiceFactory (å…·ä½“å·¥å‚) âœ… å®Œæ•´
```

#### æ”¯æŒçš„æ•°æ®å®ä½“
- **PlayerEntity** - ç©å®¶æ•°æ® (å±æ€§ã€è£…å¤‡ã€æŠ€èƒ½ç­‰)
- **TeamEntity** - é˜Ÿä¼æ•°æ® (æˆå‘˜ã€çŠ¶æ€ç­‰)
- **ActionTargetEntity** - åŠ¨ä½œç›®æ ‡ (ä»»åŠ¡ã€è¿›åº¦ç­‰)
- **BattleRecordEntity** - æˆ˜æ–—è®°å½• (å†å²ã€ç»“æœç­‰)
- **OfflineDataEntity** - ç¦»çº¿æ•°æ® (åŒæ­¥ã€ç‰ˆæœ¬ç­‰)

## æœªæ¥ä¼˜åŒ–å»ºè®®

### ğŸš€ é«˜ä¼˜å…ˆçº§ä¼˜åŒ– (1-2ä¸ªæœˆ)

#### 1. æ€§èƒ½ä¼˜åŒ–
**1.1 æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–**
```csharp
// å»ºè®®å®ç°è¿æ¥æ± ç®¡ç†
public class OptimizedDbContextFactory : IDataStorageContextFactory
{
    private readonly DbContextOptions<GameDbContext> _options;
    private readonly SemaphoreSlim _connectionSemaphore;
    
    public OptimizedDbContextFactory(int maxConnections = 10)
    {
        _connectionSemaphore = new SemaphoreSlim(maxConnections);
    }
}
```

**1.2 æ‰¹é‡æ“ä½œä¼˜åŒ–**
- å½“å‰çš„SavePlayersAsyncå·²å®ç°ï¼Œä½†éœ€è¦æ‰©å±•åˆ°å…¶ä»–å®ä½“
- å»ºè®®æ·»åŠ æ‰¹é‡åˆ é™¤ã€æ‰¹é‡æ›´æ–°åŠŸèƒ½
- å®ç°äº‹åŠ¡çº§åˆ«çš„æ‰¹é‡æ“ä½œ

**1.3 æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–**
```csharp
// å»ºè®®æ·»åŠ ç´¢å¼•ä¼˜åŒ–å’ŒæŸ¥è¯¢ç¼“å­˜
public class CachedDataStorageService : IDataStorageService
{
    private readonly IMemoryCache _cache;
    private readonly IDataStorageService _baseService;
    
    // å®ç°æ™ºèƒ½ç¼“å­˜å±‚
}
```

#### 2. å¯æ‰©å±•æ€§å¢å¼º
**2.1 æ”¯æŒæ›´å¤šå­˜å‚¨åç«¯**
```csharp
// æ‰©å±•å·¥å‚ä»¥æ”¯æŒæ›´å¤šå­˜å‚¨ç±»å‹
private static readonly HashSet<string> SupportedStorageTypes = new()
{
    "Memory",
    "SQLite",
    "SqlServer",    // æ–°å¢
    "PostgreSQL",   // æ–°å¢
    "MongoDB",      // æ–°å¢
    "Redis"         // æ–°å¢ (ä½œä¸ºç¼“å­˜å±‚)
};
```

**2.2 åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨**
- å®ç°æ•°æ®åˆ†ç‰‡ç­–ç•¥
- æ”¯æŒè¯»å†™åˆ†ç¦»
- æ·»åŠ æ•°æ®åŒæ­¥æœºåˆ¶

#### 3. æ•°æ®å®Œæ•´æ€§å’Œå®‰å…¨æ€§
**3.1 æ•°æ®éªŒè¯å¢å¼º**
```csharp
public class ValidatedDataStorageService : IDataStorageService
{
    private readonly IDataValidator _validator;
    
    public async Task<ApiResponse<PlayerStorageDto>> SavePlayerAsync(PlayerStorageDto player)
    {
        var validation = await _validator.ValidateAsync(player);
        if (!validation.IsValid)
            return ApiResponse<PlayerStorageDto>.Failed(validation.Errors);
            
        // ç»§ç»­ä¿å­˜é€»è¾‘
    }
}
```

**3.2 æ•°æ®åŠ å¯†**
- æ•æ„Ÿæ•°æ®å­—æ®µåŠ å¯† (ç©å®¶ä¸ªäººä¿¡æ¯ç­‰)
- ä¼ è¾“å±‚å®‰å…¨å¢å¼º
- å®¡è®¡æ—¥å¿—å®ç°

### ğŸ”§ ä¸­ä¼˜å…ˆçº§ä¼˜åŒ– (2-4ä¸ªæœˆ)

#### 4. ç›‘æ§å’Œè¯Šæ–­
**4.1 æ€§èƒ½ç›‘æ§**
```csharp
public class MonitoredDataStorageService : IDataStorageService
{
    private readonly IMetricsCollector _metrics;
    
    public async Task<PlayerStorageDto?> GetPlayerAsync(string playerId)
    {
        using var timer = _metrics.StartTimer("GetPlayer");
        try
        {
            var result = await _baseService.GetPlayerAsync(playerId);
            _metrics.IncrementCounter("GetPlayer.Success");
            return result;
        }
        catch (Exception ex)
        {
            _metrics.IncrementCounter("GetPlayer.Error");
            throw;
        }
    }
}
```

**4.2 å¥åº·æ£€æŸ¥å¢å¼º**
- æ•°æ®åº“è¿æ¥çŠ¶æ€ç›‘æ§
- æŸ¥è¯¢æ€§èƒ½ç›‘æ§
- å­˜å‚¨ç©ºé—´ç›‘æ§
- æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

#### 5. æ•°æ®è¿ç§»å’Œå¤‡ä»½
**5.1 è‡ªåŠ¨è¿ç§»ç³»ç»Ÿ**
```csharp
public interface IDataMigrationService
{
    Task<bool> MigrateAsync(string fromStorage, string toStorage);
    Task<bool> VerifyMigrationAsync(string storageType);
    Task<BackupResult> CreateBackupAsync(BackupOptions options);
}
```

**5.2 å¢é‡å¤‡ä»½**
- åŸºäºæ—¶é—´æˆ³çš„å¢é‡å¤‡ä»½
- æ•°æ®å‹ç¼©å’Œä¼˜åŒ–
- äº‘å­˜å‚¨é›†æˆ

#### 6. APIå’Œæ¥å£ä¼˜åŒ–
**6.1 GraphQLé›†æˆ**
```csharp
// è€ƒè™‘ä¸ºå¤æ‚æŸ¥è¯¢æ·»åŠ GraphQLæ”¯æŒ
public class GraphQLDataStorageResolver
{
    [UseDbContext(typeof(GameDbContext))]
    public IQueryable<PlayerEntity> GetPlayers([ScopedService] GameDbContext context)
        => context.Players;
}
```

**6.2 REST APIå¢å¼º**
- æ·»åŠ åˆ†é¡µæ”¯æŒ
- å®ç°å­—æ®µé€‰æ‹©å™¨
- æ”¯æŒå¤æ‚è¿‡æ»¤æ¡ä»¶

### ğŸ“‹ ä½ä¼˜å…ˆçº§ä¼˜åŒ– (4-6ä¸ªæœˆ)

#### 7. é«˜çº§åŠŸèƒ½
**7.1 äº‹ä»¶æº¯æº (Event Sourcing)**
```csharp
public interface IEventStore
{
    Task<bool> AppendEventsAsync(string streamId, IEnumerable<DomainEvent> events);
    Task<IEnumerable<DomainEvent>> GetEventsAsync(string streamId, int fromVersion = 0);
}
```

**7.2 CQRSå®ç°**
- å‘½ä»¤æŸ¥è¯¢è´£ä»»åˆ†ç¦»
- è¯»å†™æ¨¡å‹åˆ†ç¦»
- äº‹ä»¶é©±åŠ¨æ¶æ„

**7.3 å¤šç§Ÿæˆ·æ”¯æŒ**
- æ•°æ®éš”ç¦»
- ç§Ÿæˆ·é…ç½®ç®¡ç†
- åŠ¨æ€æ•°æ®åº“é€‰æ‹©

#### 8. äº‘åŸç”Ÿä¼˜åŒ–
**8.1 å®¹å™¨åŒ–ä¼˜åŒ–**
```dockerfile
# æ•°æ®å­˜å‚¨æœåŠ¡å®¹å™¨ä¼˜åŒ–
FROM mcr.microsoft.com/dotnet/aspnet:8.0-alpine
# æ·»åŠ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s \
  CMD curl -f http://localhost/health/storage || exit 1
```

**8.2 å¾®æœåŠ¡æ¶æ„**
- æ•°æ®å­˜å‚¨æœåŠ¡ç‹¬ç«‹éƒ¨ç½²
- æœåŠ¡å‘ç°é›†æˆ
- é…ç½®å¤–éƒ¨åŒ–

## å®æ–½è·¯çº¿å›¾

### ç¬¬ä¸€é˜¶æ®µ (1-2ä¸ªæœˆ) - æ€§èƒ½å’Œç¨³å®šæ€§
1. å®ç°è¿æ¥æ± ç®¡ç† (2å‘¨)
2. æ·»åŠ æŸ¥è¯¢ç¼“å­˜ (2å‘¨)
3. å¢å¼ºé”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ (1å‘¨)
4. å®ç°æ€§èƒ½ç›‘æ§ (2å‘¨)
5. æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯• (1å‘¨)

### ç¬¬äºŒé˜¶æ®µ (2-4ä¸ªæœˆ) - åŠŸèƒ½æ‰©å±•
1. æ”¯æŒSQL Serveråç«¯ (3å‘¨)
2. å®ç°æ•°æ®è¿ç§»å·¥å…· (2å‘¨)
3. æ·»åŠ å¤‡ä»½å’Œæ¢å¤åŠŸèƒ½ (3å‘¨)
4. å®ç°æ•°æ®éªŒè¯æ¡†æ¶ (2å‘¨)

### ç¬¬ä¸‰é˜¶æ®µ (4-6ä¸ªæœˆ) - é«˜çº§åŠŸèƒ½
1. äº‹ä»¶æº¯æºå®ç° (4å‘¨)
2. CQRSæ¶æ„æ”¹é€  (4å‘¨)
3. åˆ†å¸ƒå¼å­˜å‚¨æ”¯æŒ (4å‘¨)
4. äº‘åŸç”Ÿä¼˜åŒ– (4å‘¨)

## æŠ€æœ¯å€ºåŠ¡æ¸…ç†

### å½“å‰è­¦å‘Šå¤„ç†
é¡¹ç›®æ„å»ºæ—¶æœ‰205ä¸ªè­¦å‘Šï¼Œä¸»è¦é›†ä¸­åœ¨ï¼š
1. **å¼‚æ­¥æ–¹æ³•è­¦å‘Š** - å¤§é‡asyncæ–¹æ³•ç¼ºå°‘awaitæ“ä½œç¬¦
2. **ç©ºå¼•ç”¨è­¦å‘Š** - éœ€è¦æ”¹è¿›nullableå¼•ç”¨ç±»å‹ä½¿ç”¨
3. **æœªä½¿ç”¨å­—æ®µè­¦å‘Š** - æ¸…ç†æœªä½¿ç”¨çš„ç§æœ‰å­—æ®µ

### å»ºè®®çš„æ¸…ç†é¡ºåº
1. ä¿®å¤é«˜é¢‘async/awaitè­¦å‘Š (1å‘¨)
2. æ”¹è¿›nullableå¼•ç”¨ç±»å‹æ³¨è§£ (1å‘¨)
3. æ¸…ç†æœªä½¿ç”¨ä»£ç  (0.5å‘¨)

## é¢„æœŸæ”¶ç›Š

### æ€§èƒ½æå‡
- **æŸ¥è¯¢æ€§èƒ½**: é¢„æœŸæå‡50-80% (é€šè¿‡ç¼“å­˜å’Œç´¢å¼•ä¼˜åŒ–)
- **å¹¶å‘èƒ½åŠ›**: é¢„æœŸæå‡3-5å€ (é€šè¿‡è¿æ¥æ± å’Œå¼‚æ­¥ä¼˜åŒ–)
- **å†…å­˜ä½¿ç”¨**: é¢„æœŸå‡å°‘20-30% (é€šè¿‡å¯¹è±¡æ± å’Œç¼“å­˜ä¼˜åŒ–)

### å¼€å‘æ•ˆç‡
- **ç»´æŠ¤æˆæœ¬**: é¢„æœŸå‡å°‘40% (é€šè¿‡ä»£ç è§„èŒƒåŒ–å’Œè‡ªåŠ¨åŒ–æµ‹è¯•)
- **æ–°åŠŸèƒ½å¼€å‘**: é¢„æœŸåŠ é€Ÿ50% (é€šè¿‡å®Œå–„çš„æŠ½è±¡å±‚)
- **é—®é¢˜è¯Šæ–­**: é¢„æœŸæå‡70% (é€šè¿‡ç›‘æ§å’Œæ—¥å¿—æ”¹è¿›)

### ç³»ç»Ÿå¯é æ€§
- **æ•…éšœæ¢å¤**: è‡ªåŠ¨é‡è¯•å’Œé™çº§æœºåˆ¶
- **æ•°æ®ä¸€è‡´æ€§**: äº‹åŠ¡å’ŒéªŒè¯æœºåˆ¶å¢å¼º
- **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•å’Œè´Ÿè½½å‡è¡¡

## ç»“è®º

BlazorWebGameçš„æ•°æ®å­˜å‚¨ç³»ç»Ÿå·²ç»å…·å¤‡äº†å®Œæ•´çš„åŸºç¡€æ¶æ„ï¼Œå·¥å‚æ¨¡å¼å®ç°æ­£ç¡®ï¼ŒSqliteDataStorageServiceåŠŸèƒ½å®Œæ•´ã€‚é€šè¿‡æœ¬æŠ¥å‘Šæå‡ºçš„ä¼˜åŒ–å»ºè®®ï¼Œç³»ç»Ÿå°†èƒ½å¤Ÿæ”¯æŒæ›´å¤§è§„æ¨¡çš„ç”¨æˆ·é‡ï¼Œæä¾›æ›´å¥½çš„æ€§èƒ½å’Œå¯é æ€§ã€‚

å»ºè®®æŒ‰ç…§æå‡ºçš„ä¸‰é˜¶æ®µè·¯çº¿å›¾é€æ­¥å®æ–½ä¼˜åŒ–ï¼Œä¼˜å…ˆå¤„ç†æ€§èƒ½å’Œç¨³å®šæ€§é—®é¢˜ï¼Œç„¶åæ‰©å±•åŠŸèƒ½ï¼Œæœ€åå®æ–½é«˜çº§æ¶æ„æ”¹é€ ã€‚

---
*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2024å¹´12æœˆ*
*åˆ†æèŒƒå›´: BlazorWebGameæ•°æ®å­˜å‚¨ç³»ç»Ÿ*
*ç‰ˆæœ¬: v1.0*