@using BlazorWebGame.Models
@using BlazorWebGame.Models.Items
@using BlazorWebGame.Services
@using BlazorWebGame.Events
@inject GameStateService GameState
@implements IDisposable

@if (GameState.AllCharacters.Any())
{
    <div class="multi-character-status-container">
        @foreach (var character in GameState.AllCharacters)
        {
            <div class="character-status-row @(character.IsDead ? "player-dead" : "") @(GameState.ActiveCharacter?.Id == character.Id ? "active" : "")">

                <div class="status-display" @onclick="() => SwitchCharacter(character.Id)">
                    <div class="status-left">
                        <span>
                            <strong>@character.Name</strong> (Lv. @character.GetLevel(character.SelectedBattleProfession))
                            - 状态: <strong>@character.CurrentAction.ToString()</strong>
                            | 生命: <strong>@character.Health / @character.MaxHealth</strong>
                            | 金币: <strong>@character.Gold</strong>
                        </span>
                        
                        <!-- 添加经验值进度条 -->
                        @if (GameState.ActiveCharacter?.Id == character.Id)
                        {
                            var currentProfession = character.SelectedBattleProfession;
                            var professionName = currentProfession.ToString();
                            var level = character.GetLevel(currentProfession);
                            var progressPercent = character.GetLevelProgress(currentProfession);
                            var currentExp = character.BattleProfessionXP.GetValueOrDefault(currentProfession, 0);
                            var nextLevelExp = ExpSystem.GetExpRequiredForLevel(level + 1);
                            var currentLevelExp = ExpSystem.GetExpRequiredForLevel(level);
                            var expToNextLevel = nextLevelExp - currentExp;
                            
                            <div class="profession-exp-display">
                                <div class="profession-info">
                                    <span class="profession-name">@professionName</span>
                                    <span class="profession-level">Lv.@level</span>
                                </div>
                                
                                <div class="exp-progress-container">
                                    <div class="exp-progress-bar" style="width: @progressPercent%"></div>
                                    <span class="exp-text">经验: @(currentExp - currentLevelExp)/@(nextLevelExp - currentLevelExp)</span>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="status-right">
                        @foreach (var buff in character.ActiveBuffs.OrderBy(b => b.SourceItemId))
                        {
                            var buffItem = ItemData.GetItemById(buff.SourceItemId);
                            if (buffItem != null)
                            {
                                <div class="buff-icon" title="@buffItem.Name (+@buff.BuffValue @buff.BuffType.ToString())">
                                    <span class="buff-icon-text">@buffItem.Name.Substring(0, 1)</span>
                                    <span class="buff-timer">@((int)buff.TimeRemainingSeconds)</span>
                                </div>
                            }
                        }
                    </div>
                </div>

            </div>
        }
    </div>
}
else
{
    <div class="multi-character-status-container">
        <p>正在加载角色...</p>
    </div>
}

@code {
    protected override void OnInitialized()
    {
        GameState.OnStateChanged += StateHasChanged;
        
        // 订阅经验值变化事件
        GameState.SubscribeToEvent(GameEventType.ExperienceGained, OnExperienceGained);
        GameState.SubscribeToEvent(GameEventType.LevelUp, _ => StateHasChanged());
    }

    private void OnExperienceGained(GameEventArgs args)
    {
        // 确保UI更新
        StateHasChanged();
    }

    private void SwitchCharacter(string characterId)
    {
        if (GameState.ActiveCharacter?.Id != characterId)
        {
            GameState.SetActiveCharacter(characterId);
        }
    }

    public void Dispose()
    {
        GameState.OnStateChanged -= StateHasChanged;
        
        // 取消订阅事件
        GameState.UnsubscribeFromEvent(GameEventType.ExperienceGained, OnExperienceGained);
        GameState.UnsubscribeFromEvent(GameEventType.LevelUp, _ => StateHasChanged());
    }
}