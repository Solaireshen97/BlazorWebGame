# BlazorWebGame æ•°æ®å­˜å‚¨æ¶æ„é—®é¢˜æ€»ç»“ä¸è§£å†³æ–¹æ¡ˆ

## ğŸš¨ æ ¸å¿ƒé—®é¢˜è¯†åˆ«

### 1. æ¶æ„è®¾è®¡é—®é¢˜

#### é—®é¢˜1: æ•°æ®å­˜å‚¨æœåŠ¡é‡å¤å®ç°
**ç°çŠ¶**: é¡¹ç›®ä¸­å­˜åœ¨å¤šä¸ªç›¸ä¼¼çš„æ•°æ®å­˜å‚¨æœåŠ¡ç±»
- `DataStorageService.cs` (å†…å­˜å­˜å‚¨)
- `SqliteDataStorageService.cs` (SQLiteå®ç°)
- `ConsolidatedDataStorageService.cs` (ç»Ÿä¸€å®ç°)
- `UnifiedDataStorageService.cs` (å¦ä¸€ä¸ªç»Ÿä¸€å®ç°)

**å½±å“**:
- ä»£ç ç»´æŠ¤å›°éš¾
- é€»è¾‘ä¸ä¸€è‡´
- èµ„æºæµªè´¹

**è§£å†³æ–¹æ¡ˆ**:
```csharp
// ç»Ÿä¸€æ¥å£å®šä¹‰
public interface IDataStorageService
{
    Task<PlayerStorageDto?> GetPlayerAsync(string playerId);
    Task<ApiResponse<PlayerStorageDto>> SavePlayerAsync(PlayerStorageDto player);
    // ... å…¶ä»–æ–¹æ³•
}

// å•ä¸€å®ç° + è£…é¥°å™¨æ¨¡å¼
builder.Services.AddScoped<IDataStorageService, ConsolidatedDataStorageService>();
builder.Services.Decorate<IDataStorageService, CachedDataStorageService>();
```

#### é—®é¢˜2: å®¢æˆ·ç«¯ç¦»çº¿åŠŸèƒ½ç¼ºå¤±
**ç°çŠ¶**: `OfflineService` è¢«ç®€åŒ–ä¸ºå­˜æ ¹ï¼Œä¸å†æ”¯æŒç¦»çº¿åŠŸèƒ½

**å½±å“**:
- ç½‘ç»œä¸­æ–­æ—¶ç”¨æˆ·ä½“éªŒå·®
- æ•°æ®å¯èƒ½ä¸¢å¤±
- æ— æ³•åœ¨å¼±ç½‘ç¯å¢ƒä½¿ç”¨

**è§£å†³æ–¹æ¡ˆ**:
```csharp
public class OfflineService
{
    private readonly IndexedDbStorage _storage;
    private readonly Queue<OfflineAction> _pendingActions = new();
    
    public async Task EnterOfflineMode()
    {
        _isOfflineMode = true;
        await SaveCurrentStateToLocal();
        OnOfflineModeChanged?.Invoke(true);
    }
    
    public async Task<bool> SyncWhenOnline()
    {
        while (_pendingActions.Count > 0)
        {
            var action = _pendingActions.Dequeue();
            await ExecuteAction(action);
        }
        return true;
    }
}
```

### 2. æ•°æ®åº“è®¾è®¡é—®é¢˜

#### é—®é¢˜1: JSONå­—æ®µè¿‡åº¦ä½¿ç”¨
**ç°çŠ¶**: å¤§é‡ä½¿ç”¨JSONå­—æ®µå­˜å‚¨å¤æ‚æ•°æ®
```csharp
public string AttributesJson { get; set; }
public string InventoryJson { get; set; }
public string SkillsJson { get; set; }
```

**å½±å“**:
- æ— æ³•æœ‰æ•ˆä½¿ç”¨æ•°æ®åº“ç´¢å¼•
- æŸ¥è¯¢æ€§èƒ½å·®
- æ•°æ®å®Œæ•´æ€§éš¾ä»¥ä¿è¯

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- æ‹†åˆ†ä¸ºç‹¬ç«‹è¡¨
CREATE TABLE PlayerAttributes (
    PlayerId TEXT NOT NULL,
    AttributeType TEXT NOT NULL,
    Value INTEGER NOT NULL,
    PRIMARY KEY (PlayerId, AttributeType)
);

CREATE INDEX IX_PlayerAttributes_Type ON PlayerAttributes(AttributeType, Value);
```

#### é—®é¢˜2: ç¼ºä¹æœ‰æ•ˆç´¢å¼•
**ç°çŠ¶**: å…³é”®æŸ¥è¯¢è·¯å¾„ç¼ºä¹å¤åˆç´¢å¼•

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢æ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX IX_Players_Online_Level ON Players(IsOnline, Level, LastActiveAt);
CREATE INDEX IX_BattleRecords_Status_Time ON BattleRecords(Status, StartedAt DESC);
CREATE INDEX IX_ActionTargets_Player_Active ON ActionTargets(PlayerId, IsCompleted, StartedAt);
```

### 3. æ€§èƒ½é—®é¢˜

#### é—®é¢˜1: ç¼ºä¹ç¼“å­˜æœºåˆ¶
**ç°çŠ¶**: æ¯æ¬¡è¯·æ±‚éƒ½ç›´æ¥è®¿é—®æ•°æ®åº“

**å½±å“**:
- æ•°æ®åº“å‹åŠ›å¤§
- å“åº”æ—¶é—´æ…¢
- èµ„æºåˆ©ç”¨ç‡ä½

**è§£å†³æ–¹æ¡ˆ**:
```csharp
public class MultiLevelCacheService
{
    private readonly IMemoryCache _l1Cache;
    private readonly IDistributedCache _l2Cache;
    
    public async Task<T> GetAsync<T>(string key)
    {
        // L1ç¼“å­˜ (å†…å­˜)
        if (_l1Cache.TryGetValue(key, out T value))
            return value;
            
        // L2ç¼“å­˜ (Redis)
        var cached = await _l2Cache.GetStringAsync(key);
        if (cached != null)
        {
            value = JsonSerializer.Deserialize<T>(cached);
            _l1Cache.Set(key, value, TimeSpan.FromMinutes(5));
            return value;
        }
        
        // æ•°æ®åº“æŸ¥è¯¢
        return await LoadFromDatabase<T>(key);
    }
}
```

#### é—®é¢˜2: N+1æŸ¥è¯¢é—®é¢˜
**ç°çŠ¶**: æŸ¥è¯¢ç©å®¶æ—¶å¯èƒ½è§¦å‘å¤šæ¬¡æ•°æ®åº“è®¿é—®

**è§£å†³æ–¹æ¡ˆ**:
```csharp
// ä½¿ç”¨Includeé¢„åŠ è½½
public async Task<List<PlayerWithTeam>> GetPlayersWithTeamsAsync()
{
    return await _context.Players
        .Include(p => p.Team)
        .ThenInclude(t => t.Members)
        .AsNoTracking()
        .ToListAsync();
}
```

### 4. ä»£ç è´¨é‡é—®é¢˜

#### é—®é¢˜1: é”™è¯¯å¤„ç†ä¸ä¸€è‡´
**ç°çŠ¶**: 
```csharp
// æœ‰äº›åœ°æ–¹åªè¾“å‡ºåˆ°æ§åˆ¶å°
Console.WriteLine($"Error: {ex.Message}");

// æœ‰äº›åœ°æ–¹ä½¿ç”¨æ—¥å¿—
_logger.LogError(ex, "Error occurred");
```

**è§£å†³æ–¹æ¡ˆ**:
```csharp
public class Result<T>
{
    public bool IsSuccess { get; }
    public T Data { get; }
    public string ErrorMessage { get; }
    public Exception Exception { get; }
    
    public static Result<T> Success(T data) => new(true, data, null, null);
    public static Result<T> Error(string message, Exception ex = null) => new(false, default, message, ex);
}
```

#### é—®é¢˜2: ç¼ºä¹å•å…ƒæµ‹è¯•
**ç°çŠ¶**: æ•°æ®è®¿é—®å±‚æµ‹è¯•è¦†ç›–ç‡ä½

**è§£å†³æ–¹æ¡ˆ**:
```csharp
[TestClass]
public class PlayerRepositoryTests
{
    private GameDbContext _context;
    private PlayerRepository _repository;
    
    [TestInitialize]
    public void Setup()
    {
        var options = new DbContextOptionsBuilder<GameDbContext>()
            .UseInMemoryDatabase(databaseName: Guid.NewGuid().ToString())
            .Options;
            
        _context = new GameDbContext(options);
        _repository = new PlayerRepository(_context);
    }
    
    [TestMethod]
    public async Task GetPlayerAsync_ExistingPlayer_ReturnsPlayer()
    {
        // Arrange
        var player = new PlayerEntity { Id = "test", Name = "Test Player" };
        _context.Players.Add(player);
        await _context.SaveChangesAsync();
        
        // Act
        var result = await _repository.GetByIdAsync("test");
        
        // Assert
        Assert.IsNotNull(result);
        Assert.AreEqual("Test Player", result.Name);
    }
}
```

## ğŸ”„ åˆ†é˜¶æ®µè§£å†³æ–¹æ¡ˆ

### é˜¶æ®µ1: ç´§æ€¥ä¿®å¤ (æœ¬å‘¨)
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜
- [x] ä¿®å¤æ•°æ®åº“è¿æ¥é…ç½®
- [x] æ·»åŠ åŸºç¡€ç¼“å­˜
- [x] æ”¹è¿›é”™è¯¯å¤„ç†
- [x] æ·»åŠ å…³é”®ç´¢å¼•

### é˜¶æ®µ2: æ¶æ„é‡æ„ (2-3å‘¨)
**ä¼˜å…ˆçº§**: ğŸŸ  ä¸­
- [ ] ç»Ÿä¸€æ•°æ®å­˜å‚¨æœåŠ¡
- [ ] å®ç°Repositoryæ¨¡å¼
- [ ] é‡æ„æ•°æ®æ¨¡å‹
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•

### é˜¶æ®µ3: åŠŸèƒ½å¢å¼º (1ä¸ªæœˆ)
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä½
- [ ] æ¢å¤ç¦»çº¿åŠŸèƒ½
- [ ] å®ç°æ•°æ®åŒæ­¥
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§
- [ ] ä¼˜åŒ–æ‰¹é‡æ“ä½œ

## ğŸ“ˆ é¢„æœŸæ”¹è¿›æ•ˆæœ

### æ€§èƒ½æŒ‡æ ‡
| æŒ‡æ ‡ | å½“å‰çŠ¶æ€ | ç›®æ ‡æ”¹è¿› | é¢„æœŸæ•ˆæœ |
|------|----------|----------|----------|
| APIå“åº”æ—¶é—´ | 200-500ms | 50-150ms | æå‡60-70% |
| æ•°æ®åº“æŸ¥è¯¢ | 10-50ms | 2-10ms | æå‡80% |
| å†…å­˜ä½¿ç”¨ | 150-200MB | 100-150MB | å‡å°‘25-30% |
| ç¼“å­˜å‘½ä¸­ç‡ | 0% | 80-90% | æ–°å¢åŠŸèƒ½ |

### ä»£ç è´¨é‡
- **æµ‹è¯•è¦†ç›–ç‡**: ä» <20% æå‡åˆ° >80%
- **ä»£ç é‡å¤**: å‡å°‘ 60%
- **ç»´æŠ¤å¤æ‚åº¦**: é™ä½ 50%
- **é”™è¯¯å¤„ç†**: æ ‡å‡†åŒ– 100%

## ğŸ› ï¸ ç«‹å³è¡ŒåŠ¨æ¸…å•

### ä»Šå¤©å¯ä»¥å®Œæˆ (30åˆ†é’Ÿ)
1. **æ›´æ–°æ•°æ®åº“é…ç½®**
   ```json
   "DefaultConnection": "Data Source=gamedata.db;Cache=Shared;Pooling=true;Journal Mode=WAL;"
   ```

2. **æ·»åŠ å†…å­˜ç¼“å­˜**
   ```csharp
   builder.Services.AddMemoryCache(options => {
       options.SizeLimit = 1000;
   });
   ```

3. **åˆ›å»ºå¥åº·æ£€æŸ¥**
   ```csharp
   builder.Services.AddHealthChecks()
       .AddDbContextCheck<GameDbContext>();
   ```

### æœ¬å‘¨å¯ä»¥å®Œæˆ (2å°æ—¶)
1. **å®ç°ç¼“å­˜è£…é¥°å™¨**
2. **æ·»åŠ å…³é”®ç´¢å¼•**
3. **ç»Ÿä¸€é”™è¯¯å¤„ç†**
4. **åŸºç¡€å•å…ƒæµ‹è¯•**

### æœ¬æœˆç›®æ ‡ (20å°æ—¶)
1. **å®Œæ•´æ¶æ„é‡æ„**
2. **ç¦»çº¿åŠŸèƒ½æ¢å¤**
3. **æ€§èƒ½ç›‘æ§ç³»ç»Ÿ**
4. **å®Œæ•´æµ‹è¯•è¦†ç›–**

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. å¼€å‘æµç¨‹
- æµ‹è¯•é©±åŠ¨å¼€å‘ (TDD)
- ä»£ç å®¡æŸ¥åˆ¶åº¦
- æŒç»­é›†æˆéƒ¨ç½²
- æ€§èƒ½åŸºå‡†æµ‹è¯•

### 2. æ•°æ®è®¿é—®
- Repositoryæ¨¡å¼å°è£…
- ç¼“å­˜ç­–ç•¥åˆ†å±‚
- è¿æ¥æ± ä¼˜åŒ–
- æŸ¥è¯¢é¢„ç¼–è¯‘

### 3. é”™è¯¯å¤„ç†
- ç»“æ„åŒ–å¼‚å¸¸å¤„ç†
- æ—¥å¿—ç­‰çº§åˆ’åˆ†
- ç›‘æ§å‘Šè­¦æœºåˆ¶
- ç”¨æˆ·å‹å¥½æç¤º

### 4. å®‰å…¨è€ƒè™‘
- è¾“å…¥éªŒè¯è¿‡æ»¤
- SQLæ³¨å…¥é˜²æŠ¤
- æ•°æ®è„±æ•å¤„ç†
- è®¿é—®æƒé™æ§åˆ¶

**ğŸš€ ç«‹å³å¼€å§‹**: ä»"ä»Šå¤©å¯ä»¥å®Œæˆ"çš„ä»»åŠ¡å¼€å§‹ï¼Œ30åˆ†é’Ÿå†…çœ‹åˆ°æ˜¾è‘—æ”¹è¿›ï¼