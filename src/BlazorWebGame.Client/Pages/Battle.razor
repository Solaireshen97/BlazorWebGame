@page "/battle"
@using BlazorWebGame.Models
@using BlazorWebGame.Models.Battles
@using BlazorWebGame.Models.Dungeons
@using BlazorWebGame.Models.Items
@using BlazorWebGame.Models.Monsters
@using BlazorWebGame.Models.Regions
@using BlazorWebGame.Services
@using BlazorWebGame.Client.Services.Api
@using BlazorWebGame.Shared.DTOs
@using static BlazorWebGame.Services.CombatService
@using BattleTypeLocal = BlazorWebGame.Models.Battles.BattleType
@using BattleTypeServer = BlazorWebGame.Shared.DTOs.BattleType
@inject GameStateService GameState
@inject CharacterService CharacterService
@inject ClientGameStateService NewGameState
@inject GameApiService GameApi
@inject OfflineService OfflineService
@inject IConfiguration Configuration
@inject ILogger<Battle> Logger
@implements IDisposable

<PageTitle>è‡ªåŠ¨æˆ˜æ–—</PageTitle>

@* ç³»ç»Ÿæ¨¡å¼åˆ‡æ¢å’Œæç¤º *@
<div class="battle-system-indicator mb-2">
    <div class="alert @(_useNewBattleSystem ? "alert-info" : "alert-secondary") d-flex justify-content-between align-items-center">
        <div>
            <i class="bi @(_useNewBattleSystem ? "bi-cloud" : "bi-cpu")"></i>
            <strong>æˆ˜æ–—ç³»ç»Ÿ:</strong> @(_useNewBattleSystem ? "æœåŠ¡å™¨æ¨¡å¼" : "æœ¬åœ°æ¨¡å¼")
            @if (_useNewBattleSystem && OfflineService.IsOfflineMode)
            {
                <span class="badge bg-warning ms-2">ç¦»çº¿æ¨¡å¼</span>
            }
            @if (_useNewBattleSystem && _serverBattleState != null && _serverBattleState.IsActive)
            {
                <span class="badge bg-success ms-2">
                    <i class="bi bi-play-circle"></i> åœ¨çº¿æˆ˜æ–—ä¸­ - ID: @(_serverBattleState.BattleId.ToString()[..8])
                </span>
            }
        </div>
        <div class="d-flex align-items-center gap-2">
            @if (_useNewBattleSystem)
            {
                <small class="text-muted">
                    <i class="bi @(_isConnected ? "bi-wifi" : "bi-wifi-off")"></i>
                    è¿æ¥çŠ¶æ€: @(_isConnected ? "å·²è¿æ¥" : "è¿æ¥æ–­å¼€")
                    @if (_serverBattleState != null)
                    {
                        <br />
                        <span class="text-info">æœ€åæ›´æ–°: @_serverBattleState.LastUpdated.ToString("HH:mm:ss")</span>
                    }
                </small>
            }
            <div class="btn-group" role="group">
                <button type="button" class="btn @(!_useNewBattleSystem ? "btn-primary" : "btn-outline-primary") btn-sm" 
                        @onclick="() => ToggleBattleSystem(false)">
                    <i class="bi bi-cpu"></i> æœ¬åœ°æ¨¡å¼
                </button>
                <button type="button" class="btn @(_useNewBattleSystem ? "btn-primary" : "btn-outline-primary") btn-sm" 
                        @onclick="() => ToggleBattleSystem(true)">
                    <i class="bi bi-cloud"></i> æœåŠ¡å™¨æ¨¡å¼
                </button>
            </div>
        </div>
    </div>
</div>

@if (GameState.ActiveCharacter is Player character)
{
    var party = GameState.GetPartyForCharacter(character.Id);
    var battleContext = GetUnifiedBattleContext(character.Id);
    var currentEnemy = GetCurrentEnemy(character, battleContext);
    var isPartyMemberAndNotCaptain = party != null && party.CaptainId != character.Id;

    <div class="battle-page-layout">
        <!-- ï¿½ï¿½ï¿½ï¿½Ñ¡ï¿½ï¿½ -->
        <div class="battle-control-bar">
            <button class="btn btn-outline-primary" @onclick="ToggleMonsterSelector">
                <i class="bi bi-list-ul"></i> Ñ¡ï¿½ï¿½Õ½ï¿½ï¿½Ä¿ï¿½ï¿½
            </button>

            @if (party != null && party.CaptainId == character.Id)
            {
                <button class="btn btn-outline-info" @onclick="ToggleDungeonSelector"
                        disabled="@(battleContext != null && battleContext.BattleType == BattleTypeLocal.Dungeon)">
                    <i class="bi bi-dungeon"></i> Ñ¡ï¿½ñ¸±±ï¿½
                </button>
            }

            <div class="view-switcher d-flex gap-2">
                <button class="btn @(_currentView == BattleView.Battle ? "btn-primary" : "btn-outline-primary")" @onclick="() => _currentView = BattleView.Battle">
                    Õ½ï¿½ï¿½
                </button>
                <button class="btn @(_currentView == BattleView.Party ? "btn-primary" : "btn-outline-primary")" @onclick="() => _currentView = BattleView.Party">
                    ï¿½ï¿½ï¿½ï¿½
                </button>
            </div>
        </div>
        <!-- ï¿½ï¿½ï¿½ï¿½Ñ¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ -->
        @if (_showMonsterSelector)
        {
            <div class="modal-backdrop" @onclick="CloseSelectors"></div>
            <div class="monster-selector-modal">
                <div class="selector-header">
                    <h5>Ñ¡ï¿½ï¿½Õ½ï¿½ï¿½Ä¿ï¿½ï¿½</h5>
                    <button type="button" class="btn-close" @onclick="CloseSelectors"></button>
                </div>

                <div class="region-navigation-container">
                    <!-- ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½òµ¼ºï¿½ -->
                    <div class="region-navigation">
                        <!-- ï¿½ï¿½ï¿½Ğ¼ï¿½ï¿½ï¿½ï¿½ -->
                        <div class="breadcrumb-navigation">
                            <span class="breadcrumb-item" @onclick="() => ResetNavigation()">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</span>
                            @for (int i = 0; i < _navigationPath.Count; i++)
                            {
                                var index = i;
                                var region = RegionTemplates.GetById(_navigationPath[index]);
                                if (region != null)
                                {
                                    <span class="breadcrumb-separator">/</span>
                                    <span class="breadcrumb-item @(index == _navigationPath.Count - 1 ? "active" : "")"
                                          @onclick="() => NavigateToPathLevel(index + 1)">
                                        @region.Name
                                    </span>
                                }
                            }
                        </div>

                        <!-- ï¿½ï¿½Ç°ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ğ±ï¿½ -->
                        <div class="region-level">
                            @{
                                var currentRegions = GetCurrentLevelRegions();
                            }

                            @foreach (var region in currentRegions)
                            {
                                <div class="region-item @(region.MinimumLevel > CharacterService.GetLevel(character, character.SelectedBattleProfession) ? "disabled" : "")"
                                     @onclick="() => NavigateToRegion(region.Id)"
                                     title="@region.Description">
                                    <div class="region-name">@region.Name</div>
                                    <div class="region-level-info">
                                        @if (region.MinimumLevel > 1)
                                        {
                                            <span class="level-req">ï¿½ï¿½Òªï¿½È¼ï¿½: @region.MinimumLevel+</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- ï¿½ï¿½ï¿½ï¿½ï¿½Ú¹ï¿½ï¿½ï¿½ï¿½Ğ±ï¿½ -->
                        @{
                            var currentRegion = GetCurrentRegion();
                            var hasSubRegions = currentRegion?.SubRegionIds?.Any() == true;

                            // Ö»ï¿½Ğµï¿½ï¿½ï¿½Ç°ï¿½ï¿½ï¿½ï¿½Ã»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½Ê¾ï¿½ï¿½ï¿½ï¿½ï¿½Ğ±ï¿½
                            if (currentRegion != null && !hasSubRegions)
                            {
                                <div class="monsters-in-region">
                                    @{
                                        var monsters = currentRegion.GetMonsters();
                                    }

                                    @foreach (var monster in monsters)
                                    {
                                        var isFighting = IsCurrentlyFightingMonster(monster.Name, battleContext);

                                        <div class="monster-select-item @(isFighting ? "active" : "") @(_selectedMonster?.Name == monster.Name ? "selected" : "")"
                                             @onclick="() => SelectMonster(monster)"
                                             title="@monster.Description">
                                            <div class="monster-name">@monster.Name</div>
                                            <div class="monster-level">Lv.@monster.Level</div>
                                        </div>
                                    }

                                    @if (!monsters.Any())
                                    {
                                        <div class="no-monsters-message">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ã»ï¿½Ğ¿ï¿½Ñ¡ï¿½ï¿½Ä¹ï¿½ï¿½ï¿½</div>
                                    }
                                </div>
                            }
                        }
                    </div>

                    <!-- ï¿½Ò²ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ -->
                    <div class="monster-details-panel">
                        @if (_selectedMonster != null)
                        {
                            <div class="monster-header">
                                <h4>@_selectedMonster.Name <span class="monster-level-badge">Lv.@_selectedMonster.Level</span></h4>
                                <div class="monster-type-badge @GetMonsterTypeBadgeClass(_selectedMonster.Type)">
                                    @GetMonsterTypeText(_selectedMonster.Type)
                                </div>
                            </div>

                            <div class="monster-description">
                                @_selectedMonster.Description
                            </div>

                            <div class="monster-stats">
                                <!-- ï¿½ï¿½ï¿½ï¿½Ô­ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ -->
                                <div class="stat-item">
                                    <div class="stat-label">ï¿½ï¿½ï¿½ï¿½Öµ</div>
                                    <div class="stat-value">@_selectedMonster.MaxHealth</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</div>
                                    <div class="stat-value">@_selectedMonster.AttackPower</div>
                                </div>
                                <!-- ï¿½ï¿½ï¿½ï¿½Ñ¡ï¿½ï¿½ï¿½ï¿½ï¿½ĞµÄ¹ï¿½ï¿½ï¿½ï¿½Ù¶ï¿½ï¿½ï¿½Ê¾ -->
                                <div class="stat-item">
                                    <div class="stat-label">ï¿½ï¿½ï¿½ï¿½</div>
                                    <div class="stat-value">@((1 / _selectedMonster.AttacksPerSecond).ToString("F2"))ï¿½ï¿½/ï¿½ï¿½</div>
                                </div>

                                <!-- ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ -->
                                <div class="stat-item">
                                    <div class="stat-label">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</div>
                                    <div class="stat-value">@(_selectedMonster.DodgeChance.ToString("P1"))</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</div>
                                    <div class="stat-value">@(_selectedMonster.CriticalChance.ToString("P0"))</div>
                                </div>

                                <!-- ï¿½ï¿½ï¿½ï¿½Ô­ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ -->
                                <div class="stat-item">
                                    <div class="stat-label">ï¿½ï¿½ï¿½ï¿½Öµ</div>
                                    <div class="stat-value">@_selectedMonster.XpReward</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">ï¿½ï¿½ï¿½</div>
                                    <div class="stat-value">@_selectedMonster.MinGold-@_selectedMonster.MaxGold</div>
                                </div>
                            </div>

                            <div class="monster-loot">
                                <h5>ï¿½ï¿½ï¿½Üµï¿½ï¿½ï¿½</h5>
                                <div class="loot-list">
                                    @if (_selectedMonster.LootTable.Count > 0)
                                    {
                                        @foreach (var loot in _selectedMonster.LootTable)
                                        {
                                            var item = ItemData.GetItemById(loot.Key);
                                            if (item != null)
                                            {
                                                <div class="loot-item">
                                                    <span class="item-name">@item.Name</span>
                                                    <span class="drop-chance">@((loot.Value * 100).ToString("F1"))%</span>
                                                    <label class="auto-sell-toggle">
                                                        <input type="checkbox"
                                                               checked="@(character.AutoSellItemIds.Contains(item.Id))"
                                                               @onchange="() => GameState.ToggleAutoSellItem(item.Id)" />
                                                        <span>ï¿½Ô¶ï¿½ï¿½ï¿½ï¿½ï¿½</span>
                                                    </label>
                                                </div>
                                            }
                                        }
                                    }
                                    else
                                    {
                                        <div class="no-loot-message">ï¿½ï¿½ï¿½ï¿½Æ·ï¿½ï¿½ï¿½ï¿½</div>
                                    }
                                </div>
                            </div>

                            <div class="monster-skills">
                                <h5>ï¿½ï¿½ï¿½ï¿½</h5>
                                <div class="skills-list">
                                    @if (_selectedMonster.SkillIds.Count > 0)
                                    {
                                        @foreach (var skillId in _selectedMonster.SkillIds)
                                        {
                                            var skill = SkillData.GetSkillById(skillId);
                                            if (skill != null)
                                            {
                                                <div class="skill-item" title="@skill.Description">
                                                    <span class="skill-name">@skill.Name</span>
                                                </div>
                                            }
                                        }
                                    }
                                    else
                                    {
                                        <div class="no-skills-message">ï¿½ï¿½ï¿½ï¿½ï¿½â¼¼ï¿½ï¿½</div>
                                    }
                                </div>
                            </div>

                            <div class="battle-actions">
                                <button class="btn btn-primary" @onclick="() => StartBattleUnified(_selectedMonster)">
                                    <i class="bi bi-sword"></i> ï¿½ï¿½Ê¼Õ½ï¿½ï¿½ (@(_useNewBattleSystem ? "ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½" : "ï¿½ï¿½ï¿½ï¿½"))
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="no-selection-message">
                                <i class="bi bi-arrow-left-circle"></i>
                                <p>ï¿½ï¿½Ñ¡ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½é¿´ï¿½ï¿½ï¿½ï¿½</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        <!-- ï¿½ï¿½ï¿½ï¿½Ñ¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ -->
        @if (_showDungeonSelector)
        {
            <div class="modal-backdrop" @onclick="CloseSelectors"></div>
            <div class="dungeon-selector-modal">
                <div class="selector-header">
                    <h5>Ñ¡ï¿½ñ¸±±ï¿½</h5>
                    <button type="button" class="btn-close" @onclick="CloseSelectors"></button>
                </div>

                <div class="dungeons-list">
                    @foreach (var dungeon in DungeonTemplates.All)
                    {
                        bool canEnter = CanEnterDungeon(character, party, dungeon);

                        <div class="dungeon-select-item @(!canEnter ? "disabled" : "")"
                             @onclick="async () => { if (canEnter) await StartDungeon(dungeon.Id); }">
                            <div class="dungeon-info">
                                <div class="dungeon-name">@dungeon.Name</div>
                                <div class="dungeon-level">ï¿½Æ¼ï¿½ï¿½È¼ï¿½: @dungeon.RecommendedLevel</div>
                                <div class="dungeon-players">@dungeon.MinPlayers-@dungeon.MaxPlayers ï¿½ï¿½</div>
                            </div>
                            <div class="dungeon-description">@dungeon.Description</div>
                            @if (!canEnter)
                            {
                                <div class="dungeon-requirements">
                                    @GetDungeonRequirementText(character, party, dungeon)
                                </div>
                            }
                        </div>
                    }

                    @if (!DungeonTemplates.All.Any())
                    {
                        <div class="no-dungeons-message">Ã»ï¿½Ğ¿ï¿½ï¿½ÃµÄ¸ï¿½ï¿½ï¿½</div>
                    }
                </div>
            </div>
        }
 

        @if (_currentView == BattleView.Battle)
        {
            <div class="battle-info-panel mb-3">
                @if (battleContext != null || (_useNewBattleSystem && _serverBattleState?.IsActive == true))
                {
                    <div class="battle-status active">
                        <h5 class="battle-title">
                            @(GetUnifiedBattleModeText(battleContext, _serverBattleState))
                <button class="btn btn-danger btn-sm" @onclick="() => StopUnifiedBattle()">
                    <i class="bi bi-stop-circle"></i> ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½
                </button>
            </h5>
            <div class="battle-status-text d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-play-circle"></i> 
                    @if (_useNewBattleSystem && _serverBattleState != null)
                    {
                        <span>åœ¨çº¿æˆ˜æ–—è¿›è¡Œä¸­ - æ•Œäººè¡€é‡: @_serverBattleState.EnemyHealth/@_serverBattleState.EnemyMaxHealth</span>
                    }
                    else if (battleContext != null)
                    {
                        <span>è‡ªåŠ¨æˆ˜æ–—ä¸­ - æ•Œäºº: @battleContext.Enemies.Count ä¸ªå‰©ä½™</span>
                    }
                </div>
                @if (_useNewBattleSystem && !_isConnected)
                {
                    <div class="text-warning">
                        <i class="bi bi-wifi-off"></i> è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...
                    </div>
                }
            </div>
        </div>
                }
                else if (IsInBattleRefresh(character.Id))
                {
                    <div class="battle-status cooldown">
                        <h5 class="battle-title d-flex justify-content-between align-items-center">
                            <span>Õ½ï¿½ï¿½ï¿½ï¿½È´ï¿½ï¿½</span>
                            <button class="btn btn-danger btn-sm" @onclick="GameState.StopCurrentAction">
                                <i class="bi bi-stop-circle"></i> ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½
                            </button>
                        </h5>
                        <div class="battle-status-text">
                            <i class="bi bi-hourglass-split"></i> @GetBattleRefreshTime(character.Id).ToString("F1")ï¿½ï¿½ï¿½ï¿½Ô¶ï¿½ï¿½ï¿½Ê¼ï¿½ï¿½Ò»ï¿½ï¿½Õ½ï¿½ï¿½
                        </div>
                    </div>
                }
                else
                {
                    <div class="battle-status waiting">
                        <h5 class="battle-title">ï¿½È´ï¿½ï¿½ï¿½Ê¼Õ½ï¿½ï¿½</h5>
                        <div class="battle-status-text">
                            <i class="bi bi-info-circle"></i> ï¿½ï¿½Ñ¡ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½
                        </div>
                    </div>
                }
            </div>

            <!-- ================= BATTLE VIEW (Õ½ï¿½ï¿½ï¿½ï¿½Í¼) ================= -->
            <!-- ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½ -->
            <div class="battle-core-area">
                <!-- ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÒºÍ¶ï¿½ï¿½ï¿½ï¿½Ô± -->
                <div class="battle-left-side">
                    <!-- ï¿½ï¿½ï¿½ï¿½ï¿½Ô±ï¿½Ğ±ï¿½ - ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ -->
                    @if (party != null)
                    {
                        <div class="party-members-container horizontal">
                            @{
                                var otherPartyMembers = party.MemberIds
                                .Where(id => id != character.Id)
                                .Select(id => GameState.AllCharacters.FirstOrDefault(c => c.Id == id))
                                .Where(p => p != null)
                                .ToList();

                                // ï¿½ï¿½ï¿½ï¿½Ó¦ï¿½ï¿½ï¿½ï¿½Ê¾ï¿½Ä¿ï¿½Î»ï¿½ï¿½ï¿½ï¿½
                                var emptySlots = Math.Max(0, Party.MaxMembers - 1 - otherPartyMembers.Count);
                            }

                            @foreach (var member in otherPartyMembers)
                            {
                                var isCaptain = party.CaptainId == member.Id;
                                var isInBattle = battleContext?.Players.Any(p => p.Id == member.Id) ?? false;
                                var memberHealth = isInBattle ?
                                battleContext.Players.First(p => p.Id == member.Id).Health :
                                member.Health;
                                var memberMaxHealth = isInBattle ?
                                battleContext.Players.First(p => p.Id == member.Id).GetTotalMaxHealth() :
                                CharacterService.GetTotalMaxHealth(member);

                                <div class="party-member-card @(member.IsDead ? "member-dead" : "") @(isCaptain ? "captain" : "")">
                                    <div class="member-avatar">@member.Name.Substring(0, 1)</div>
                                    <div class="member-info">
                                        <div class="member-name">
                                            @member.Name @(isCaptain ? "(ï¿½Ó³ï¿½)" : "")
                                        </div>
                                        <div class="member-profession">
                                            @member.SelectedBattleProfession.ToChineseString()
                                        </div>
                                        <div class="mini-health-bar">
                                            <div class="mini-health-fill" style="width: @(GetHealthPercentage(memberHealth, memberMaxHealth))%"></div>
                                            <span class="mini-health-text">@memberHealth/@memberMaxHealth</span>
                                        </div>
                                    </div>
                                </div>
                            }

                            @for (int i = 0; i < emptySlots; i++)
                            {
                                <div class="party-member-card empty">
                                    <div class="member-avatar empty">?</div>
                                    <div class="member-info">
                                        <div class="member-name">ï¿½ï¿½Î»</div>
                                        <div class="member-profession">ï¿½È´ï¿½ï¿½ï¿½ï¿½ï¿½</div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <!-- ï¿½ï¿½Ò¿ï¿½Æ¬ -->
                    <div class="character-card player-card">
                        @if (character.IsDead)
                        {
                            <div class="player-dead-card">
                                <h3>ï¿½ã±»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½...</h3>
                                <p>ï¿½ï¿½ï¿½îµ¹ï¿½ï¿½Ê±: @character.RevivalTimeRemaining.ToString("F1")s</p>
                            </div>
                        }
                        else
                        {
                            <div class="character-image-placeholder"><span>Í·ï¿½ï¿½</span></div>
                            <div class="player-name-container">
                                <div class="player-level-badge">
                                    @character.SelectedBattleProfession.ToChineseString() Lv.@CharacterService.GetLevel(character, character.SelectedBattleProfession)
                                </div>
                                <h5 class="player-name">@character.Name</h5>
                            </div>
                            <div class="health-bar-container">
                                <div class="health-bar player-health" style="width: @(GetHealthPercentage(character.Health, CharacterService.GetTotalMaxHealth(character)))%;"></div>
                                <span class="health-text">@character.Health / @CharacterService.GetTotalMaxHealth(character)</span>
                            </div>
                            <div class="attack-progress-container">
                                <div class="attack-progress-bar" style="width: @(GetAttackProgress(character.AttackCooldown, character.AttacksPerSecond))%;"></div>
                            </div>
                            <div class="action-bar">
                                <div class="equipped-skills-display">
                                    @foreach (var skillId in character.EquippedSkills[character.SelectedBattleProfession])
                                    {
                                        var skill = SkillData.GetSkillById(skillId);
                                        if (skill != null)
                                        {
                                            var isOnCooldown = character.SkillCooldowns.GetValueOrDefault(skillId, 0) > 0;
                                            var skillIdCopy = skillId; // é¿å…é—­åŒ…é—®é¢˜
                                            
                                            <div class="skill-icon-container @(!isOnCooldown ? "clickable" : "")" 
                                                 title="@skill.Name: @skill.Description @(_useNewBattleSystem ? " (ç‚¹å‡»ä½¿ç”¨ - åœ¨çº¿æ¨¡å¼)" : "")"
                                                 @onclick="async () => await UseSkillIfAvailable(skillIdCopy, isOnCooldown)">
                                                <div class="skill-icon">@skill.Name.Substring(0, 1)</div>
                                                @if (isOnCooldown)
                                                {
                                                    <div class="cooldown-overlay"><span>@character.SkillCooldowns[skillId]</span></div>
                                                }
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- ï¿½Ò²ï¿½ï¿½ï¿½ï¿½ò£ºµï¿½ï¿½Ëºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ğ±ï¿½ -->
                <div class="battle-right-side">
                    <!-- ï¿½ï¿½ï¿½ï¿¨Æ¬ï¿½ï¿½ï¿½Ú¶ï¿½Ô¶ï¿½Õ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¾Ä¿ï¿½ï¿½ï¿½ï¿½Ë£ï¿½ -->
                    <div class="character-card enemy-card">
                        @if (currentEnemy is null)
                        {
                            <div class="character-image-placeholder"><span>ï¿½ï¿½ï¿½ï¿½</span></div>
                            <h5 class="text-muted">ï¿½ï¿½Ñ¡ï¿½ï¿½ï¿½ï¿½ï¿½</h5>
                        }
                        else
                        {
                            <div class="character-image-placeholder"><span>ï¿½ï¿½</span></div>
                            <h5>@currentEnemy.Name</h5>
                            <div class="health-bar-container">
                                <div class="health-bar enemy-health" style="width: @(GetHealthPercentage(currentEnemy.Health, currentEnemy.MaxHealth))%;"></div>
                                <span class="health-text">@currentEnemy.Health / @currentEnemy.MaxHealth</span>
                            </div>
                            <div class="attack-progress-container">
                                <div class="attack-progress-bar" style="width: @(GetAttackProgress(currentEnemy.EnemyAttackCooldown, currentEnemy.AttacksPerSecond))%;"></div>
                            </div>
                            <div class="action-bar">
                                <div class="equipped-skills-display">
                                    @foreach (var skillId in currentEnemy.SkillIds)
                                    {
                                        var skill = SkillData.GetSkillById(skillId);
                                        if (skill != null)
                                        {
                                            <div class="skill-icon-container" title="@skill.Name: @skill.Description">
                                                <div class="skill-icon">@skill.Name.Substring(0, 1)</div>
                                                @if (currentEnemy.SkillCooldowns.GetValueOrDefault(skillId, 0) > 0)
                                                {
                                                    <div class="cooldown-overlay"><span>@currentEnemy.SkillCooldowns[skillId]</span></div>
                                                }
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <!-- ï¿½ï¿½Ô¶ï¿½Õ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ğ±ï¿½ -->
                    @if (battleContext != null && battleContext.Enemies.Count > 1)
                    {
                        <div class="other-enemies-list horizontal">
                            <div class="enemy-list">
                                @foreach (var enemy in battleContext.Enemies.Where(e => e != currentEnemy))
                                {
                                    <div class="enemy-mini-card @(IsPlayerTarget(character.Id, enemy, battleContext) ? "border-primary" : "")"
                                         @onclick="async () => await SetPlayerTargetUnified(character.Id, enemy, battleContext)">
                                        <div class="d-flex justify-content-between">
                                            <span>@enemy.Name @(_useNewBattleSystem ? "ğŸŒ" : "")</span>
                                            <span>Lv.@enemy.Level</span>
                                        </div>
                                        <div class="mini-health-bar">
                                            <div class="mini-health-fill" style="width: @(GetHealthPercentage(enemy.Health, enemy.MaxHealth))%"></div>
                                            <span class="mini-health-text">@enemy.Health/@enemy.MaxHealth</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else // _currentView == BattleView.Party
        {
            <!-- ================= PARTY VIEW (ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í¼) ================= -->
            <div class="party-management-view p-3">
                @if (party == null)
                {
                    <h4 class="mb-3">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</h4>
                    <p>@character.Name ï¿½ï¿½Ç°ï¿½ï¿½ï¿½ï¿½ï¿½ÎºÎ¶ï¿½ï¿½ï¿½ï¿½Ğ¡ï¿½</p>
                    <button class="btn btn-success mb-3" @onclick="CreatePartyAndStopBattle">ï¿½ï¿½ï¿½ï¿½ï¿½Â¶ï¿½ï¿½ï¿½</button>

                    var availableParties = GameState.Parties
                    .Where(p => p.CaptainId != character.Id) // ï¿½ï¿½ï¿½ï¿½Ê¾ï¿½Ô¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä¶ï¿½ï¿½ï¿½
                    .Where(p => p.MemberIds.Count < Party.MaxMembers) // ï¿½ï¿½ï¿½ï¿½Î´ï¿½ï¿½
                    .Where(p => !IsPartyInBattle(p)) // ï¿½ï¿½ï¿½é²»ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½
                    .ToList();
                    @if (availableParties.Any())
                    {
                        <h5>ï¿½É¼ï¿½ï¿½ï¿½Ä¶ï¿½ï¿½ï¿½:</h5>
                        <ul class="list-group">
                            @foreach (var p in availableParties)
                            {
                                @if (p.MemberIds.Count < Party.MaxMembers)
                                {
                                    var captainName = GameState.AllCharacters.FirstOrDefault(c => c.Id == p.CaptainId)?.Name;
                                    var partyId = p.Id; // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ø±ï¿½ï¿½ï¿½ï¿½Ô±ï¿½ï¿½ï¿½lambdaï¿½ï¿½Ê¹ï¿½ï¿½
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            @captainName ï¿½Ä¶ï¿½ï¿½ï¿½ (@p.MemberIds.Count/@Party.MaxMembers ï¿½ï¿½)
                                                            <button class="btn btn-primary btn-sm" @onclick="() => JoinPartyAndStopBattle(partyId)">ï¿½ï¿½ï¿½ï¿½</button>
                                                        </li>
                                }
                            }
                        </ul>
                    }
                }
                else
                {
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ï¢ (@party.MemberIds.Count/@Party.MaxMembers)</h4>
                        <button class="btn btn-danger btn-sm" @onclick="LeavePartyAndStopBattle">
                            @(party.CaptainId == character.Id ? "ï¿½ï¿½É¢ï¿½ï¿½ï¿½ï¿½" : "ï¿½ë¿ªï¿½ï¿½ï¿½ï¿½")
                        </button>
                    </div>

                    <h5>ï¿½ï¿½ï¿½ï¿½ï¿½Ô±:</h5>
                    <ul class="list-group">
                        @foreach (var memberId in party.MemberIds)
                        {
                            var member = GameState.AllCharacters.FirstOrDefault(c => c.Id == memberId);
                            if (member != null)
                            {
                                <li class="list-group-item @(member.Id == party.CaptainId ? "list-group-item-primary" : "")">
                                    @member.Name @(member.Id == party.CaptainId ? "(ï¿½Ó³ï¿½)" : "")
                                </li>
                            }
                        }
                    </ul>

                    <!-- ï¿½Ó³ï¿½ï¿½ï¿½ï¿½ï¿½Ñ¡ï¿½ï¿½ï¿½ï¿½ë¸±ï¿½ï¿½ -->
                    @if (party.CaptainId == character.Id)
                    {
                        <div class="dungeon-options mt-4">
                            <h5>ï¿½ï¿½ï¿½Ã¸ï¿½ï¿½ï¿½:</h5>
                            <div class="dungeon-list">
                                @foreach (var dungeon in DungeonTemplates.All.Where(d => CanEnterDungeon(character, party, d)))
                                {
                                    <div class="dungeon-card p-3 border rounded mb-2">
                                        <h6>@dungeon.Name (ï¿½Æ¼ï¿½ï¿½È¼ï¿½: @dungeon.RecommendedLevel)</h6>
                                        <p>@dungeon.Description</p>
                                        <p><small>ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½: @dungeon.MinPlayers-@dungeon.MaxPlayers ï¿½ï¿½</small></p>
                                        <button class="btn btn-primary btn-sm" @onclick="async () => await StartDungeon(dungeon.Id)">
                                            ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        }
    </div>

    <!-- ï¿½ï¿½Ï¸ï¿½ï¿½Ï¢ï¿½ï¿½ï¿½ò£º¸ï¿½ÎªË®Æ½ï¿½ï¿½ï¿½ï¿½ -->
    <div class="details-area d-flex flex-row">
        <!-- ï¿½ï¿½à£ºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô¿ï¿½Æ¬ -->
        <div class="details-card player-details-card flex-grow-1 me-2">
            <h5>@character.Name ï¿½ï¿½ï¿½ï¿½</h5>
            <!-- ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ïµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô¿ï¿½ï¿½ï¿½ -->
            <div class="player-quick-access">
                <div class="quick-slot-section">
                    <h6>Õ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ·</h6>
                    <div class="quick-slots-container">
                        <!-- Ò©Ë®ï¿½ï¿½ï¿½ï¿½ï¿½ -->
                        @for (int i = 0; i < 2; i++)
                        {
                            var slotId = i;
                            <div class="quick-slot" @onclick="() => OpenQuickSlotPicker(ConsumableCategory.Potion, slotId, FoodType.None)" @oncontextmenu:preventDefault @oncontextmenu="() => GameState.ClearQuickSlotItem(ConsumableCategory.Potion, slotId)">
                                @if (character.PotionQuickSlots.TryGetValue(slotId, out var itemId) && !string.IsNullOrEmpty(itemId) && ItemData.GetItemById(itemId) is Consumable item)
                                {
                                    <div class="quick-slot-item @(GetItemCountInInventory(character, itemId) == 0 ? "depleted" : "")" title="@item.Name (@GetItemCountInInventory(character, itemId)) - ï¿½Ò¼ï¿½ï¿½ï¿½ï¿½">
                                        <div class="item-icon">@item.Name.Substring(0, 1)</div>
                                        <span class="item-count">@GetItemCountInInventory(character, itemId)</span>
                                        @if (character.ConsumableCooldowns.GetValueOrDefault(itemId, 0) > 0)
                                        {
                                            <div class="cooldown-overlay"><span>@((int)character.ConsumableCooldowns[itemId])</span></div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="quick-slot-empty" title="ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò©Ë®"></div>
                                }
                            </div>
                        }

                        <!-- Õ½ï¿½ï¿½Ê³ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ -->
                        @for (int i = 0; i < 2; i++)
                        {
                            var slotId = i;
                            <div class="quick-slot" @onclick="() => OpenQuickSlotPicker(ConsumableCategory.Food, slotId, FoodType.Combat)" @oncontextmenu:preventDefault @oncontextmenu="() => GameState.ClearQuickSlotItem(ConsumableCategory.Food, slotId, FoodType.Combat)">
                                @if (character.CombatFoodQuickSlots.TryGetValue(slotId, out var itemId) && !string.IsNullOrEmpty(itemId) && ItemData.GetItemById(itemId) is Consumable item)
                                {
                                    <div class="quick-slot-item @(GetItemCountInInventory(character, itemId) == 0 ? "depleted" : "")" title="@item.Name (@GetItemCountInInventory(character, itemId)) - ï¿½Ò¼ï¿½ï¿½ï¿½ï¿½">
                                        <div class="item-icon">@item.Name.Substring(0, 1)</div>
                                        <span class="item-count">@GetItemCountInInventory(character, itemId)</span>
                                        @if (character.ConsumableCooldowns.GetValueOrDefault(itemId, 0) > 0)
                                        {
                                            <div class="cooldown-overlay"><span>@((int)character.ConsumableCooldowns[itemId])</span></div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="quick-slot-empty" title="ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½Ê³ï¿½ï¿½"></div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
            <hr />
            <div class="player-stats d-flex flex-row flex-wrap">
                <!-- ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ -->
                <div class="stats-section flex-grow-1 me-2 mb-2" style="min-width: 180px; max-width: 48%;">
                    <h6>Õ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</h6>
                    <div class="stat-row">
                        <div class="stat-label">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</div>
                        <div class="stat-value">@CharacterService.GetTotalAttackPower(character)</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">ï¿½ï¿½ï¿½ï¿½Öµ</div>
                        <div class="stat-value">@character.Health/@CharacterService.GetTotalMaxHealth(character)</div>
                    </div>
                    <!-- ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô¿ï¿½Æ¬ï¿½ĞµÄ¹ï¿½ï¿½ï¿½ï¿½Ù¶ï¿½ï¿½ï¿½Ê¾ -->
                    <div class="stat-row">
                        <div class="stat-label">ï¿½ï¿½ï¿½ï¿½ï¿½Ù¶ï¿½</div>
                        <div class="stat-value">@((1 / character.AttacksPerSecond).ToString("F2"))ï¿½ï¿½/ï¿½ï¿½</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</div>
                        <div class="stat-value">@CharacterService.GetTotalAccuracy(character)</div>
                    </div>
                </div>

                <!-- ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ -->
                @{
                    var attributes = CharacterService.GetTotalAttributes(character);
                }
                <div class="stats-section flex-grow-1 ms-2 mb-2" style="min-width: 180px; max-width: 48%;">
                    <h6>ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</h6>
                    <div class="stat-row">
                        <div class="stat-label">ï¿½ï¿½ï¿½ï¿½</div>
                        <div class="stat-value">@attributes.Strength</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">ï¿½ï¿½ï¿½ï¿½</div>
                        <div class="stat-value">@attributes.Agility</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">ï¿½ï¿½ï¿½ï¿½</div>
                        <div class="stat-value">@attributes.Intellect</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">ï¿½ï¿½ï¿½ï¿½</div>
                        <div class="stat-value">@attributes.Spirit</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">ï¿½ï¿½ï¿½ï¿½</div>
                        <div class="stat-value">@attributes.Stamina</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ï¿½Ò²à£ºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô¿ï¿½Æ¬ -->
        <div class="details-card enemy-details-card flex-grow-1 ms-2">
            <h5>@(currentEnemy != null ? currentEnemy.Name : "ï¿½ï¿½ï¿½ï¿½") ï¿½ï¿½ï¿½ï¿½</h5>
            @if (currentEnemy != null || _lastBattleEnemy != null)
            {
                var displayEnemy = currentEnemy ?? _lastBattleEnemy;
                <div class="enemy-stats">
                    <div class="stats-section">
                        <h6>Õ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</h6>
                        <div class="stat-row">
                            <div class="stat-label">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</div>
                            <div class="stat-value">@displayEnemy.AttackPower</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-label">ï¿½ï¿½ï¿½ï¿½Öµ</div>
                            <div class="stat-value">@displayEnemy.Health/@displayEnemy.MaxHealth</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-label">ï¿½ï¿½ï¿½ï¿½ï¿½Ù¶ï¿½</div>
                            <div class="stat-value">@((1 / displayEnemy.AttacksPerSecond).ToString("F2"))ï¿½ï¿½/ï¿½ï¿½</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-label">ï¿½ï¿½ï¿½ĞµÈ¼ï¿½</div>
                            <div class="stat-value">@displayEnemy.AccuracyRating</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-label">ï¿½ï¿½ï¿½ÜµÈ¼ï¿½</div>
                            <div class="stat-value">@displayEnemy.AvoidanceRating</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-label">ï¿½ï¿½ï¿½Ü¼ï¿½ï¿½ï¿½</div>
                            <div class="stat-value">@(displayEnemy.DodgeChance.ToString("P1"))</div>
                        </div>

                        <!-- ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ -->
                        <div class="stat-row">
                            <div class="stat-label">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</div>
                            <div class="stat-value">@(displayEnemy.CriticalChance.ToString("P0"))</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-label">ï¿½ï¿½ï¿½ï¿½ï¿½Ëºï¿½</div>
                            <div class="stat-value">@(displayEnemy.CriticalMultiplier.ToString("P0"))</div>
                        </div>
                    </div>

                    <!-- Ôªï¿½Ø¿ï¿½ï¿½Ô²ï¿½ï¿½Ö£ï¿½ï¿½ï¿½ï¿½ï¿½ĞµÄ»ï¿½ -->
                    @if (displayEnemy.ElementalResistances.Any())
                    {
                        <div class="stats-section">
                            <h6>Ôªï¿½Ø¿ï¿½ï¿½ï¿½</h6>
                            @foreach (var resistance in displayEnemy.ElementalResistances)
                            {
                                <div class="stat-row">
                                    <div class="stat-label">@resistance.Key ï¿½ï¿½ï¿½ï¿½</div>
                                    <div class="stat-value @(resistance.Value < 0 ? "negative" : "positive")">
                                        @(resistance.Value.ToString("P0"))
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <!-- ï¿½ï¿½ï¿½ï¿½Ô­ï¿½ĞµÄ¾ï¿½ï¿½ï¿½Íµï¿½ï¿½ä²¿ï¿½ï¿½ -->
                    <hr />
                    <div class="stat-row">
                        <div class="stat-label">ï¿½ï¿½ï¿½ï¿½Öµ</div>
                        <div class="stat-value">@displayEnemy.XpReward</div>
                    </div>
                    <h6>ï¿½ï¿½ï¿½Üµï¿½ï¿½ï¿½</h6>
                    <div class="loot-table">
                        @foreach (var lootEntry in displayEnemy.LootTable)
                        {
                            var item = ItemData.GetItemById(lootEntry.Key);
                            if (item != null)
                            {
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>@item.Name (@((lootEntry.Value * 100).ToString("F0"))%)</span>
                                    <label class="form-check-label small">
                                        <input type="checkbox" class="form-check-input"
                                               checked="@(character.AutoSellItemIds.Contains(item.Id))"
                                               @onchange="() => GameState.ToggleAutoSellItem(item.Id)" />
                                        ï¿½Ô¶ï¿½ï¿½ï¿½ï¿½ï¿½
                                    </label>
                                </div>
                            }
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="enemy-stats empty-stats">
                    <p class="text-muted">ï¿½ï¿½Ñ¡ï¿½ï¿½ï¿½ï¿½ï¿ªÊ¼Õ½ï¿½ï¿½</p>
                </div>
            }
       </div>
    </div>

    <!-- ï¿½ï¿½ï¿½ï¿½ï¿½Ñ¡ï¿½ï¿½ï¿½ï¿½ -->
    @if (_isPickerVisible)
    {
        <div class="modal-backdrop" @onclick="CloseQuickSlotPicker"></div>
        <div class="quick-slot-picker">
            <h5>Ñ¡ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½Æ·</h5>
            <div class="picker-item-list">
                @foreach (var item in GetAvailableConsumablesForPicker(character))
                {
                    <div class="picker-item" @onclick="() => SetQuickSlot(item.Id)">
                        <span class="picker-item-name">@item.Name</span>
                        <span class="picker-item-count">(x@(GetItemCountInInventory(character, item.Id)))</span>
                    </div>
                }
            </div>
            <button class="btn btn-secondary mt-2" @onclick="CloseQuickSlotPicker">ï¿½Ø±ï¿½</button>
        </div>
    }
}
else
{
    <p>ï¿½ï¿½ï¿½Ú¼ï¿½ï¿½Ø½ï¿½É«ï¿½ï¿½Ï¢...</p>
}

@code {
    // åŒæ¨¡å¼æˆ˜æ–—ç³»ç»Ÿå˜é‡
    private bool _useNewBattleSystem = false;
    private bool _isConnected = false;
    private BattleStateDto? _serverBattleState;
    private System.Threading.Timer? _fallbackPoller;
    
    private bool _showMonsterSelector = false;
    private bool _showDungeonSelector = false;
    private string _selectedRegion = "";
    private string _selectedSubRegion = "";
    private bool _showAccessError = false;
    private string _accessErrorMessage = string.Empty;


    // ï¿½ï¿½ï¿½ï¿½ï¿½Âµï¿½×´Ì¬ï¿½ï¿½ï¿½ï¿½
    private Enemy? _selectedMonster;
    private Dungeon? _selectedDungeon;
    private Enemy? _lastBattleEnemy;
    // Ñ¡ï¿½ï¿½ï¿½ï¿½ï¿½Ä·ï¿½ï¿½ï¿½
    private void SelectMonster(Enemy monster)
    {
        _selectedMonster = monster;
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¼Õ½ï¿½ï¿½ï¿½ï¿½ï¿½È´ï¿½ï¿½ï¿½Òµï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½Å¥
    }

    // Ñ¡ï¿½ñ¸±±ï¿½ï¿½Ä·ï¿½ï¿½ï¿½
    private void SelectDungeon(Dungeon dungeon)
    {
        _selectedDungeon = dungeon;
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È´ï¿½ï¿½ï¿½Òµï¿½ï¿½ï¿½ï¿½Ê¼ï¿½ï¿½Å¥
    }

    // ï¿½Ø±ï¿½Ñ¡ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½Ñ¡ï¿½ï¿½
    private void CloseSelectors()
    {
        _showMonsterSelector = false;
        _showDungeonSelector = false;
        _selectedMonster = null;
        _selectedDungeon = null;
    }

    // ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä±ï¿½
    private string GetMonsterTypeText(MonsterType type)
    {
        return type switch
        {
            MonsterType.Normal => "ï¿½ï¿½Í¨",
            MonsterType.Elite => "ï¿½ï¿½Ó¢",
            MonsterType.Boss => "ï¿½ï¿½ï¿½ï¿½",
            _ => "Î´Öª"
        };
    }

    // ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê½
    private string GetMonsterTypeBadgeClass(MonsterType type)
    {
        return type switch
        {
            MonsterType.Normal => "type-normal",
            MonsterType.Elite => "type-elite",
            MonsterType.Boss => "type-boss",
            _ => ""
        };
    }
    private void ResetNavigation()
    {
        _navigationPath.Clear();
        _showAccessError = false;
        StateHasChanged();
    }

    private void NavigateToPathLevel(int level)
    {
        if (level < _navigationPath.Count)
        {
            _navigationPath = _navigationPath.Take(level).ToList();
            _showAccessError = false;
            StateHasChanged();
        }
    }

    // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½á¹¹
    private class MonsterRegion
    {
        public string Id { get; set; }
        public string Name { get; set; }
        public List<MonsterRegion> SubRegions { get; set; } = new List<MonsterRegion>();
        public List<string> MonsterIds { get; set; } = new List<string>();
    }
    // ï¿½ï¿½ï¿½Ú´æ´¢ï¿½ï¿½Ç°ï¿½ï¿½ï¿½ï¿½Â·ï¿½ï¿½
    private List<string> _navigationPath = new List<string>();

    // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö¸ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
    private void NavigateToRegion(string regionId)
    {
        var region = RegionTemplates.GetById(regionId);
        if (region == null) return;

        _navigationPath.Add(regionId);

        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        if (GameState.ActiveCharacter is Player character)
        {
            var party = GameState.GetPartyForCharacter(character.Id);
            bool canAccess = true;

            if (party != null)
            {
                var partyMembers = party.MemberIds
                    .Select(id => GameState.AllCharacters.FirstOrDefault(c => c.Id == id))
                    .Where(p => p != null)
                    .Cast<Player>()
                    .ToList();

                canAccess = region.CanPartyAccess(party, partyMembers);
            }
            else
            {
                canAccess = region.CanPlayerAccess(character);
            }

            if (!canAccess)
            {
                // ï¿½ï¿½Ê¾ï¿½Ş·ï¿½ï¿½ï¿½ï¿½Êµï¿½ï¿½ï¿½Ï¢
                _accessErrorMessage = region.GetAccessRequirementsDescription();
                _showAccessError = true;
                _navigationPath.RemoveAt(_navigationPath.Count - 1); // ï¿½ï¿½ï¿½Ëµï¿½ï¿½ï¿½
            }
        }

        StateHasChanged();
    }

    // ï¿½ï¿½È¡ï¿½ï¿½Ç°ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
    private Region GetCurrentRegion()
    {
        if (_navigationPath.Count == 0)
            return null;

        return RegionTemplates.GetById(_navigationPath.Last());
    }

    private List<Region> GetCurrentLevelRegions()
    {
        if (_navigationPath.Count == 0)
        {
            return RegionTemplates.GetContinents();
        }

        var currentRegion = RegionTemplates.GetById(_navigationPath.Last());
        return currentRegion?.SubRegionIds
            .Select(id => RegionTemplates.GetById(id))
            .Where(r => r != null)
            .ToList();
    }

    private void ToggleMonsterSelector()
    {
        _showMonsterSelector = !_showMonsterSelector;
        if (_showMonsterSelector) _showDungeonSelector = false;
    }

    private void ToggleDungeonSelector()
    {
        _showDungeonSelector = !_showDungeonSelector;
        if (_showDungeonSelector) _showMonsterSelector = false;
    }

    private void SelectRegion(string regionId)
    {
        _selectedRegion = regionId;
        _selectedSubRegion = "";
    }

    private void SelectSubRegion(string subRegionId)
    {
        _selectedSubRegion = subRegionId;
    }

    private string GetDungeonRequirementText(Player character, Party party, Dungeon dungeon)
    {
        List<string> requirements = new List<string>();

        // ï¿½ï¿½ï¿½È¼ï¿½
        if (CharacterService.GetLevel(character, character.SelectedBattleProfession) < dungeon.RecommendedLevel)
        {
            requirements.Add($"ï¿½ï¿½Òªï¿½È¼ï¿½ {dungeon.RecommendedLevel}+");
        }

        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        int memberCount = party?.MemberIds.Count ?? 0;
        if (memberCount < dungeon.MinPlayers)
        {
            requirements.Add($"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Òª {dungeon.MinPlayers} ï¿½ï¿½");
        }
        else if (memberCount > dungeon.MaxPlayers)
        {
            requirements.Add($"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ {dungeon.MaxPlayers} ï¿½ï¿½");
        }

        // ï¿½ï¿½ï¿½ï¿½È¾ï¿½ï¿½ï¿½ï¿½ï¿½
        foreach (var prerequisite in dungeon.Prerequisites)
        {
            var prereqDungeon = DungeonTemplates.GetDungeonById(prerequisite);
            if (prereqDungeon != null)
            {
                requirements.Add($"ï¿½ï¿½Òªï¿½ï¿½ï¿½ {prereqDungeon.Name}");
            }
        }

        return string.Join(", ", requirements);
    }

    private bool _isPickerVisible = false;
    private int _managingSlotId;
    private ConsumableCategory _managingCategory;
    private FoodType _managingFoodType;
    private enum BattleView { Battle, Party }
    private BattleView _currentView = BattleView.Battle;

    // ï¿½ï¿½È¡CombatServiceÊµï¿½ï¿½
    private CombatService? _combatService;

    // æ›´æ–°OnInitializedæ–¹æ³•ä»¥æ”¯æŒåŒæ¨¡å¼
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ä»é…ç½®è¯»å–æ˜¯å¦ä½¿ç”¨æ–°ç³»ç»Ÿ
            _useNewBattleSystem = Configuration.GetValue<bool>("Features:UseServerBattle", false);
            
            if (_useNewBattleSystem)
            {
                // åˆå§‹åŒ–æ–°ç³»ç»Ÿ
                await InitializeNewSystem();
            }
            else
            {
                // ä½¿ç”¨æ—§ç³»ç»Ÿ
                InitializeOldSystem();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "åˆå§‹åŒ–æˆ˜æ–—é¡µé¢æ—¶å‡ºé”™");
        }
    }
    
    /// <summary>
    /// åˆå§‹åŒ–æ–°çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨ç³»ç»Ÿ
    /// </summary>
    private async Task InitializeNewSystem()
    {
        // è®¢é˜…äº‹ä»¶
        NewGameState.OnBattleStateChanged += HandleNewBattleUpdate;
        NewGameState.OnConnectionStatusChanged += HandleConnectionChanged;
        OfflineService.OnOfflineModeChanged += HandleOfflineModeChanged;
        
        try
        {
            // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
            await NewGameState.InitializeAsync();
            _isConnected = true; // å‡è®¾åˆå§‹åŒ–æˆåŠŸè¡¨ç¤ºè¿æ¥æˆåŠŸ
            
            Logger.LogInformation("æ–°æˆ˜æ–—ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "æ–°æˆ˜æ–—ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥");
            _isConnected = false;
        }
    }
    
    /// <summary>
    /// åˆå§‹åŒ–æ—§çš„æœ¬åœ°ç³»ç»Ÿ
    /// </summary>
    private void InitializeOldSystem()
    {
        GameState.OnStateChanged += HandleStateChanged;
        _combatService = ServiceLocator.GetService<CombatService>();
        
        Logger.LogInformation("æœ¬åœ°æˆ˜æ–—ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ");
    }

    // ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½Õ½ï¿½ï¿½Ë¢ï¿½ï¿½×´Ì¬
    private bool IsInBattleRefresh(string playerId)
    {
        return _combatService?.IsPlayerInBattleRefresh(playerId) ?? false;
    }

    /// <summary>
    /// ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½Ú¸ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½
    /// </summary>
    private bool IsInDungeonBattle(BattleContext? battleContext)
    {
        return battleContext != null && battleContext.BattleType == BattleTypeLocal.Dungeon;
    }

    // ï¿½ï¿½È¡Õ½ï¿½ï¿½Ë¢ï¿½Âµï¿½ï¿½ï¿½Ê±
    private double GetBattleRefreshTime(string playerId)
    {
        return _combatService?.GetPlayerBattleRefreshTime(playerId) ?? 0;
    }

    /// <summary>
    /// è·å–ç»Ÿä¸€çš„æˆ˜æ–—æ¨¡å¼æ–‡æœ¬
    /// </summary>
    private string GetUnifiedBattleModeText(BattleContext? battleContext, BattleStateDto? serverBattleState)
    {
        if (_useNewBattleSystem && serverBattleState != null)
        {
            return serverBattleState.BattleType switch
            {
                BattleTypeServer.Dungeon => $"æœåŠ¡å™¨å‰¯æœ¬æˆ˜æ–— (Battle ID: {serverBattleState.BattleId.ToString()[..8]})",
                _ => $"æœåŠ¡å™¨æ™®é€šæˆ˜æ–— (Battle ID: {serverBattleState.BattleId.ToString()[..8]})"
            };
        }
        else if (battleContext != null)
        {
            return GetBattleModeText(battleContext);
        }
        
        return "æœªçŸ¥æˆ˜æ–—çŠ¶æ€";
    }
    
    /// <summary>
    /// æ‰§è¡Œåœ¨çº¿æˆ˜æ–—åŠ¨ä½œï¼ˆå¦‚ä½¿ç”¨æŠ€èƒ½ã€æ™®é€šæ”»å‡»ç­‰ï¼‰
    /// </summary>
    private async Task ExecuteOnlineBattleAction(BattleActionType actionType, string? targetId = null, string? skillId = null)
    {
        if (!_useNewBattleSystem || _serverBattleState == null || !_serverBattleState.IsActive)
        {
            Logger.LogWarning("æ— æ³•æ‰§è¡Œåœ¨çº¿æˆ˜æ–—åŠ¨ä½œï¼šç³»ç»Ÿæœªä½¿ç”¨æ–°æ¨¡å¼æˆ–æ²¡æœ‰æ´»è·ƒæˆ˜æ–—");
            return;
        }
        
        var character = GameState.ActiveCharacter;
        if (character == null) return;
        
        try
        {
            if (OfflineService.IsOfflineMode)
            {
                Logger.LogInformation("ç¦»çº¿æ¨¡å¼ï¼šè®°å½•æˆ˜æ–—åŠ¨ä½œ");
                // åœ¨ç¦»çº¿æ¨¡å¼ä¸‹è®°å½•åŠ¨ä½œ
                // TODO: å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç¦»çº¿åŠ¨ä½œè®°å½•é€»è¾‘
                return;
            }
            
            // ç¡®ä¿è®¤è¯æœ‰æ•ˆ
            var authResult = await GameApi.SetupAuthenticationAsync();
            if (!authResult.StartsWith("âœ…"))
            {
                Logger.LogWarning("âš ï¸ è®¤è¯å¤±è´¥ï¼Œæ— æ³•æ‰§è¡Œæˆ˜æ–—åŠ¨ä½œ");
                await OfflineService.EnterOfflineMode();
                return;
            }
            
            Logger.LogInformation($"ğŸ¯ æ­£åœ¨æ‰§è¡Œæˆ˜æ–—åŠ¨ä½œ: {actionType}");
            var success = await NewGameState.ExecuteBattleActionAsync(
                _serverBattleState.BattleId, 
                character.Id, 
                actionType, 
                targetId, 
                skillId);
                
            if (success)
            {
                Logger.LogInformation($"âœ… æˆ˜æ–—åŠ¨ä½œæ‰§è¡ŒæˆåŠŸ: {actionType}");
            }
            else
            {
                Logger.LogWarning($"âŒ æˆ˜æ–—åŠ¨ä½œæ‰§è¡Œå¤±è´¥: {actionType}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"æ‰§è¡Œæˆ˜æ–—åŠ¨ä½œæ—¶å‡ºé”™: {actionType}");
        }
    }
    
    /// <summary>
    /// ä½¿ç”¨æŠ€èƒ½ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    /// </summary>
    private async Task UseSkillIfAvailable(string skillId, bool isOnCooldown)
    {
        if (isOnCooldown)
        {
            Logger.LogInformation($"æŠ€èƒ½ {skillId} è¿˜åœ¨å†·å´ä¸­");
            return;
        }
        
        var currentEnemy = GetCurrentEnemy(GameState.ActiveCharacter, GetUnifiedBattleContext(GameState.ActiveCharacter?.Id));
        var targetId = currentEnemy?.Name; // ä½¿ç”¨å½“å‰æ•Œäººä½œä¸ºç›®æ ‡
        
        await UseSkill(skillId, targetId);
    }
    
    /// <summary>
    /// ä½¿ç”¨æŠ€èƒ½ - ç»Ÿä¸€æ–¹æ³•æ”¯æŒåœ¨çº¿å’Œç¦»çº¿æ¨¡å¼
    /// </summary>
    private async Task UseSkill(string skillId, string? targetId = null)
    {
        if (_useNewBattleSystem)
        {
            await ExecuteOnlineBattleAction(BattleActionType.UseSkill, targetId, skillId);
        }
        else
        {
            // æ—§ç³»ç»Ÿï¼šç›´æ¥ä½¿ç”¨æœ¬åœ°æŠ€èƒ½ç³»ç»Ÿ
            // è¿™é‡Œéœ€è¦è°ƒç”¨åŸæœ‰çš„æŠ€èƒ½ä½¿ç”¨é€»è¾‘
            var character = GameState.ActiveCharacter;
            if (character != null)
            {
                // TODO: è°ƒç”¨åŸæœ‰çš„æŠ€èƒ½ç³»ç»Ÿé€»è¾‘
                Logger.LogInformation($"æœ¬åœ°æ¨¡å¼ï¼šä½¿ç”¨æŠ€èƒ½ {skillId}");
            }
        }
    }
    
    /// <summary>
    /// åˆ‡æ¢æ”»å‡»ç›®æ ‡ - åœ¨çº¿æ¨¡å¼æ”¯æŒ
    /// </summary>
    private async Task SetOnlineBattleTarget(string targetId)
    {
        if (_useNewBattleSystem && _serverBattleState != null)
        {
            await ExecuteOnlineBattleAction(BattleActionType.SwitchTarget, targetId);
        }
    }

    /// <summary>
    /// ç»Ÿä¸€çš„åœæ­¢æˆ˜æ–—æ–¹æ³•
    /// </summary>
    private async Task StopUnifiedBattle()
    {
        try
        {
            if (_useNewBattleSystem && _serverBattleState != null)
            {
                // æ–°ç³»ç»Ÿï¼šè°ƒç”¨æœåŠ¡å™¨APIåœæ­¢æˆ˜æ–—
                var success = await NewGameState.StopBattleAsync(_serverBattleState.BattleId);
                if (success)
                {
                    _serverBattleState = null;
                }
                else
                {
                    Logger.LogWarning("æœåŠ¡å™¨åœæ­¢æˆ˜æ–—å¤±è´¥");
                }
            }
            else
            {
                // æ—§ç³»ç»Ÿï¼šä½¿ç”¨æœ¬åœ°æ–¹æ³•
                GameState.StopCurrentAction();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "åœæ­¢æˆ˜æ–—æ—¶å‡ºé”™");
        }
    }

    // ï¿½ï¿½È¡Õ½ï¿½ï¿½Ä£Ê½ï¿½Ä±ï¿½
    private string GetBattleModeText(BattleContext battleContext)
    {
        return battleContext.BattleType switch
        {
            BattleTypeLocal.Dungeon => $"ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ - {GetDungeonName(battleContext.DungeonId)}",
            BattleTypeLocal.Party => $"ï¿½Å¶ï¿½Õ½ï¿½ï¿½ ({battleContext.Players.Count}v{battleContext.Enemies.Count})",
            _ => $"ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ (1v{battleContext.Enemies.Count})"
        };
    }

    /// <summary>
    /// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç°ï¿½ï¿½Í£Ö¹ï¿½ï¿½Ç°Õ½ï¿½ï¿½
    /// </summary>
    private void CreatePartyAndStopBattle()
    {
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½Ğ£ï¿½ï¿½ï¿½Í£Ö¹Õ½ï¿½ï¿½
        if (GameState.ActiveCharacter?.CurrentAction == PlayerActionState.Combat)
        {
            GameState.StopCurrentAction();
        }

        // È»ï¿½ó´´½ï¿½ï¿½ï¿½ï¿½ï¿½
        GameState.CreateParty();
    }

    /// <summary>
    /// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç°ï¿½ï¿½Í£Ö¹ï¿½ï¿½Ç°Õ½ï¿½ï¿½
    /// </summary>
    private void JoinPartyAndStopBattle(Guid partyId)
    {
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½Ğ£ï¿½ï¿½ï¿½Í£Ö¹Õ½ï¿½ï¿½
        if (GameState.ActiveCharacter?.CurrentAction == PlayerActionState.Combat)
        {
            GameState.StopCurrentAction();
        }

        // È»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        GameState.JoinParty(partyId);
    }

    // ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½Ã¹ï¿½ï¿½ï¿½
    private bool IsCurrentlyFightingMonster(string monsterName, BattleContext? battleContext)
    {
        // ï¿½Ú¸ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½Ğ£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¾ï¿½ÎºÎ¹ï¿½ï¿½ï°´Å¥
        if (battleContext == null || battleContext.BattleType == BattleTypeLocal.Dungeon)
            return false;

        // Ö»ï¿½ï¿½ï¿½ï¿½Í¨Õ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½Ğ¸ï¿½ï¿½ï¿½ï¿½ï¿½Ê¾ï¿½ï¿½Ó¦ï¿½Ä¹ï¿½ï¿½ï°´Å¥
        return battleContext.Enemies.Any(e => e.Name == monsterName);
    }

    private double GetHealthPercentage(int current, int max)
    {
        if (max <= 0) return 0;
        return (double)Math.Max(0, current) / max * 100;
    }

    private double GetAttackProgress(double currentCooldown, double attacksPerSecond)
    {
        if (attacksPerSecond <= 0) return 0;
        var totalCooldown = 1.0 / attacksPerSecond;
        var progress = (totalCooldown - currentCooldown) / totalCooldown;
        return Math.Clamp(progress * 100, 0, 100);
    }

    private Enemy? GetCurrentEnemy(Player character, BattleContext? battleContext)
    {
        if (battleContext == null || !battleContext.Enemies.Any())
            return null;

        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½Ö¸ï¿½ï¿½Ä¿ï¿½ï¿½
        if (battleContext.PlayerTargets.TryGetValue(character.Id, out var targetName))
        {
            var target = battleContext.Enemies.FirstOrDefault(e => e.Name == targetName);
            if (target != null)
            {
                _lastBattleEnemy = target; // ï¿½ï¿½ï¿½æµ±Ç°ï¿½ï¿½ï¿½ï¿½
                return target;
            }
        }

        // Ä¬ï¿½Ï·ï¿½ï¿½Øµï¿½Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        var firstEnemy = battleContext.Enemies.First();
        _lastBattleEnemy = firstEnemy; // ï¿½ï¿½ï¿½æµ±Ç°ï¿½ï¿½ï¿½ï¿½
        return firstEnemy;
    }

    /// <summary>
    /// ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½Ê¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ÏµÍ³
    /// </summary>
    private void StartBattle(Enemy enemyTemplate)
    {
        if (GameState.ActiveCharacter == null || _combatService == null)
            return;

        // ï¿½ï¿½È¡ï¿½ï¿½Ç°ï¿½ï¿½ï¿½
        var character = GameState.ActiveCharacter;

        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½Ğ£ï¿½ï¿½ï¿½Ô¾Õ½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½Ë¢ï¿½ï¿½×´Ì¬ï¿½ï¿½
        var battleContext = _combatService.GetBattleContextForPlayer(character.Id);
        var isInBattleRefresh = _combatService.IsPlayerInBattleRefresh(character.Id);

        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í£Ö¹ï¿½ï¿½Ç°Õ½ï¿½ï¿½
        if (battleContext != null || isInBattleRefresh || character.CurrentAction == PlayerActionState.Combat)
        {
            GameState.StopCurrentAction();
        }

        var party = GameState.GetPartyForCharacter(character.Id);

        // Ê¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ÏµÍ³ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ignoreRefreshCheck=trueï¿½ï¿½È·ï¿½ï¿½ï¿½ï¿½Ê¹ï¿½ï¿½Ë¢ï¿½ï¿½×´Ì¬Ò²ï¿½Ü¿ï¿½Ê¼Õ½ï¿½ï¿½
        bool battleStarted = _combatService.SmartStartBattle(character, enemyTemplate, party, true);

        // ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½É¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ø±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        if (battleStarted)
        {
            CloseSelectors();
        }
    }

    /// <summary>
    /// æ–°ç³»ç»Ÿæˆ˜æ–—å¯åŠ¨
    /// </summary>
    private async Task StartBattleNewSystem(Enemy enemyTemplate)
    {
        var character = GameState.ActiveCharacter;
        if (character == null) return;
        
        try
        {
            if (OfflineService.IsOfflineMode)
            {
                // ç¦»çº¿æ¨¡å¼ï¼šè®°å½•æ“ä½œå¹¶æœ¬åœ°æ¨¡æ‹Ÿ
                OfflineService.RecordOfflineAction(OfflineActionType.StartBattle, new StartBattleRequest
                {
                    CharacterId = character.Id,
                    EnemyId = enemyTemplate.Name, // Enemyåªæœ‰Nameå±æ€§ï¼Œæ²¡æœ‰Id
                    PartyId = GetCurrentPartyId()
                });
                
                // æœ¬åœ°æ¨¡æ‹Ÿæˆ˜æ–—  
                _serverBattleState = OfflineService.SimulateLocalBattle(character.Id, enemyTemplate.Name, GetCurrentPartyId());
            }
            else
            {
                // åœ¨çº¿æ¨¡å¼ï¼šé¦–å…ˆè®¾ç½®è®¤è¯
                Logger.LogInformation("ğŸ” æ­£åœ¨è®¾ç½®è®¤è¯...");
                var authResult = await GameApi.SetupAuthenticationAsync();
                Logger.LogInformation($"è®¤è¯ç»“æœ: {authResult}");
                
                if (!authResult.StartsWith("âœ…"))
                {
                    Logger.LogWarning("âš ï¸ è®¤è¯å¤±è´¥ï¼Œæ— æ³•è¿›è¡Œåœ¨çº¿æˆ˜æ–—");
                    await OfflineService.EnterOfflineMode();
                    _serverBattleState = OfflineService.SimulateLocalBattle(character.Id, enemyTemplate.Name, GetCurrentPartyId());
                    return;
                }
                
                // è®¤è¯æˆåŠŸï¼Œå¼€å§‹åœ¨çº¿æˆ˜æ–—
                Logger.LogInformation("âš”ï¸ æ­£åœ¨å¼€å§‹åœ¨çº¿æˆ˜æ–—...");
                var request = new StartBattleRequest
                {
                    CharacterId = character.Id,
                    EnemyId = enemyTemplate.Name,
                    PartyId = GetCurrentPartyId()
                };
                
                var result = await GameApi.StartBattleAsync(request);
                if (result.Success && result.Data != null)
                {
                    Logger.LogInformation($"âœ… åœ¨çº¿æˆ˜æ–—å¼€å§‹æˆåŠŸ: æˆ˜æ–—ID {result.Data.BattleId}");
                    _serverBattleState = result.Data;
                    
                    // ç¡®ä¿åŠ å…¥SignalRç»„ä»¥æ¥æ”¶å®æ—¶æ›´æ–°
                    await NewGameState.StartBattleAsync(enemyTemplate.Name, GetCurrentPartyId());
                }
                else
                {
                    Logger.LogWarning($"âŒ åœ¨çº¿æˆ˜æ–—å¼€å§‹å¤±è´¥: {result.Message}");
                    await OfflineService.EnterOfflineMode();
                    _serverBattleState = OfflineService.SimulateLocalBattle(character.Id, enemyTemplate.Name, GetCurrentPartyId());
                }
            }
            
            CloseSelectors();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "æ–°ç³»ç»Ÿæˆ˜æ–—å¯åŠ¨å¤±è´¥");
            // å›é€€åˆ°ç¦»çº¿æ¨¡å¼
            await OfflineService.EnterOfflineMode();
            _serverBattleState = OfflineService.SimulateLocalBattle(character.Id, enemyTemplate.Name, GetCurrentPartyId());
        }
    }
    
    /// <summary>
    /// è·å–ç»Ÿä¸€çš„æˆ˜æ–—ä¸Šä¸‹æ–‡ - æ ¹æ®æ¨¡å¼è¿”å›ç›¸åº”çš„æˆ˜æ–—çŠ¶æ€
    /// </summary>
    private BattleContext? GetUnifiedBattleContext(string playerId)
    {
        if (_useNewBattleSystem)
        {
            // æ–°ç³»ç»Ÿï¼šä»æœåŠ¡å™¨æˆ˜æ–—çŠ¶æ€è½¬æ¢ä¸ºæœ¬åœ°æˆ˜æ–—ä¸Šä¸‹æ–‡ï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰
            if (_serverBattleState != null && _serverBattleState.IsActive)
            {
                return ConvertServerBattleToContext(_serverBattleState, playerId);
            }
            return null;
        }
        else
        {
            // æ—§ç³»ç»Ÿï¼šç›´æ¥ä½¿ç”¨æœ¬åœ°æˆ˜æ–—ä¸Šä¸‹æ–‡
            return _combatService?.GetBattleContextForPlayer(playerId);
        }
    }
    
    /// <summary>
    /// å°†æœåŠ¡å™¨æˆ˜æ–—çŠ¶æ€è½¬æ¢ä¸ºæœ¬åœ°æˆ˜æ–—ä¸Šä¸‹æ–‡ï¼ˆç”¨äºUIæ˜¾ç¤ºå…¼å®¹ï¼‰
    /// </summary>
    private BattleContext? ConvertServerBattleToContext(BattleStateDto serverState, string playerId)
    {
        try
        {
            // åˆ›å»ºæ¨¡æ‹Ÿçš„æœ¬åœ°æˆ˜æ–—ä¸Šä¸‹æ–‡ç”¨äºUIæ˜¾ç¤º
            var context = new BattleContext
            {
                BattleType = serverState.BattleType switch
                {
                    BattleTypeServer.Dungeon => BattleTypeLocal.Dungeon,
                    _ => BattleTypeLocal.Solo
                },
                DungeonId = serverState.PartyId, // ä¸´æ—¶ä½¿ç”¨
                WaveNumber = 1
            };
            
            // æ·»åŠ ç©å®¶ï¼ˆç®€åŒ–å¤„ç†ï¼Œåªæ·»åŠ å½“å‰è§’è‰²ï¼‰
            var player = GameState.ActiveCharacter;
            if (player != null)
            {
                context.Players.Add(player);
            }
            
            // æ·»åŠ æ•Œäººï¼ˆä»æœåŠ¡å™¨çŠ¶æ€æ¨¡æ‹Ÿï¼‰
            if (!string.IsNullOrEmpty(serverState.EnemyId))
            {
                // ç®€åŒ–çš„æ•Œäººåˆ›å»ºï¼Œå› ä¸ºMonsterTemplates.GetByIdä¸å­˜åœ¨
                var enemy = new Enemy
                {
                    Name = $"æ•Œäºº-{serverState.EnemyId}",
                    Health = serverState.EnemyHealth,
                    MaxHealth = serverState.EnemyMaxHealth,
                    Level = 1,
                    AttacksPerSecond = 1.0,
                    SkillIds = new List<string>(),
                    EnemyAttackCooldown = 0,
                    SkillCooldowns = new Dictionary<string, int>()
                };
                context.Enemies.Add(enemy);
            }
            
            return context;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "è½¬æ¢æœåŠ¡å™¨æˆ˜æ–—çŠ¶æ€æ—¶å‡ºé”™");
            return null;
        }
    }

    /// <summary>
    /// ç»Ÿä¸€çš„æˆ˜æ–—å¯åŠ¨æ–¹æ³• - æ ¹æ®æ¨¡å¼è°ƒç”¨ä¸åŒçš„ç³»ç»Ÿ
    /// </summary>
    private async Task StartBattleUnified(Enemy enemyTemplate)
    {
        if (_useNewBattleSystem)
        {
            await StartBattleNewSystem(enemyTemplate);
        }
        else
        {
            StartBattle(enemyTemplate);
        }
    }
    
    /// <summary>
    /// åˆ‡æ¢æˆ˜æ–—ç³»ç»Ÿæ¨¡å¼
    /// </summary>
    private async Task ToggleBattleSystem(bool useNewSystem)
    {
        if (_useNewBattleSystem == useNewSystem) return;
        
        try
        {
            // åœæ­¢å½“å‰æˆ˜æ–—
            if (GameState.ActiveCharacter?.CurrentAction == PlayerActionState.Combat)
            {
                GameState.StopCurrentAction();
            }
            
            // æ¸…ç†æ—§ç³»ç»Ÿçš„äº‹ä»¶è®¢é˜…
            if (_useNewBattleSystem)
            {
                NewGameState.OnBattleStateChanged -= HandleNewBattleUpdate;
                NewGameState.OnConnectionStatusChanged -= HandleConnectionChanged;
                OfflineService.OnOfflineModeChanged -= HandleOfflineModeChanged;
            }
            else
            {
                GameState.OnStateChanged -= HandleStateChanged;
            }
            
            _useNewBattleSystem = useNewSystem;
            
            // åˆå§‹åŒ–æ–°ç³»ç»Ÿ
            if (_useNewBattleSystem)
            {
                await InitializeNewSystem();
            }
            else
            {
                InitializeOldSystem();
            }
            
            Logger.LogInformation("æˆ˜æ–—ç³»ç»Ÿå·²åˆ‡æ¢åˆ° {SystemType}", _useNewBattleSystem ? "æœåŠ¡å™¨æ¨¡å¼" : "æœ¬åœ°æ¨¡å¼");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "åˆ‡æ¢æˆ˜æ–—ç³»ç»Ÿæ—¶å‡ºé”™");
        }
    }
    
    /// <summary>
    /// è·å–å½“å‰é˜Ÿä¼ID
    /// </summary>
    private string? GetCurrentPartyId()
    {
        var character = GameState.ActiveCharacter;
        if (character == null) return null;
        
        var party = GameState.GetPartyForCharacter(character.Id);
        return party?.Id.ToString();
    }

    /// <summary>
    /// è®¾ç½®ç©å®¶çš„ç›®æ ‡æ•Œäºº - ç»Ÿä¸€æ–¹æ³•æ”¯æŒåœ¨çº¿å’Œç¦»çº¿æ¨¡å¼
    /// </summary>
    private async Task SetPlayerTargetUnified(string playerId, Enemy enemy, BattleContext battleContext)
    {
        if (_useNewBattleSystem)
        {
            // åœ¨çº¿æ¨¡å¼ï¼šå‘é€ç›®æ ‡åˆ‡æ¢åˆ°æœåŠ¡å™¨
            await SetOnlineBattleTarget(enemy.Name);
        }
        else
        {
            // ç¦»çº¿æ¨¡å¼ï¼šç›´æ¥è®¾ç½®æœ¬åœ°ç›®æ ‡
            SetPlayerTarget(playerId, enemy, battleContext);
        }
    }

    /// <summary>
    /// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Òµï¿½Ä¿ï¿½ï¿½ï¿½ï¿½ï¿½
    /// </summary>
    private void SetPlayerTarget(string playerId, Enemy enemy, BattleContext battleContext)
    {
        battleContext.PlayerTargets[playerId] = enemy.Name;
    }

    /// <summary>
    /// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½ï¿½ï¿½ÒµÄµï¿½Ç°Ä¿ï¿½ï¿½
    /// </summary>
    private bool IsPlayerTarget(string playerId, Enemy enemy, BattleContext battleContext)
    {
        return battleContext.PlayerTargets.TryGetValue(playerId, out var targetName) && targetName == enemy.Name;
    }

    /// <summary>
    /// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ - Ö§ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ßºï¿½ï¿½ï¿½ï¿½Ä£Ê½
    /// </summary>
    private async Task StartDungeon(string dungeonId)
    {
        var party = GameState.GetPartyForCharacter(GameState.ActiveCharacter?.Id);
        if (party == null)
        {
            Logger.LogWarning("æ— æ³•å¼€å§‹å‰¯æœ¬ï¼šæ²¡æœ‰é˜Ÿä¼");
            return;
        }
            
        if (_useNewBattleSystem)
        {
            await StartDungeonOnline(dungeonId, party);
        }
        else
        {
            StartDungeonOffline(dungeonId, party);
        }
    }
    
    /// <summary>
    /// åœ¨çº¿å‰¯æœ¬æˆ˜æ–—å¯åŠ¨
    /// </summary>
    private async Task StartDungeonOnline(string dungeonId, Party party)
    {
        try
        {
            if (OfflineService.IsOfflineMode)
            {
                Logger.LogInformation("ç¦»çº¿æ¨¡å¼ï¼šè®°å½•å‰¯æœ¬å¼€å§‹æ“ä½œ");
                // åœ¨ç¦»çº¿æ¨¡å¼ä¸‹è®°å½•å‰¯æœ¬æ“ä½œ
                OfflineService.RecordOfflineAction(OfflineActionType.StartBattle, new StartBattleRequest
                {
                    CharacterId = GameState.ActiveCharacter?.Id ?? "",
                    EnemyId = $"dungeon:{dungeonId}",
                    PartyId = party.Id.ToString()
                });
                
                // æœ¬åœ°æ¨¡æ‹Ÿå‰¯æœ¬æˆ˜æ–—
                _serverBattleState = OfflineService.SimulateLocalBattle(
                    GameState.ActiveCharacter?.Id ?? "", 
                    $"dungeon:{dungeonId}", 
                    party.Id.ToString());
            }
            else
            {
                // åœ¨çº¿æ¨¡å¼ï¼šé¦–å…ˆè®¾ç½®è®¤è¯
                Logger.LogInformation("ğŸ” æ­£åœ¨è®¾ç½®è®¤è¯...");
                var authResult = await GameApi.SetupAuthenticationAsync();
                Logger.LogInformation($"è®¤è¯ç»“æœ: {authResult}");
                
                if (!authResult.StartsWith("âœ…"))
                {
                    Logger.LogWarning("âš ï¸ è®¤è¯å¤±è´¥ï¼Œæ— æ³•è¿›è¡Œåœ¨çº¿å‰¯æœ¬æˆ˜æ–—");
                    await OfflineService.EnterOfflineMode();
                    return;
                }
                
                // è®¤è¯æˆåŠŸï¼Œå¼€å§‹åœ¨çº¿å‰¯æœ¬æˆ˜æ–—
                Logger.LogInformation("ğŸ° æ­£åœ¨å¼€å§‹åœ¨çº¿å‰¯æœ¬æˆ˜æ–—...");
                var request = new StartBattleRequest
                {
                    CharacterId = GameState.ActiveCharacter?.Id ?? "",
                    EnemyId = $"dungeon:{dungeonId}",
                    PartyId = party.Id.ToString()
                };
                
                var result = await GameApi.StartBattleAsync(request);
                if (result.Success && result.Data != null)
                {
                    Logger.LogInformation($"âœ… åœ¨çº¿å‰¯æœ¬æˆ˜æ–—å¼€å§‹æˆåŠŸ: æˆ˜æ–—ID {result.Data.BattleId}");
                    _serverBattleState = result.Data;
                    
                    // ç¡®ä¿åŠ å…¥SignalRç»„ä»¥æ¥æ”¶å®æ—¶æ›´æ–°
                    await NewGameState.StartBattleAsync($"dungeon:{dungeonId}", party.Id.ToString());
                }
                else
                {
                    Logger.LogWarning($"âŒ åœ¨çº¿å‰¯æœ¬æˆ˜æ–—å¼€å§‹å¤±è´¥: {result.Message}");
                    await OfflineService.EnterOfflineMode();
                }
            }
            
            CloseSelectors();
            _currentView = BattleView.Battle;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "åœ¨çº¿å‰¯æœ¬æˆ˜æ–—å¯åŠ¨å¤±è´¥");
            await OfflineService.EnterOfflineMode();
        }
    }
    
    /// <summary>
    /// ç¦»çº¿å‰¯æœ¬æˆ˜æ–—å¯åŠ¨ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
    /// </summary>
    private void StartDungeonOffline(string dungeonId, Party party)
    {
        if (_combatService != null)
        {
            bool dungeonStarted = _combatService.StartDungeon(party, dungeonId);

            // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½É¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ø±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ğ»ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½Í¼
            if (dungeonStarted)
            {
                CloseSelectors();
                _currentView = BattleView.Battle;
            }
        }
    }

    /// <summary>
    /// ï¿½ë¿ªï¿½ï¿½ï¿½ï¿½Ç°ï¿½ï¿½Í£Ö¹ï¿½ï¿½Ç°Õ½ï¿½ï¿½
    /// </summary>
    private void LeavePartyAndStopBattle()
    {
        var party = GameState.GetPartyForCharacter(GameState.ActiveCharacter?.Id);
        if (party != null)
        {
            // ï¿½ï¿½ï¿½ï¿½Ç¶ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í£Ö¹ï¿½ï¿½ï¿½Ğ³ï¿½Ô±ï¿½ï¿½Õ½ï¿½ï¿½
            var battleContext = _combatService?.GetBattleContextForParty(party.Id);
            if (battleContext != null)
            {
                GameState.StopCurrentAction();
            }
        }

        // È»ï¿½ï¿½ï¿½ë¿ªï¿½ï¿½ï¿½ï¿½
        GameState.LeaveParty();
    }

    /// <summary>
    /// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½ï¿½ÎºÎ³ï¿½Ô±ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½
    /// </summary>
    private bool IsPartyInBattle(Party party)
    {
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        if (_combatService?.GetBattleContextForParty(party.Id) != null)
        {
            return true;
        }

        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ğµï¿½Ã¿ï¿½ï¿½ï¿½ï¿½Ô±ï¿½Ç·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½
        foreach (var memberId in party.MemberIds)
        {
            var member = GameState.AllCharacters.FirstOrDefault(c => c.Id == memberId);
            if (member != null && member.CurrentAction == PlayerActionState.Combat)
            {
                return true;
            }
        }

        return false;
    }

    /// <summary>
    /// ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½Ô½ï¿½ï¿½ë¸±ï¿½ï¿½
    /// </summary>
    private bool CanEnterDungeon(Player character, Party party, Dungeon dungeon)
    {
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        var memberCount = party.MemberIds.Count;
        if (memberCount < dungeon.MinPlayers || memberCount > dungeon.MaxPlayers)
            return false;

        // ï¿½ï¿½ï¿½Ó³ï¿½ï¿½È¼ï¿½
        if (CharacterService.GetLevel(character, character.SelectedBattleProfession) < dungeon.RecommendedLevel)
            return false;

        // ï¿½ï¿½ï¿½ï¿½È¾ï¿½ï¿½ï¿½ï¿½ï¿½
        foreach (var prerequisite in dungeon.Prerequisites)
        {
            // if (!character.CompletedDungeons.Contains(prerequisite))
            //     return false;
        }

        return true;
    }

    /// <summary>
    /// ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
    /// </summary>
    private string GetDungeonName(string? dungeonId)
    {
        if (string.IsNullOrEmpty(dungeonId))
            return "Î´Öªï¿½ï¿½ï¿½ï¿½";

        var dungeon = DungeonTemplates.GetDungeonById(dungeonId);
        return dungeon?.Name ?? "Î´Öªï¿½ï¿½ï¿½ï¿½";
    }

    private void OpenQuickSlotPicker(ConsumableCategory category, int slotId, FoodType foodType)
    {
        _managingCategory = category;
        _managingSlotId = slotId;
        _managingFoodType = foodType;
        _isPickerVisible = true;
    }

    private void CloseQuickSlotPicker()
    {
        _isPickerVisible = false;
    }

    private void SetQuickSlot(string itemId)
    {
        GameState.SetQuickSlotItem(_managingCategory, _managingSlotId, itemId);
        CloseQuickSlotPicker();
    }

    private List<Consumable> GetAvailableConsumablesForPicker(Player character)
    {
        var itemIdsInInventory = character.Inventory
            .Where(s => !s.IsEmpty && s.ItemId != null)
            .Select(s => s.ItemId!)
            .ToHashSet();

        var query = ItemData.AllItems.OfType<Consumable>();

        if (_managingCategory == ConsumableCategory.Food)
        {
            query = query.Where(c => c.FoodType == _managingFoodType);
        }
        else
        {
            query = query.Where(c => c.Category == _managingCategory);
        }

        return query.Where(c => itemIdsInInventory.Contains(c.Id)).ToList();
    }

    private int GetItemCountInInventory(Player character, string itemId)
    {
        return character.Inventory.Where(s => s.ItemId == itemId).Sum(s => s.Quantity);
    }

    /// <summary>
    /// å¤„ç†æ–°ç³»ç»Ÿçš„æˆ˜æ–—çŠ¶æ€æ›´æ–°
    /// </summary>
    private void HandleNewBattleUpdate(BattleStateDto? battleState)
    {
        InvokeAsync(() =>
        {
            _serverBattleState = battleState;
            StateHasChanged();
        });
    }
    
    /// <summary>
    /// å¤„ç†è¿æ¥çŠ¶æ€å˜åŒ–
    /// </summary>
    private void HandleConnectionChanged(bool isConnected)
    {
        _isConnected = isConnected;
        
        InvokeAsync(async () =>
        {
            if (isConnected)
            {
                // è¿æ¥æ¢å¤ï¼Œåœæ­¢è½®è¯¢
                _fallbackPoller?.Dispose();
                _fallbackPoller = null;
                
                // å¦‚æœåœ¨ç¦»çº¿æ¨¡å¼ï¼Œå°è¯•åŒæ­¥
                if (OfflineService.IsOfflineMode)
                {
                    await OfflineService.ExitOfflineMode(GameApi);
                }
            }
            else
            {
                // è¿æ¥æ–­å¼€ï¼Œå¯åŠ¨è½®è¯¢
                StartFallbackPolling();
            }
            
            StateHasChanged();
        });
    }
    
    /// <summary>
    /// å¤„ç†ç¦»çº¿æ¨¡å¼å˜åŒ–
    /// </summary>
    private void HandleOfflineModeChanged(bool isOffline)
    {
        InvokeAsync(() =>
        {
            StateHasChanged();
        });
    }
    
    /// <summary>
    /// å¯åŠ¨å¤‡ç”¨è½®è¯¢æœºåˆ¶
    /// </summary>
    private void StartFallbackPolling()
    {
        _fallbackPoller = new System.Threading.Timer(async _ =>
        {
            if (_serverBattleState != null && !_isConnected)
            {
                try
                {
                    var response = await GameApi.GetBattleStateAsync(_serverBattleState.BattleId);
                    if (response.Success && response.Data != null)
                    {
                        await InvokeAsync(() =>
                        {
                            _serverBattleState = response.Data;
                            StateHasChanged();
                        });
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "è½®è¯¢æˆ˜æ–—çŠ¶æ€å¤±è´¥");
                }
            }
        }, null, TimeSpan.Zero, TimeSpan.FromMilliseconds(500));
    }

    public void Dispose()
    {
        // æ¸…ç†æ–°ç³»ç»Ÿäº‹ä»¶
        if (_useNewBattleSystem)
        {
            NewGameState.OnBattleStateChanged -= HandleNewBattleUpdate;
            NewGameState.OnConnectionStatusChanged -= HandleConnectionChanged;
            OfflineService.OnOfflineModeChanged -= HandleOfflineModeChanged;
        }
        else
        {
            GameState.OnStateChanged -= HandleStateChanged;
        }
        
        // æ¸…ç†å®šæ—¶å™¨
        _fallbackPoller?.Dispose();
    }
    private void HandleStateChanged()
    {
        // Ö»ï¿½ï¿½Í¬Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Äµï¿½ï¿½ï¿½:
        // 1. ï¿½ï¿½É«ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½×´Ì¬
        // 2. Ã»ï¿½ï¿½Õ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        // 3. Ã»ï¿½ï¿½ï¿½ï¿½Õ½ï¿½ï¿½Ë¢ï¿½ï¿½×´Ì¬(ï¿½ï¿½ï¿½ÚµÈ´ï¿½ï¿½ï¿½Ò»ï¿½ï¿½)
        if (GameState.ActiveCharacter?.CurrentAction != PlayerActionState.Combat &&
            _combatService?.GetBattleContextForPlayer(GameState.ActiveCharacter?.Id) == null &&
            !(_combatService?.IsPlayerInBattleRefresh(GameState.ActiveCharacter?.Id) ?? false))
        {
            _lastBattleEnemy = null;
        }

        StateHasChanged();
    }

}