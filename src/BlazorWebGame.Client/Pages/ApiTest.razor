@page "/api-test"
@using BlazorWebGame.Client.Services.Api
@using BlazorWebGame.Shared.DTOs
@inject GameApiClient ApiClient
@inject GameApiService LegacyApi
@inject ShopApiService ShopApi
@inject ReputationApiService ReputationApi
@inject ProductionApiService ProductionApi

<PageTitle>API æµ‹è¯•é¡µé¢</PageTitle>

<div class="container-fluid">
    <h3>ğŸ§ª API æœåŠ¡æµ‹è¯•é¡µé¢</h3>
    
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ” è®¤è¯æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary mb-2" @onclick="TestAuthentication">æµ‹è¯•æ¼”ç¤ºç™»å½•</button>
                    <button class="btn btn-info mb-2" @onclick="TestServerConnection">æ£€æŸ¥æœåŠ¡å™¨è¿æ¥</button>
                    <div class="alert alert-info small">
                        <strong>è®¤è¯çŠ¶æ€:</strong> @_authStatus
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>âš”ï¸ æˆ˜æ–—æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestGetActiveBattles">è·å–æ´»è·ƒæˆ˜æ–—</button>
                    <button class="btn btn-warning mb-2" @onclick="TestBattleOperations">æµ‹è¯•æˆ˜æ–—æ“ä½œ</button>
                    <div class="alert alert-success small">
                        <strong>æ´»è·ƒæˆ˜æ–—:</strong> @_activeBattleCount ä¸ª
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ‘¥ ç»„é˜ŸæœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestGetAllParties">è·å–æ‰€æœ‰é˜Ÿä¼</button>
                    <button class="btn btn-info mb-2" @onclick="TestPartyOperations">æµ‹è¯•ç»„é˜Ÿæ“ä½œ</button>
                    <div class="alert alert-success small">
                        <strong>æ´»è·ƒé˜Ÿä¼:</strong> @_partyCount ä¸ª
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ‘¤ è§’è‰²æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestGetCharacters">è·å–è§’è‰²åˆ—è¡¨</button>
                    <button class="btn btn-info mb-2" @onclick="TestCharacterDetails">è·å–è§’è‰²è¯¦æƒ…</button>
                    <div class="alert alert-success small">
                        <strong>è§’è‰²æ•°é‡:</strong> @_characterCount ä¸ª
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ’ åº“å­˜æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestInventoryOperations">æµ‹è¯•åº“å­˜æ“ä½œ</button>
                    <button class="btn btn-warning mb-2" @onclick="TestItemOperations">æµ‹è¯•ç‰©å“æ“ä½œ</button>
                    <div class="alert alert-info small">
                        <strong>åº“å­˜çŠ¶æ€:</strong> @_inventoryStatus
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>âš’ï¸ ç”Ÿäº§æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <h6>é‡‡é›†åŠŸèƒ½æµ‹è¯•</h6>
                        <button class="btn btn-success btn-sm me-1" @onclick="TestGetGatheringNodes">è·å–é‡‡é›†èŠ‚ç‚¹</button>
                        <button class="btn btn-info btn-sm me-1" @onclick="TestStartGathering">å¼€å§‹é‡‡é›†</button>
                        <button class="btn btn-warning btn-sm me-1" @onclick="TestStopGathering">åœæ­¢é‡‡é›†</button>
                        <button class="btn btn-secondary btn-sm" @onclick="TestGatheringStatus">é‡‡é›†çŠ¶æ€</button>
                    </div>
                    
                    <div class="mb-2">
                        <h6>åˆ¶ä½œåŠŸèƒ½æµ‹è¯•</h6>
                        <button class="btn btn-success btn-sm me-1" @onclick="TestGetRecipes">è·å–é…æ–¹</button>
                        <button class="btn btn-info btn-sm me-1" @onclick="TestStartCrafting">å¼€å§‹åˆ¶ä½œ</button>
                        <button class="btn btn-warning btn-sm me-1" @onclick="TestStopCrafting">åœæ­¢åˆ¶ä½œ</button>
                        <button class="btn btn-secondary btn-sm" @onclick="TestCraftingStatus">åˆ¶ä½œçŠ¶æ€</button>
                    </div>
                    
                    <div class="mb-2">
                        <button class="btn btn-primary btn-sm me-1" @onclick="TestNodeUnlock">èŠ‚ç‚¹è§£é”æ£€æŸ¥</button>
                        <button class="btn btn-dark btn-sm" @onclick="TestMaterialsCheck">ææ–™æ£€æŸ¥</button>
                    </div>
                    
                    <div class="alert alert-success small mb-0">
                        <strong>é‡‡é›†èŠ‚ç‚¹:</strong> @_nodeCount ä¸ª<br/>
                        <strong>é…æ–¹æ•°é‡:</strong> @_recipeCount ä¸ª<br/>
                        <strong>é‡‡é›†çŠ¶æ€:</strong> @_gatheringStatus<br/>
                        <strong>åˆ¶ä½œçŠ¶æ€:</strong> @_craftingStatus
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ›’ å•†åº—æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestGetShopItems">è·å–å•†åº—ç‰©å“</button>
                    <button class="btn btn-info mb-2" @onclick="TestGetShopCategories">è·å–å•†åº—åˆ†ç±»</button>
                    <button class="btn btn-warning mb-2" @onclick="TestPurchaseItem">æµ‹è¯•è´­ä¹°ç‰©å“</button>
                    <button class="btn btn-danger mb-2" @onclick="TestSellItem">æµ‹è¯•å‡ºå”®ç‰©å“</button>
                    <div class="alert alert-info small">
                        <strong>å•†åº—çŠ¶æ€:</strong> @_shopStatus
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>â­ å£°æœ›æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestGetReputation">è·å–å£°æœ›ä¿¡æ¯</button>
                    <button class="btn btn-info mb-2" @onclick="TestGetReputationDetails">è·å–è¯¦ç»†å£°æœ›</button>
                    <button class="btn btn-warning mb-2" @onclick="TestUpdateReputation">æµ‹è¯•å£°æœ›æ›´æ–°</button>
                    <button class="btn btn-primary mb-2" @onclick="TestReputationRewards">è·å–å£°æœ›å¥–åŠ±</button>
                    <div class="alert alert-info small">
                        <strong>å£°æœ›çŠ¶æ€:</strong> @_reputationStatus
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“Š å•†åº—æµ‹è¯•ç»“æœ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>å•†åº—ç‰©å“æ•°é‡</h6>
                            <div class="alert alert-primary small">@_shopItemCount ä¸ªç‰©å“</div>
                            
                            <h6>å•†åº—åˆ†ç±»æ•°é‡</h6>
                            <div class="alert alert-success small">@_shopCategoryCount ä¸ªåˆ†ç±»</div>
                        </div>
                        <div class="col-md-6">
                            <h6>æœ€åæ“ä½œç»“æœ</h6>
                            <div class="alert alert-@(_lastShopTestSuccess ? "success" : "danger") small">
                                @_lastShopTestMessage
                            </div>
                            
                            <h6>æµ‹è¯•ç»Ÿè®¡</h6>
                            <div class="alert alert-info small">
                                æˆåŠŸ: @_shopTestSuccessCount, å¤±è´¥: @_shopTestFailureCount
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>â­ å£°æœ›æµ‹è¯•ç»“æœ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>å£°æœ›æµ‹è¯•ç»Ÿè®¡</h6>
                            <div class="alert alert-primary small">
                                æˆåŠŸ: @_reputationTestSuccessCount, å¤±è´¥: @_reputationTestFailureCount
                            </div>
                            
                            <h6>æ€»å£°æœ›å€¼</h6>
                            <div class="alert alert-success small">@_totalReputationValue ç‚¹</div>
                        </div>
                        <div class="col-md-6">
                            <h6>æœ€åæ“ä½œç»“æœ</h6>
                            <div class="alert alert-@(_lastReputationTestSuccess ? "success" : "danger") small">
                                @_lastReputationTestMessage
                            </div>
                            
                            <h6>å£°æœ›è¯¦æƒ…æ•°é‡</h6>
                            <div class="alert alert-info small">@_reputationDetailCount ä¸ªé˜µè¥</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
    <!-- New Enhanced Testing Section -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5>ğŸš€ å¢å¼ºçš„ç”Ÿäº§å’Œæˆ˜æ–—äº‹ä»¶æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>âš”ï¸ æˆ˜æ–—äº‹ä»¶æµ‹è¯•</h6>
                            <button class="btn btn-primary btn-sm mb-2 w-100" @onclick="TestBattleEventCollection">æµ‹è¯•æˆ˜æ–—äº‹ä»¶æ”¶é›†</button>
                            <button class="btn btn-info btn-sm mb-2 w-100" @onclick="TestBattleFlowOptimization">æµ‹è¯•æˆ˜æ–—æµç¨‹ä¼˜åŒ–</button>
                            <button class="btn btn-warning btn-sm mb-2 w-100" @onclick="TestBattleErrorHandling">æµ‹è¯•æˆ˜æ–—é”™è¯¯å¤„ç†</button>
                            <div class="alert alert-info small">
                                <strong>æˆ˜æ–—çŠ¶æ€:</strong> @_battleTestStatus
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <h6>âš’ï¸ ç”Ÿäº§äº‹ä»¶æµ‹è¯•</h6>
                            <button class="btn btn-success btn-sm mb-2 w-100" @onclick="TestProductionEventCollection">æµ‹è¯•ç”Ÿäº§äº‹ä»¶æ”¶é›†</button>
                            <button class="btn btn-info btn-sm mb-2 w-100" @onclick="TestGatheringOptimization">æµ‹è¯•é‡‡é›†ä¼˜åŒ–</button>
                            <button class="btn btn-warning btn-sm mb-2 w-100" @onclick="TestCraftingBatchProcessing">æµ‹è¯•åˆ¶ä½œæ‰¹å¤„ç†</button>
                            <div class="alert alert-success small">
                                <strong>ç”Ÿäº§çŠ¶æ€:</strong> @_productionTestStatus
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <h6>ğŸ“Š æ€§èƒ½ç›‘æ§æµ‹è¯•</h6>
                            <button class="btn btn-outline-primary btn-sm mb-2 w-100" @onclick="TestEventSystemPerformance">æµ‹è¯•äº‹ä»¶ç³»ç»Ÿæ€§èƒ½</button>
                            <button class="btn btn-outline-info btn-sm mb-2 w-100" @onclick="TestBatchProcessingEfficiency">æµ‹è¯•æ‰¹å¤„ç†æ•ˆç‡</button>
                            <button class="btn btn-outline-success btn-sm mb-2 w-100" @onclick="TestErrorRecovery">æµ‹è¯•é”™è¯¯æ¢å¤</button>
                            <div class="alert alert-warning small">
                                <strong>æ€§èƒ½æŒ‡æ ‡:</strong> @_performanceMetrics
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <h6>ğŸ”„ é›†æˆæµ‹è¯•</h6>
                            <button class="btn btn-secondary btn-sm mb-2 w-100" @onclick="TestFullProductionFlow">æµ‹è¯•å®Œæ•´ç”Ÿäº§æµç¨‹</button>
                            <button class="btn btn-secondary btn-sm mb-2 w-100" @onclick="TestBattleProductionIntegration">æµ‹è¯•æˆ˜æ–—ç”Ÿäº§é›†æˆ</button>
                            <button class="btn btn-danger btn-sm mb-2 w-100" @onclick="TestStressScenarios">æµ‹è¯•å‹åŠ›åœºæ™¯</button>
                            <div class="alert alert-secondary small">
                                <strong>é›†æˆçŠ¶æ€:</strong> @_integrationTestStatus
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“‹ ä»»åŠ¡æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestQuestOperations">æµ‹è¯•ä»»åŠ¡æ“ä½œ</button>
                    <div class="alert alert-info small">
                        <strong>ä»»åŠ¡çŠ¶æ€:</strong> @_questStatus
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“Š ç›‘æ§æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-info mb-2" @onclick="TestMonitoringServices">æµ‹è¯•ç›‘æ§æœåŠ¡</button>
                    <div class="alert alert-warning small">
                        <strong>æœåŠ¡å™¨çŠ¶æ€:</strong> @_serverStatus
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“ æµ‹è¯•æ—¥å¿—</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-secondary" style="max-height: 300px; overflow-y: auto;">
                        @foreach (var log in _testLogs)
                        {
                            <div>@log</div>
                        }
                    </div>
                    <button class="btn btn-secondary btn-sm" @onclick="ClearLogs">æ¸…ç©ºæ—¥å¿—</button>
                    <button class="btn btn-success btn-sm" @onclick="RunAllTests">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string _authStatus = "æœªè®¤è¯";
    private int _activeBattleCount = 0;
    private int _partyCount = 0;
    private int _characterCount = 0;
    private string _inventoryStatus = "æœªæµ‹è¯•";
    private int _nodeCount = 0;
    private string _questStatus = "æœªæµ‹è¯•";
    
    // Production system test fields
    private int _recipeCount = 0;
    private string _productionStatus = "æœªæµ‹è¯•";
    private string _gatheringStatus = "æœªæ´»è·ƒ";
    private string _craftingStatus = "æœªæ´»è·ƒ";
    private bool _isGathering = false;
    private bool _isCrafting = false;
    private string _serverStatus = "æœªçŸ¥";
    private List<string> _testLogs = new();
    
    // Enhanced test status variables
    private string _battleTestStatus = "æœªæµ‹è¯•";
    private string _productionTestStatus = "æœªæµ‹è¯•";
    private string _performanceMetrics = "æ— æ•°æ®";
    private string _integrationTestStatus = "æœªæµ‹è¯•";
    
    // Shop test status variables
    private string _shopStatus = "æœªæµ‹è¯•";
    private int _shopItemCount = 0;
    private int _shopCategoryCount = 0;
    private bool _lastShopTestSuccess = false;
    private string _lastShopTestMessage = "å°šæœªè¿›è¡Œæµ‹è¯•";
    private int _shopTestSuccessCount = 0;
    private int _shopTestFailureCount = 0;
    
    // Reputation test status variables
    private string _reputationStatus = "æœªæµ‹è¯•";
    private int _totalReputationValue = 0;
    private int _reputationDetailCount = 0;
    private bool _lastReputationTestSuccess = false;
    private string _lastReputationTestMessage = "å°šæœªè¿›è¡Œæµ‹è¯•";
    private int _reputationTestSuccessCount = 0;
    private int _reputationTestFailureCount = 0;

    private void AddLog(string message)
    {
        var timestamp = DateTime.Now.ToString("HH:mm:ss");
        _testLogs.Add($"[{timestamp}] {message}");
        StateHasChanged();
    }

    private void ClearLogs()
    {
        _testLogs.Clear();
        StateHasChanged();
    }

    private async Task TestAuthentication()
    {
        try
        {
            AddLog("ğŸ” å¼€å§‹æµ‹è¯•è®¤è¯æœåŠ¡...");
            var result = await ApiClient.SetupAuthenticationAsync();
            _authStatus = result.Contains("âœ…") ? "å·²è®¤è¯" : "è®¤è¯å¤±è´¥";
            AddLog($"è®¤è¯ç»“æœ: {result}");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ è®¤è¯æµ‹è¯•å¤±è´¥: {ex.Message}");
            _authStatus = "è®¤è¯å¼‚å¸¸";
        }
    }

    private async Task TestServerConnection()
    {
        try
        {
            AddLog("ğŸ”— æ£€æŸ¥æœåŠ¡å™¨è¿æ¥çŠ¶æ€...");
            var isAvailable = await ApiClient.IsServerAvailableAsync();
            _serverStatus = isAvailable ? "åœ¨çº¿" : "ç¦»çº¿";
            AddLog($"æœåŠ¡å™¨çŠ¶æ€: {_serverStatus}");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æœåŠ¡å™¨è¿æ¥æ£€æŸ¥å¤±è´¥: {ex.Message}");
            _serverStatus = "è¿æ¥å¼‚å¸¸";
        }
    }

    private async Task TestGetActiveBattles()
    {
        try
        {
            AddLog("âš”ï¸ è·å–æ´»è·ƒæˆ˜æ–—åˆ—è¡¨...");
            var response = await ApiClient.Battle.GetActiveBattlesAsync();
            if (response.Success && response.Data != null)
            {
                _activeBattleCount = response.Data.Count;
                AddLog($"âœ… è·å–åˆ° {_activeBattleCount} ä¸ªæ´»è·ƒæˆ˜æ–—");
            }
            else
            {
                AddLog($"âš ï¸ è·å–æ´»è·ƒæˆ˜æ–—å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æˆ˜æ–—æœåŠ¡æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }

    private async Task TestBattleOperations()
    {
        AddLog("âš”ï¸ æˆ˜æ–—æ“ä½œæµ‹è¯•...");
        AddLog("â„¹ï¸ æˆ˜æ–—æ“ä½œéœ€è¦å…·ä½“çš„è§’è‰²å’Œæ•ŒäººIDï¼Œæ­¤å¤„ä»…æµ‹è¯•æ¥å£å¯ç”¨æ€§");
        // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å…·ä½“çš„æˆ˜æ–—æ“ä½œæµ‹è¯•
    }

    private async Task TestGetAllParties()
    {
        try
        {
            AddLog("ğŸ‘¥ è·å–æ‰€æœ‰ç»„é˜Ÿ...");
            var response = await ApiClient.Party.GetAllPartiesAsync();
            if (response.Success && response.Data != null)
            {
                _partyCount = response.Data.Count;
                AddLog($"âœ… è·å–åˆ° {_partyCount} ä¸ªæ´»è·ƒé˜Ÿä¼");
            }
            else
            {
                AddLog($"âš ï¸ è·å–é˜Ÿä¼å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ ç»„é˜ŸæœåŠ¡æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }

    private async Task TestPartyOperations()
    {
        AddLog("ğŸ‘¥ ç»„é˜Ÿæ“ä½œæµ‹è¯•...");
        AddLog("â„¹ï¸ ç»„é˜Ÿæ“ä½œéœ€è¦å…·ä½“çš„è§’è‰²IDï¼Œæ­¤å¤„ä»…æµ‹è¯•æ¥å£å¯ç”¨æ€§");
        // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å…·ä½“çš„ç»„é˜Ÿæ“ä½œæµ‹è¯•
    }

    private async Task TestGetCharacters()
    {
        try
        {
            AddLog("ğŸ‘¤ è·å–è§’è‰²åˆ—è¡¨...");
            var response = await ApiClient.Character.GetCharactersAsync();
            if (response.Success && response.Data != null)
            {
                _characterCount = response.Data.Count;
                AddLog($"âœ… è·å–åˆ° {_characterCount} ä¸ªè§’è‰²");
            }
            else
            {
                AddLog($"âš ï¸ è·å–è§’è‰²å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ è§’è‰²æœåŠ¡æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }

    private async Task TestCharacterDetails()
    {
        AddLog("ğŸ‘¤ è§’è‰²è¯¦æƒ…æµ‹è¯•...");
        AddLog("â„¹ï¸ è§’è‰²è¯¦æƒ…æŸ¥è¯¢éœ€è¦å…·ä½“çš„è§’è‰²ID");
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…·ä½“çš„è§’è‰²è¯¦æƒ…æµ‹è¯•
    }

    private async Task TestInventoryOperations()
    {
        AddLog("ğŸ’ åº“å­˜æ“ä½œæµ‹è¯•...");
        _inventoryStatus = "æ¥å£å¯ç”¨";
        AddLog("â„¹ï¸ åº“å­˜æ“ä½œéœ€è¦å…·ä½“çš„è§’è‰²IDå’Œç‰©å“ID");
    }

    private async Task TestItemOperations()
    {
        AddLog("ğŸ”§ ç‰©å“æ“ä½œæµ‹è¯•...");
        AddLog("â„¹ï¸ ç‰©å“æ“ä½œåŒ…æ‹¬ä½¿ç”¨ã€è£…å¤‡ã€å‡ºå”®ç­‰åŠŸèƒ½");
    }

    private async Task TestGetGatheringNodes()
    {
        try
        {
            AddLog("âš’ï¸ è·å–é‡‡é›†èŠ‚ç‚¹...");
            var response = await ProductionApi.GetGatheringNodesAsync();
            if (response.Success && response.Data != null)
            {
                _nodeCount = response.Data.Count;
                AddLog($"âœ… è·å–åˆ° {_nodeCount} ä¸ªé‡‡é›†èŠ‚ç‚¹");
                
                // æ˜¾ç¤ºå‰å‡ ä¸ªèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯
                foreach (var node in response.Data.Take(3))
                {
                    AddLog($"   ğŸ“ {node.Name} (ç­‰çº§:{node.RequiredLevel}, æ—¶é—´:{node.GatheringTimeSeconds}s)");
                }
                
                if (_nodeCount > 3)
                {
                    AddLog($"   ... è¿˜æœ‰ {_nodeCount - 3} ä¸ªèŠ‚ç‚¹");
                }
            }
            else
            {
                AddLog($"âš ï¸ è·å–é‡‡é›†èŠ‚ç‚¹å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ ç”Ÿäº§æœåŠ¡æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }

    private async Task TestStartGathering()
    {
        try
        {
            AddLog("ğŸŒ¿ æµ‹è¯•å¼€å§‹é‡‡é›†...");
            
            // é¦–å…ˆè·å–ä¸€ä¸ªæµ‹è¯•ç”¨çš„èŠ‚ç‚¹
            var nodesResponse = await ProductionApi.GetGatheringNodesAsync();
            if (!nodesResponse.Success || nodesResponse.Data?.Any() != true)
            {
                AddLog("âš ï¸ æ²¡æœ‰å¯ç”¨çš„é‡‡é›†èŠ‚ç‚¹è¿›è¡Œæµ‹è¯•");
                return;
            }
            
            var testNode = nodesResponse.Data.First();
            var request = new StartGatheringRequest
            {
                CharacterId = "test_character_001",
                NodeId = testNode.Id
            };
            
            var response = await ProductionApi.StartGatheringAsync(request);
            if (response.Success)
            {
                _isGathering = true;
                _gatheringStatus = $"é‡‡é›†ä¸­ - {testNode.Name}";
                AddLog($"âœ… å¼€å§‹é‡‡é›† {testNode.Name}");
            }
            else
            {
                _gatheringStatus = "é‡‡é›†å¤±è´¥";
                AddLog($"âš ï¸ å¼€å§‹é‡‡é›†å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ å¼€å§‹é‡‡é›†å¼‚å¸¸: {ex.Message}");
        }
    }

    private async Task TestStopGathering()
    {
        try
        {
            AddLog("ğŸ›‘ æµ‹è¯•åœæ­¢é‡‡é›†...");
            
            var request = new StopGatheringRequest
            {
                CharacterId = "test_character_001"
            };
            
            var response = await ProductionApi.StopGatheringAsync(request);
            if (response.Success)
            {
                _isGathering = false;
                _gatheringStatus = "å·²åœæ­¢";
                AddLog("âœ… æˆåŠŸåœæ­¢é‡‡é›†");
                
                if (response.Data != null)
                {
                    AddLog($"   è·å¾—ç‰©å“: {response.Data.ItemId} x{response.Data.Quantity}");
                    AddLog($"   è·å¾—ç»éªŒ: {response.Data.XpGained}");
                }
            }
            else
            {
                AddLog($"âš ï¸ åœæ­¢é‡‡é›†å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ åœæ­¢é‡‡é›†å¼‚å¸¸: {ex.Message}");
        }
    }

    private async Task TestGatheringStatus()
    {
        try
        {
            AddLog("ğŸ“Š æŸ¥è¯¢é‡‡é›†çŠ¶æ€...");
            
            var response = await ProductionApi.GetGatheringStateAsync("test_character_001");
            if (response.Success && response.Data != null)
            {
                var state = response.Data;
                if (state.IsGathering)
                {
                    _gatheringStatus = $"é‡‡é›†ä¸­ - å‰©ä½™ {state.RemainingTimeSeconds:F1}s";
                    AddLog($"âœ… æ­£åœ¨é‡‡é›†èŠ‚ç‚¹: {state.CurrentNodeId}");
                    AddLog($"   å‰©ä½™æ—¶é—´: {state.RemainingTimeSeconds:F1} ç§’");
                    AddLog($"   é¢„è®¡å®Œæˆ: {state.EstimatedCompletionTime:HH:mm:ss}");
                }
                else
                {
                    _gatheringStatus = "æœªåœ¨é‡‡é›†";
                    AddLog("â„¹ï¸ è§’è‰²å½“å‰æœªåœ¨è¿›è¡Œé‡‡é›†æ´»åŠ¨");
                }
            }
            else
            {
                AddLog($"âš ï¸ æŸ¥è¯¢é‡‡é›†çŠ¶æ€å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æŸ¥è¯¢é‡‡é›†çŠ¶æ€å¼‚å¸¸: {ex.Message}");
        }
    }

    private async Task TestGetRecipes()
    {
        try
        {
            AddLog("ğŸ“œ è·å–åˆ¶ä½œé…æ–¹...");
            
            var request = new GetRecipesRequest
            {
                CharacterId = "test_character_001",
                MaxLevel = 10 // åªè·å–ä½ç­‰çº§é…æ–¹ä½œä¸ºæµ‹è¯•
            };
            
            var response = await ProductionApi.GetRecipesAsync(request);
            if (response.Success && response.Data != null)
            {
                _recipeCount = response.Data.Count;
                AddLog($"âœ… è·å–åˆ° {_recipeCount} ä¸ªé…æ–¹");
                
                // æŒ‰èŒä¸šåˆ†ç»„æ˜¾ç¤º
                var groupedRecipes = response.Data.GroupBy(r => r.RequiredProfession);
                foreach (var group in groupedRecipes)
                {
                    AddLog($"   ğŸ› ï¸ {group.Key}: {group.Count()} ä¸ªé…æ–¹");
                    foreach (var recipe in group.Take(2))
                    {
                        AddLog($"      - {recipe.Name} (ç­‰çº§:{recipe.RequiredLevel}, æ—¶é—´:{recipe.CraftingTimeSeconds}s)");
                    }
                }
            }
            else
            {
                AddLog($"âš ï¸ è·å–é…æ–¹å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ è·å–é…æ–¹å¼‚å¸¸: {ex.Message}");
        }
    }

    private async Task TestStartCrafting()
    {
        try
        {
            AddLog("ğŸ”¨ æµ‹è¯•å¼€å§‹åˆ¶ä½œ...");
            
            // é¦–å…ˆè·å–ä¸€ä¸ªæµ‹è¯•ç”¨çš„é…æ–¹
            var recipesRequest = new GetRecipesRequest
            {
                CharacterId = "test_character_001",
                MaxLevel = 5
            };
            
            var recipesResponse = await ProductionApi.GetRecipesAsync(recipesRequest);
            if (!recipesResponse.Success || recipesResponse.Data?.Any() != true)
            {
                AddLog("âš ï¸ æ²¡æœ‰å¯ç”¨çš„é…æ–¹è¿›è¡Œæµ‹è¯•");
                return;
            }
            
            var testRecipe = recipesResponse.Data.First();
            var request = new StartCraftingRequest
            {
                CharacterId = "test_character_001",
                RecipeId = testRecipe.Id,
                Quantity = 1
            };
            
            var response = await ProductionApi.StartCraftingAsync(request);
            if (response.Success)
            {
                _isCrafting = true;
                _craftingStatus = $"åˆ¶ä½œä¸­ - {testRecipe.Name}";
                AddLog($"âœ… å¼€å§‹åˆ¶ä½œ {testRecipe.Name}");
            }
            else
            {
                _craftingStatus = "åˆ¶ä½œå¤±è´¥";
                AddLog($"âš ï¸ å¼€å§‹åˆ¶ä½œå¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ å¼€å§‹åˆ¶ä½œå¼‚å¸¸: {ex.Message}");
        }
    }

    private async Task TestStopCrafting()
    {
        try
        {
            AddLog("ğŸ›‘ æµ‹è¯•åœæ­¢åˆ¶ä½œ...");
            
            var request = new StopCraftingRequest
            {
                CharacterId = "test_character_001"
            };
            
            var response = await ProductionApi.StopCraftingAsync(request);
            if (response.Success)
            {
                _isCrafting = false;
                _craftingStatus = "å·²åœæ­¢";
                AddLog("âœ… æˆåŠŸåœæ­¢åˆ¶ä½œ");
                
                if (response.Data != null)
                {
                    AddLog($"   åˆ¶ä½œç‰©å“: {response.Data.ItemId} x{response.Data.Quantity}");
                    AddLog($"   è·å¾—ç»éªŒ: {response.Data.XpGained}");
                }
            }
            else
            {
                AddLog($"âš ï¸ åœæ­¢åˆ¶ä½œå¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ åœæ­¢åˆ¶ä½œå¼‚å¸¸: {ex.Message}");
        }
    }

    private async Task TestCraftingStatus()
    {
        try
        {
            AddLog("ğŸ“Š æŸ¥è¯¢åˆ¶ä½œçŠ¶æ€...");
            
            var response = await ProductionApi.GetCraftingStateAsync("test_character_001");
            if (response.Success && response.Data != null)
            {
                var state = response.Data;
                if (state.IsCrafting)
                {
                    _craftingStatus = $"åˆ¶ä½œä¸­ - å‰©ä½™ {state.RemainingTimeSeconds:F1}s";
                    AddLog($"âœ… æ­£åœ¨åˆ¶ä½œé…æ–¹: {state.CurrentRecipeId}");
                    AddLog($"   è¿›åº¦: {state.CompletedQuantity}/{state.TotalQuantity}");
                    AddLog($"   å‰©ä½™æ—¶é—´: {state.RemainingTimeSeconds:F1} ç§’");
                    AddLog($"   é¢„è®¡å®Œæˆ: {state.EstimatedCompletionTime:HH:mm:ss}");
                }
                else
                {
                    _craftingStatus = "æœªåœ¨åˆ¶ä½œ";
                    AddLog("â„¹ï¸ è§’è‰²å½“å‰æœªåœ¨è¿›è¡Œåˆ¶ä½œæ´»åŠ¨");
                }
            }
            else
            {
                AddLog($"âš ï¸ æŸ¥è¯¢åˆ¶ä½œçŠ¶æ€å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æŸ¥è¯¢åˆ¶ä½œçŠ¶æ€å¼‚å¸¸: {ex.Message}");
        }
    }

    private async Task TestNodeUnlock()
    {
        try
        {
            AddLog("ğŸ”“ æµ‹è¯•èŠ‚ç‚¹è§£é”æ£€æŸ¥...");
            
            // è·å–ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œæµ‹è¯•
            var nodesResponse = await ProductionApi.GetGatheringNodesAsync();
            if (!nodesResponse.Success || nodesResponse.Data?.Any() != true)
            {
                AddLog("âš ï¸ æ²¡æœ‰å¯ç”¨çš„èŠ‚ç‚¹è¿›è¡Œæµ‹è¯•");
                return;
            }
            
            var testNode = nodesResponse.Data.First();
            var request = new NodeUnlockCheckRequest
            {
                CharacterId = "test_character_001",
                NodeId = testNode.Id
            };
            
            var response = await ProductionApi.CheckNodeUnlockStatusAsync(request);
            if (response.Success && response.Data != null)
            {
                var status = response.Data;
                if (status.IsUnlocked)
                {
                    AddLog($"âœ… èŠ‚ç‚¹ {testNode.Name} å·²è§£é”");
                }
                else
                {
                    AddLog($"ğŸ”’ èŠ‚ç‚¹ {testNode.Name} æœªè§£é”: {status.Reason}");
                    if (status.RequiredLevel.HasValue)
                    {
                        AddLog($"   éœ€è¦ç­‰çº§: {status.RequiredLevel.Value}");
                    }
                }
            }
            else
            {
                AddLog($"âš ï¸ æ£€æŸ¥èŠ‚ç‚¹è§£é”çŠ¶æ€å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æ£€æŸ¥èŠ‚ç‚¹è§£é”çŠ¶æ€å¼‚å¸¸: {ex.Message}");
        }
    }

    private async Task TestMaterialsCheck()
    {
        try
        {
            AddLog("ğŸ§ª æµ‹è¯•ææ–™æ£€æŸ¥...");
            
            // è·å–ä¸€ä¸ªé…æ–¹è¿›è¡Œæµ‹è¯•
            var recipesRequest = new GetRecipesRequest
            {
                CharacterId = "test_character_001",
                MaxLevel = 5
            };
            
            var recipesResponse = await ProductionApi.GetRecipesAsync(recipesRequest);
            if (!recipesResponse.Success || recipesResponse.Data?.Any() != true)
            {
                AddLog("âš ï¸ æ²¡æœ‰å¯ç”¨çš„é…æ–¹è¿›è¡Œæµ‹è¯•");
                return;
            }
            
            var testRecipe = recipesResponse.Data.First();
            var response = await ProductionApi.CheckCraftingMaterialsAsync("test_character_001", testRecipe.Id, 1);
            
            if (response.Success)
            {
                if (response.Data)
                {
                    AddLog($"âœ… åˆ¶ä½œ {testRecipe.Name} çš„ææ–™å……è¶³");
                }
                else
                {
                    AddLog($"âŒ åˆ¶ä½œ {testRecipe.Name} çš„ææ–™ä¸è¶³");
                }
            }
            else
            {
                AddLog($"âš ï¸ æ£€æŸ¥ææ–™å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æ£€æŸ¥ææ–™å¼‚å¸¸: {ex.Message}");
        }
    }

    private async Task TestProductionOperations()
    {
        AddLog("âš’ï¸ å¼€å§‹ç”Ÿäº§ç³»ç»Ÿç»¼åˆæµ‹è¯•...");
        
        await TestGetGatheringNodes();
        await Task.Delay(500);
        
        await TestGetRecipes();
        await Task.Delay(500);
        
        await TestNodeUnlock();
        await Task.Delay(500);
        
        await TestMaterialsCheck();
        
        AddLog("âœ… ç”Ÿäº§ç³»ç»Ÿç»¼åˆæµ‹è¯•å®Œæˆ");
    }

    private async Task TestQuestOperations()
    {
        AddLog("ğŸ“‹ ä»»åŠ¡æ“ä½œæµ‹è¯•...");
        _questStatus = "æ¥å£å¯ç”¨";
        AddLog("â„¹ï¸ ä»»åŠ¡æ“ä½œåŒ…æ‹¬æ¥å—ã€å®Œæˆã€æ›´æ–°è¿›åº¦ç­‰åŠŸèƒ½");
    }

    private async Task TestMonitoringServices()
    {
        try
        {
            AddLog("ğŸ“Š ç›‘æ§æœåŠ¡æµ‹è¯•...");
            var response = await ApiClient.Monitoring.GetGameStatusAsync();
            if (response.Success && response.Data != null)
            {
                _serverStatus = response.Data.ServerStatus;
                AddLog($"âœ… æœåŠ¡å™¨çŠ¶æ€: {_serverStatus}");
                AddLog($"æ´»è·ƒç©å®¶: {response.Data.ActivePlayers}");
                AddLog($"æ´»è·ƒæˆ˜æ–—: {response.Data.ActiveBattles}");
            }
            else
            {
                AddLog($"âš ï¸ è·å–ç›‘æ§ä¿¡æ¯å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ ç›‘æ§æœåŠ¡æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }

    private async Task RunAllTests()
    {
        AddLog("ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...");
        ClearLogs();
        
        await TestAuthentication();
        await Task.Delay(500);
        
        await TestServerConnection();
        await Task.Delay(500);
        
        await TestGetActiveBattles();
        await Task.Delay(500);
        
        await TestGetAllParties();
        await Task.Delay(500);
        
        await TestGetCharacters();
        await Task.Delay(500);
        
        await TestGetGatheringNodes();
        await Task.Delay(500);
        
        await TestMonitoringServices();
        await Task.Delay(500);
        
        // æ·»åŠ å£°æœ›æµ‹è¯•
        await TestGetReputation();
        await Task.Delay(500);
        
        await TestGetReputationDetails();
        await Task.Delay(500);
        
        await TestReputationRewards();
        await Task.Delay(500);
        
        AddLog("âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ!");
    }

    // ===== Enhanced Production and Battle Event Testing Methods =====

    /// <summary>
    /// æµ‹è¯•æˆ˜æ–—äº‹ä»¶æ”¶é›†
    /// </summary>
    private async Task TestBattleEventCollection()
    {
        try
        {
            AddLog("âš”ï¸ å¼€å§‹æµ‹è¯•æˆ˜æ–—äº‹ä»¶æ”¶é›†...");
            _battleTestStatus = "æµ‹è¯•ä¸­";
            
            // 1. åˆ›å»ºæµ‹è¯•è§’è‰²
            var characterRequest = new CreateCharacterRequest { Name = "BattleTestChar" };
            var characterResponse = await ApiClient.Character.CreateCharacterAsync(characterRequest);
            if (!characterResponse.Success || characterResponse.Data == null)
            {
                AddLog("âŒ åˆ›å»ºæµ‹è¯•è§’è‰²å¤±è´¥");
                _battleTestStatus = "å¤±è´¥";
                return;
            }
            
            var characterId = characterResponse.Data.Id;
            AddLog($"âœ… åˆ›å»ºæµ‹è¯•è§’è‰²æˆåŠŸ: {characterId}");
            
            // 2. å¼€å§‹æˆ˜æ–—
            var battleRequest = new StartBattleRequest
            {
                CharacterId = characterId,
                EnemyId = "slime"  // ä½¿ç”¨æ ‡å‡†æ•Œäºº
            };
            
            var battleResponse = await ApiClient.Battle.StartBattleAsync(battleRequest);
            if (!battleResponse.Success || battleResponse.Data == null)
            {
                AddLog($"âŒ å¼€å§‹æˆ˜æ–—å¤±è´¥: {battleResponse.Message}");
                _battleTestStatus = "å¤±è´¥";
                return;
            }
            
            var battleId = battleResponse.Data.BattleId;
            AddLog($"âœ… æˆ˜æ–—å¼€å§‹æˆåŠŸ: {battleId}");
            
            // 3. ç›‘æ§æˆ˜æ–—è¿›åº¦å’Œäº‹ä»¶æ”¶é›†
            var progressChecks = 5;
            for (int i = 0; i < progressChecks; i++)
            {
                await Task.Delay(2000); // ç­‰å¾…2ç§’è®©æˆ˜æ–—è¿›è¡Œ
                
                var stateResponse = await ApiClient.Battle.GetBattleStateAsync(battleId);
                if (stateResponse.Success && stateResponse.Data != null)
                {
                    var battle = stateResponse.Data;
                    AddLog($"ğŸ”„ æˆ˜æ–—è¿›åº¦æ£€æŸ¥ {i+1}: ç©å®¶è¡€é‡ {battle.PlayerHealth}/{battle.PlayerMaxHealth}, " +
                           $"æ•Œäººè¡€é‡ {battle.EnemyHealth}/{battle.EnemyMaxHealth}");
                    
                    if (!battle.IsActive)
                    {
                        AddLog("âœ… æˆ˜æ–—å·²ç»“æŸï¼Œäº‹ä»¶æ”¶é›†å®Œæˆ");
                        break;
                    }
                }
                else
                {
                    AddLog($"âš ï¸ è·å–æˆ˜æ–—çŠ¶æ€å¤±è´¥: {stateResponse.Message}");
                }
            }
            
            // 4. æ¸…ç†ï¼šåœæ­¢æˆ˜æ–—
            await ApiClient.Battle.StopBattleAsync(battleId);
            AddLog("ğŸ§¹ æµ‹è¯•æ¸…ç†å®Œæˆ");
            
            _battleTestStatus = "æˆåŠŸ";
            AddLog("âœ… æˆ˜æ–—äº‹ä»¶æ”¶é›†æµ‹è¯•å®Œæˆ");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æˆ˜æ–—äº‹ä»¶æ”¶é›†æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _battleTestStatus = "å¼‚å¸¸";
        }
    }

    /// <summary>
    /// æµ‹è¯•æˆ˜æ–—æµç¨‹ä¼˜åŒ–
    /// </summary>
    private async Task TestBattleFlowOptimization()
    {
        try
        {
            AddLog("âš”ï¸ å¼€å§‹æµ‹è¯•æˆ˜æ–—æµç¨‹ä¼˜åŒ–...");
            _battleTestStatus = "ä¼˜åŒ–æµ‹è¯•ä¸­";
            
            // åˆ›å»ºå¤šä¸ªå¹¶å‘æˆ˜æ–—æ¥æµ‹è¯•æ‰¹å¤„ç†ä¼˜åŒ–
            var tasks = new List<Task>();
            var battleIds = new List<Guid>();
            
            for (int i = 0; i < 3; i++)
            {
                var task = Task.Run(async () =>
                {
                    try
                    {
                        var charRequest = new CreateCharacterRequest { Name = $"OptimTestChar{i}" };
                        var charResponse = await ApiClient.Character.CreateCharacterAsync(charRequest);
                        if (charResponse.Success && charResponse.Data != null)
                        {
                            var battleRequest = new StartBattleRequest
                            {
                                CharacterId = charResponse.Data.Id,
                                EnemyId = "goblin"
                            };
                            
                            var battleResponse = await ApiClient.Battle.StartBattleAsync(battleRequest);
                            if (battleResponse.Success && battleResponse.Data != null)
                            {
                                lock (battleIds)
                                {
                                    battleIds.Add(battleResponse.Data.BattleId);
                                }
                                AddLog($"âœ… å¹¶å‘æˆ˜æ–— {i+1} å¯åŠ¨æˆåŠŸ");
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        AddLog($"âŒ å¹¶å‘æˆ˜æ–— {i+1} å¤±è´¥: {ex.Message}");
                    }
                });
                tasks.Add(task);
            }
            
            await Task.WhenAll(tasks);
            AddLog($"ğŸ“Š æˆåŠŸåˆ›å»º {battleIds.Count} ä¸ªå¹¶å‘æˆ˜æ–—");
            
            // ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æˆ˜æ–—è¿›è¡Œ
            await Task.Delay(5000);
            
            // æ£€æŸ¥æ‰€æœ‰æˆ˜æ–—çŠ¶æ€
            var activeBattles = 0;
            foreach (var battleId in battleIds)
            {
                var stateResponse = await ApiClient.Battle.GetBattleStateAsync(battleId);
                if (stateResponse.Success && stateResponse.Data?.IsActive == true)
                {
                    activeBattles++;
                    await ApiClient.Battle.StopBattleAsync(battleId);
                }
            }
            
            AddLog($"ğŸ¯ æˆ˜æ–—æµç¨‹ä¼˜åŒ–æµ‹è¯•å®Œæˆï¼Œå¤„ç†äº† {battleIds.Count} ä¸ªæˆ˜æ–—");
            _battleTestStatus = "ä¼˜åŒ–æˆåŠŸ";
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æˆ˜æ–—æµç¨‹ä¼˜åŒ–æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _battleTestStatus = "ä¼˜åŒ–å¤±è´¥";
        }
    }

    /// <summary>
    /// æµ‹è¯•æˆ˜æ–—é”™è¯¯å¤„ç†
    /// </summary>
    private async Task TestBattleErrorHandling()
    {
        try
        {
            AddLog("âš”ï¸ å¼€å§‹æµ‹è¯•æˆ˜æ–—é”™è¯¯å¤„ç†...");
            _battleTestStatus = "é”™è¯¯å¤„ç†æµ‹è¯•ä¸­";
            
            // 1. æµ‹è¯•æ— æ•ˆè§’è‰²ID
            var invalidBattleRequest = new StartBattleRequest
            {
                CharacterId = "invalid-character-id",
                EnemyId = "slime"
            };
            
            var invalidResponse = await ApiClient.Battle.StartBattleAsync(invalidBattleRequest);
            if (!invalidResponse.Success)
            {
                AddLog($"âœ… æ­£ç¡®å¤„ç†æ— æ•ˆè§’è‰²ID: {invalidResponse.Message}");
            }
            else
            {
                AddLog("âŒ æœªèƒ½æ­£ç¡®å¤„ç†æ— æ•ˆè§’è‰²ID");
            }
            
            // 2. æµ‹è¯•è·å–ä¸å­˜åœ¨çš„æˆ˜æ–—çŠ¶æ€
            var nonExistentBattleId = Guid.NewGuid();
            var stateResponse = await ApiClient.Battle.GetBattleStateAsync(nonExistentBattleId);
            if (!stateResponse.Success)
            {
                AddLog($"âœ… æ­£ç¡®å¤„ç†ä¸å­˜åœ¨çš„æˆ˜æ–—ID: {stateResponse.Message}");
            }
            else
            {
                AddLog("âŒ æœªèƒ½æ­£ç¡®å¤„ç†ä¸å­˜åœ¨çš„æˆ˜æ–—ID");
            }
            
            // 3. æµ‹è¯•åœæ­¢ä¸å­˜åœ¨çš„æˆ˜æ–—
            var stopResponse = await ApiClient.Battle.StopBattleAsync(nonExistentBattleId);
            AddLog($"ğŸ›‘ åœæ­¢ä¸å­˜åœ¨æˆ˜æ–—çš„å“åº”: {stopResponse.Message}");
            
            _battleTestStatus = "é”™è¯¯å¤„ç†å®Œæˆ";
            AddLog("âœ… æˆ˜æ–—é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æˆ˜æ–—é”™è¯¯å¤„ç†æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _battleTestStatus = "é”™è¯¯å¤„ç†å¼‚å¸¸";
        }
    }

    /// <summary>
    /// æµ‹è¯•ç”Ÿäº§äº‹ä»¶æ”¶é›†
    /// </summary>
    private async Task TestProductionEventCollection()
    {
        try
        {
            AddLog("âš’ï¸ å¼€å§‹æµ‹è¯•ç”Ÿäº§äº‹ä»¶æ”¶é›†...");
            _productionTestStatus = "æµ‹è¯•ä¸­";
            
            // 1. è·å–é‡‡é›†èŠ‚ç‚¹
            var nodesResponse = await ProductionApi.GetGatheringNodesAsync();
            if (!nodesResponse.Success || nodesResponse.Data == null)
            {
                AddLog($"âŒ è·å–é‡‡é›†èŠ‚ç‚¹å¤±è´¥: {nodesResponse.Message}");
                _productionTestStatus = "å¤±è´¥";
                return;
            }
            
            AddLog($"âœ… è·å–åˆ° {nodesResponse.Data.Count} ä¸ªé‡‡é›†èŠ‚ç‚¹");
            
            // 2. åˆ›å»ºæµ‹è¯•è§’è‰²
            var charRequest = new CreateCharacterRequest { Name = "ProductionTestChar" };
            var charResponse = await ApiClient.Character.CreateCharacterAsync(charRequest);
            if (!charResponse.Success || charResponse.Data == null)
            {
                AddLog("âŒ åˆ›å»ºç”Ÿäº§æµ‹è¯•è§’è‰²å¤±è´¥");
                _productionTestStatus = "å¤±è´¥";
                return;
            }
            
            var characterId = charResponse.Data.Id;
            AddLog($"âœ… åˆ›å»ºç”Ÿäº§æµ‹è¯•è§’è‰²æˆåŠŸ: {characterId}");
            
            // 3. æµ‹è¯•é‡‡é›†æ“ä½œï¼ˆå¦‚æœæœåŠ¡ç«¯æ”¯æŒï¼‰
            if (nodesResponse.Data.Any())
            {
                var firstNode = nodesResponse.Data.First();
                AddLog($"ğŸ”¨ å°è¯•åœ¨èŠ‚ç‚¹ {firstNode.Name} å¼€å§‹é‡‡é›†");
                
                // è¿™é‡Œéœ€è¦å®é™…çš„é‡‡é›†APIï¼Œç›®å‰æˆ‘ä»¬åªæ˜¯æ¨¡æ‹Ÿ
                await Task.Delay(3000); // æ¨¡æ‹Ÿé‡‡é›†æ—¶é—´
                AddLog("âœ… é‡‡é›†äº‹ä»¶æ”¶é›†æ¨¡æ‹Ÿå®Œæˆ");
            }
            
            _productionTestStatus = "æˆåŠŸ";
            AddLog("âœ… ç”Ÿäº§äº‹ä»¶æ”¶é›†æµ‹è¯•å®Œæˆ");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ ç”Ÿäº§äº‹ä»¶æ”¶é›†æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _productionTestStatus = "å¼‚å¸¸";
        }
    }

    /// <summary>
    /// æµ‹è¯•é‡‡é›†ä¼˜åŒ–
    /// </summary>
    private async Task TestGatheringOptimization()
    {
        try
        {
            AddLog("âš’ï¸ å¼€å§‹æµ‹è¯•é‡‡é›†ä¼˜åŒ–...");
            _productionTestStatus = "ä¼˜åŒ–æµ‹è¯•ä¸­";
            
            // æ¨¡æ‹Ÿå¤šä¸ªè§’è‰²åŒæ—¶é‡‡é›†æ¥æµ‹è¯•æ‰¹å¤„ç†
            var gatheringTasks = new List<Task>();
            
            for (int i = 0; i < 5; i++)
            {
                var task = Task.Run(async () =>
                {
                    try
                    {
                        var charRequest = new CreateCharacterRequest { Name = $"GatherChar{i}" };
                        var charResponse = await ApiClient.Character.CreateCharacterAsync(charRequest);
                        if (charResponse.Success)
                        {
                            AddLog($"âœ… é‡‡é›†è§’è‰² {i+1} åˆ›å»ºæˆåŠŸ");
                            await Task.Delay(Random.Shared.Next(1000, 3000)); // æ¨¡æ‹Ÿé‡‡é›†æ—¶é—´
                            AddLog($"ğŸ”¨ é‡‡é›†è§’è‰² {i+1} å®Œæˆé‡‡é›†");
                        }
                    }
                    catch (Exception ex)
                    {
                        AddLog($"âŒ é‡‡é›†è§’è‰² {i+1} å¼‚å¸¸: {ex.Message}");
                    }
                });
                gatheringTasks.Add(task);
            }
            
            await Task.WhenAll(gatheringTasks);
            
            _productionTestStatus = "ä¼˜åŒ–æˆåŠŸ";
            AddLog("âœ… é‡‡é›†ä¼˜åŒ–æµ‹è¯•å®Œæˆ");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ é‡‡é›†ä¼˜åŒ–æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _productionTestStatus = "ä¼˜åŒ–å¤±è´¥";
        }
    }

    /// <summary>
    /// æµ‹è¯•åˆ¶ä½œæ‰¹å¤„ç†
    /// </summary>
    private async Task TestCraftingBatchProcessing()
    {
        try
        {
            AddLog("ğŸ”§ å¼€å§‹æµ‹è¯•åˆ¶ä½œæ‰¹å¤„ç†...");
            _productionTestStatus = "æ‰¹å¤„ç†æµ‹è¯•ä¸­";
            
            // æ¨¡æ‹Ÿæ‰¹é‡åˆ¶ä½œæ“ä½œ
            var craftingBatch = Enumerable.Range(1, 10);
            var completedItems = 0;
            
            await Task.Run(async () =>
            {
                foreach (var item in craftingBatch)
                {
                    // æ¨¡æ‹Ÿåˆ¶ä½œç‰©å“
                    await Task.Delay(200); // å¿«é€Ÿæ‰¹å¤„ç†
                    completedItems++;
                    
                    if (item % 3 == 0) // æ¯3ä¸ªç‰©å“æŠ¥å‘Šä¸€æ¬¡è¿›åº¦
                    {
                        AddLog($"ğŸ”§ æ‰¹å¤„ç†è¿›åº¦: {completedItems}/10 ç‰©å“å®Œæˆ");
                    }
                }
            });
            
            AddLog($"âœ… åˆ¶ä½œæ‰¹å¤„ç†å®Œæˆï¼Œå…±åˆ¶ä½œ {completedItems} ä¸ªç‰©å“");
            _productionTestStatus = "æ‰¹å¤„ç†æˆåŠŸ";
        }
        catch (Exception ex)
        {
            AddLog($"âŒ åˆ¶ä½œæ‰¹å¤„ç†æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _productionTestStatus = "æ‰¹å¤„ç†å¤±è´¥";
        }
    }

    /// <summary>
    /// æµ‹è¯•äº‹ä»¶ç³»ç»Ÿæ€§èƒ½
    /// </summary>
    private async Task TestEventSystemPerformance()
    {
        try
        {
            AddLog("ğŸ“Š å¼€å§‹æµ‹è¯•äº‹ä»¶ç³»ç»Ÿæ€§èƒ½...");
            var startTime = DateTime.UtcNow;
            
            // æ‰§è¡Œä¸€ç³»åˆ—APIè°ƒç”¨æ¥æµ‹è¯•æ€§èƒ½
            var performanceTasks = new Task[]
            {
                ApiClient.Character.GetCharactersAsync(),
                ApiClient.Battle.GetActiveBattlesAsync(),
                ApiClient.Party.GetAllPartiesAsync(),
                ProductionApi.GetGatheringNodesAsync(),
                ApiClient.Monitoring.GetGameStatusAsync()
            };
            
            await Task.WhenAll(performanceTasks);
            
            var elapsed = DateTime.UtcNow - startTime;
            _performanceMetrics = $"{elapsed.TotalMilliseconds:F0}ms";
            
            AddLog($"âš¡ æ€§èƒ½æµ‹è¯•å®Œæˆï¼Œæ€»è€—æ—¶: {_performanceMetrics}");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ äº‹ä»¶ç³»ç»Ÿæ€§èƒ½æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _performanceMetrics = "æµ‹è¯•å¤±è´¥";
        }
    }

    /// <summary>
    /// æµ‹è¯•æ‰¹å¤„ç†æ•ˆç‡
    /// </summary>
    private async Task TestBatchProcessingEfficiency()
    {
        try
        {
            AddLog("ğŸ“ˆ å¼€å§‹æµ‹è¯•æ‰¹å¤„ç†æ•ˆç‡...");
            var startTime = DateTime.UtcNow;
            
            // æ¨¡æ‹Ÿå¤§é‡å°ä»»åŠ¡çš„æ‰¹å¤„ç†
            var batchTasks = Enumerable.Range(1, 50).Select(async i =>
            {
                await Task.Delay(10); // æ¨¡æ‹Ÿå°ä»»åŠ¡
                return i;
            });
            
            var results = await Task.WhenAll(batchTasks);
            var elapsed = DateTime.UtcNow - startTime;
            
            var efficiency = results.Length / elapsed.TotalSeconds;
            _performanceMetrics = $"{efficiency:F1} ops/sec";
            
            AddLog($"âš¡ æ‰¹å¤„ç†æ•ˆç‡æµ‹è¯•å®Œæˆ: {_performanceMetrics}");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æ‰¹å¤„ç†æ•ˆç‡æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _performanceMetrics = "æ•ˆç‡æµ‹è¯•å¤±è´¥";
        }
    }

    /// <summary>
    /// æµ‹è¯•é”™è¯¯æ¢å¤
    /// </summary>
    private async Task TestErrorRecovery()
    {
        try
        {
            AddLog("ğŸ”„ å¼€å§‹æµ‹è¯•é”™è¯¯æ¢å¤...");
            var errorCount = 0;
            var recoveryCount = 0;
            
            // æ¨¡æ‹Ÿä¸€ç³»åˆ—å¯èƒ½å¤±è´¥çš„æ“ä½œ
            for (int i = 0; i < 5; i++)
            {
                try
                {
                    // æ•…æ„ä½¿ç”¨æ— æ•ˆæ•°æ®æ¥è§¦å‘é”™è¯¯
                    var invalidResponse = await ApiClient.Battle.GetBattleStateAsync(Guid.Empty);
                    if (!invalidResponse.Success)
                    {
                        errorCount++;
                        // æ¨¡æ‹Ÿé”™è¯¯æ¢å¤
                        await Task.Delay(100);
                        recoveryCount++;
                    }
                }
                catch
                {
                    errorCount++;
                    recoveryCount++; // å¼‚å¸¸ä¹Ÿç®—ä½œæ¢å¤å¤„ç†
                }
            }
            
            _performanceMetrics = $"{recoveryCount}/{errorCount} æ¢å¤";
            AddLog($"ğŸ”„ é”™è¯¯æ¢å¤æµ‹è¯•å®Œæˆ: {_performanceMetrics}");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ é”™è¯¯æ¢å¤æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _performanceMetrics = "æ¢å¤æµ‹è¯•å¤±è´¥";
        }
    }

    /// <summary>
    /// æµ‹è¯•å®Œæ•´ç”Ÿäº§æµç¨‹
    /// </summary>
    private async Task TestFullProductionFlow()
    {
        try
        {
            AddLog("ğŸ”„ å¼€å§‹æµ‹è¯•å®Œæ•´ç”Ÿäº§æµç¨‹...");
            _integrationTestStatus = "æµç¨‹æµ‹è¯•ä¸­";
            
            // 1. åˆ›å»ºè§’è‰²
            var charRequest = new CreateCharacterRequest { Name = "FullFlowTestChar" };
            var charResponse = await ApiClient.Character.CreateCharacterAsync(charRequest);
            if (!charResponse.Success)
            {
                AddLog("âŒ åˆ›å»ºæµç¨‹æµ‹è¯•è§’è‰²å¤±è´¥");
                _integrationTestStatus = "å¤±è´¥";
                return;
            }
            
            // 2. è·å–èµ„æº
            var nodesResponse = await ProductionApi.GetGatheringNodesAsync();
            AddLog($"âœ… è·å–åˆ° {nodesResponse.Data?.Count ?? 0} ä¸ªç”Ÿäº§èŠ‚ç‚¹");
            
            // 3. æ¨¡æ‹Ÿé‡‡é›†
            await Task.Delay(2000);
            AddLog("ğŸ”¨ å®Œæˆèµ„æºé‡‡é›†é˜¶æ®µ");
            
            // 4. æ¨¡æ‹Ÿåˆ¶ä½œ
            await Task.Delay(1500);
            AddLog("ğŸ”§ å®Œæˆç‰©å“åˆ¶ä½œé˜¶æ®µ");
            
            // 5. æ¨¡æ‹Ÿåº“å­˜æ›´æ–°
            await Task.Delay(500);
            AddLog("ğŸ“¦ å®Œæˆåº“å­˜æ›´æ–°é˜¶æ®µ");
            
            _integrationTestStatus = "æµç¨‹å®Œæˆ";
            AddLog("âœ… å®Œæ•´ç”Ÿäº§æµç¨‹æµ‹è¯•æˆåŠŸ");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ å®Œæ•´ç”Ÿäº§æµç¨‹æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _integrationTestStatus = "æµç¨‹å¼‚å¸¸";
        }
    }

    /// <summary>
    /// æµ‹è¯•æˆ˜æ–—ç”Ÿäº§é›†æˆ
    /// </summary>
    private async Task TestBattleProductionIntegration()
    {
        try
        {
            AddLog("âš”ï¸âš’ï¸ å¼€å§‹æµ‹è¯•æˆ˜æ–—ç”Ÿäº§é›†æˆ...");
            _integrationTestStatus = "é›†æˆæµ‹è¯•ä¸­";
            
            // åˆ›å»ºæµ‹è¯•è§’è‰²
            var charRequest = new CreateCharacterRequest { Name = "IntegrationTestChar" };
            var charResponse = await ApiClient.Character.CreateCharacterAsync(charRequest);
            if (!charResponse.Success || charResponse.Data == null)
            {
                AddLog("âŒ åˆ›å»ºé›†æˆæµ‹è¯•è§’è‰²å¤±è´¥");
                _integrationTestStatus = "å¤±è´¥";
                return;
            }
            
            var characterId = charResponse.Data.Id;
            
            // 1. å¼€å§‹æˆ˜æ–—
            var battleRequest = new StartBattleRequest
            {
                CharacterId = characterId,
                EnemyId = "slime"
            };
            
            var battleResponse = await ApiClient.Battle.StartBattleAsync(battleRequest);
            if (battleResponse.Success && battleResponse.Data != null)
            {
                AddLog("âš”ï¸ æˆ˜æ–—é˜¶æ®µå¼€å§‹");
                await Task.Delay(3000); // è®©æˆ˜æ–—è¿›è¡Œä¸€æ®µæ—¶é—´
                
                // åœæ­¢æˆ˜æ–—
                await ApiClient.Battle.StopBattleAsync(battleResponse.Data.BattleId);
                AddLog("âš”ï¸ æˆ˜æ–—é˜¶æ®µå®Œæˆ");
            }
            
            // 2. åˆ‡æ¢åˆ°ç”Ÿäº§æ´»åŠ¨
            AddLog("ğŸ”„ åˆ‡æ¢åˆ°ç”Ÿäº§é˜¶æ®µ");
            await Task.Delay(2000); // æ¨¡æ‹Ÿç”Ÿäº§æ´»åŠ¨
            AddLog("âš’ï¸ ç”Ÿäº§é˜¶æ®µå®Œæˆ");
            
            _integrationTestStatus = "é›†æˆæˆåŠŸ";
            AddLog("âœ… æˆ˜æ–—ç”Ÿäº§é›†æˆæµ‹è¯•å®Œæˆ");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æˆ˜æ–—ç”Ÿäº§é›†æˆæµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _integrationTestStatus = "é›†æˆå¼‚å¸¸";
        }
    }

    /// <summary>
    /// æµ‹è¯•å‹åŠ›åœºæ™¯
    /// </summary>
    private async Task TestStressScenarios()
    {
        try
        {
            AddLog("ğŸ’¥ å¼€å§‹æµ‹è¯•å‹åŠ›åœºæ™¯...");
            _integrationTestStatus = "å‹åŠ›æµ‹è¯•ä¸­";
            
            var stressTasks = new List<Task>();
            var successCount = 0;
            var failureCount = 0;
            
            // åˆ›å»ºå¤šä¸ªå¹¶å‘ä»»åŠ¡æ¥æ¨¡æ‹Ÿé«˜è´Ÿè½½
            for (int i = 0; i < 10; i++)
            {
                var task = Task.Run(async () =>
                {
                    try
                    {
                        // éšæœºé€‰æ‹©ä¸åŒç±»å‹çš„æ“ä½œ
                        var operationType = Random.Shared.Next(3);
                        switch (operationType)
                        {
                            case 0: // è§’è‰²æ“ä½œ
                                var charResponse = await ApiClient.Character.GetCharactersAsync();
                                if (charResponse.Success) Interlocked.Increment(ref successCount);
                                else Interlocked.Increment(ref failureCount);
                                break;
                                
                            case 1: // æˆ˜æ–—æ“ä½œ
                                var battleResponse = await ApiClient.Battle.GetActiveBattlesAsync();
                                if (battleResponse.Success) Interlocked.Increment(ref successCount);
                                else Interlocked.Increment(ref failureCount);
                                break;
                                
                            case 2: // ç”Ÿäº§æ“ä½œ
                                var nodeResponse = await ProductionApi.GetGatheringNodesAsync();
                                if (nodeResponse.Success) Interlocked.Increment(ref successCount);
                                else Interlocked.Increment(ref failureCount);
                                break;
                        }
                        
                        await Task.Delay(Random.Shared.Next(100, 500)); // éšæœºå»¶è¿Ÿ
                    }
                    catch
                    {
                        Interlocked.Increment(ref failureCount);
                    }
                });
                stressTasks.Add(task);
            }
            
            await Task.WhenAll(stressTasks);
            
            var totalOperations = successCount + failureCount;
            var successRate = totalOperations > 0 ? (double)successCount / totalOperations * 100 : 0;
            
            AddLog($"ğŸ’¥ å‹åŠ›æµ‹è¯•å®Œæˆ: {successCount}/{totalOperations} æˆåŠŸ ({successRate:F1}%)");
            _integrationTestStatus = $"{successRate:F0}% æˆåŠŸç‡";
        }
        catch (Exception ex)
        {
            AddLog($"âŒ å‹åŠ›åœºæ™¯æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _integrationTestStatus = "å‹åŠ›æµ‹è¯•å¼‚å¸¸";
        }
    }
    
    // Shop API Test Methods
    private async Task TestGetShopItems()
    {
        try
        {
            AddLog("ğŸ›’ è·å–å•†åº—ç‰©å“...");
            var response = await ShopApi.GetShopItemsAsync();
            
            if (response.Success && response.Data != null)
            {
                _shopItemCount = response.Data.Count;
                _lastShopTestSuccess = true;
                _lastShopTestMessage = $"æˆåŠŸè·å– {_shopItemCount} ä¸ªå•†åº—ç‰©å“";
                _shopTestSuccessCount++;
                AddLog($"âœ… è·å–åˆ° {_shopItemCount} ä¸ªå•†åº—ç‰©å“");
                
                foreach (var item in response.Data.Take(3))
                {
                    AddLog($"   - {item.Name} ({item.Category}) - {item.Price} {(item.Currency == CurrencyTypeDto.Gold ? "é‡‘å¸" : "ç‰©å“")}");
                }
                
                if (response.Data.Count > 3)
                {
                    AddLog($"   ... è¿˜æœ‰ {response.Data.Count - 3} ä¸ªç‰©å“");
                }
            }
            else
            {
                _lastShopTestSuccess = false;
                _lastShopTestMessage = response.Message;
                _shopTestFailureCount++;
                AddLog($"âš ï¸ è·å–å•†åº—ç‰©å“å¤±è´¥: {response.Message}");
            }
            
            _shopStatus = "å·²æµ‹è¯•";
        }
        catch (Exception ex)
        {
            _lastShopTestSuccess = false;
            _lastShopTestMessage = $"å¼‚å¸¸: {ex.Message}";
            _shopTestFailureCount++;
            AddLog($"âŒ å•†åº—ç‰©å“æµ‹è¯•å¤±è´¥: {ex.Message}");
            _shopStatus = "æµ‹è¯•å¼‚å¸¸";
        }
    }
    
    private async Task TestGetShopCategories()
    {
        try
        {
            AddLog("ğŸ·ï¸ è·å–å•†åº—åˆ†ç±»...");
            var response = await ShopApi.GetShopCategoriesAsync();
            
            if (response.Success && response.Data != null)
            {
                _shopCategoryCount = response.Data.Count;
                _lastShopTestSuccess = true;
                _lastShopTestMessage = $"æˆåŠŸè·å– {_shopCategoryCount} ä¸ªå•†åº—åˆ†ç±»";
                _shopTestSuccessCount++;
                AddLog($"âœ… è·å–åˆ° {_shopCategoryCount} ä¸ªå•†åº—åˆ†ç±»");
                
                foreach (var category in response.Data)
                {
                    AddLog($"   - {category.Name} ({category.ItemCount} ä¸ªç‰©å“)");
                }
            }
            else
            {
                _lastShopTestSuccess = false;
                _lastShopTestMessage = response.Message;
                _shopTestFailureCount++;
                AddLog($"âš ï¸ è·å–å•†åº—åˆ†ç±»å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            _lastShopTestSuccess = false;
            _lastShopTestMessage = $"å¼‚å¸¸: {ex.Message}";
            _shopTestFailureCount++;
            AddLog($"âŒ å•†åº—åˆ†ç±»æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }
    
    private async Task TestPurchaseItem()
    {
        try
        {
            AddLog("ğŸ’° æµ‹è¯•è´­ä¹°ç‰©å“...");
            
            // é¦–å…ˆè·å–å¯è´­ä¹°çš„ç‰©å“
            var itemsResponse = await ShopApi.GetShopItemsAsync();
            if (!itemsResponse.Success || itemsResponse.Data == null || !itemsResponse.Data.Any())
            {
                AddLog("âš ï¸ æ²¡æœ‰å¯è´­ä¹°çš„ç‰©å“ï¼Œè·³è¿‡è´­ä¹°æµ‹è¯•");
                return;
            }
            
            var testItem = itemsResponse.Data.First();
            AddLog($"ğŸ“¦ å°è¯•è´­ä¹°ç‰©å“: {testItem.Name}");
            
            var purchaseRequest = new PurchaseRequestDto
            {
                CharacterId = "test-character-id",
                ItemId = testItem.Id,
                Quantity = 1
            };
            
            var response = await ShopApi.PurchaseItemAsync(purchaseRequest);
            
            if (response.Success && response.Data != null)
            {
                _lastShopTestSuccess = true;
                _lastShopTestMessage = $"è´­ä¹°æµ‹è¯•: {response.Data.Message}";
                _shopTestSuccessCount++;
                AddLog($"âœ… è´­ä¹°æµ‹è¯•ç»“æœ: {response.Data.Message}");
                AddLog($"ğŸ’° å‰©ä½™é‡‘å¸: {response.Data.RemainingGold}");
            }
            else
            {
                _lastShopTestSuccess = false;
                _lastShopTestMessage = response.Message;
                _shopTestFailureCount++;
                AddLog($"âš ï¸ è´­ä¹°æµ‹è¯•å¤±è´¥: {response.Message}");
                AddLog("â„¹ï¸ è¿™é€šå¸¸æ˜¯å› ä¸ºæµ‹è¯•è§’è‰²ä¸å­˜åœ¨æˆ–é‡‘å¸ä¸è¶³ï¼Œè¿™æ˜¯æ­£å¸¸çš„");
            }
        }
        catch (Exception ex)
        {
            _lastShopTestSuccess = false;
            _lastShopTestMessage = $"å¼‚å¸¸: {ex.Message}";
            _shopTestFailureCount++;
            AddLog($"âŒ è´­ä¹°æµ‹è¯•å¼‚å¸¸: {ex.Message}");
        }
    }
    
    private async Task TestSellItem()
    {
        try
        {
            AddLog("ğŸ’ æµ‹è¯•å‡ºå”®ç‰©å“...");
            
            var sellRequest = new SellRequestDto
            {
                CharacterId = "test-character-id",
                ItemId = "EQ_WEP_001", // å‡è®¾å­˜åœ¨çš„ç‰©å“ID
                Quantity = 1
            };
            
            var response = await ShopApi.SellItemAsync(sellRequest);
            
            if (response.Success && response.Data != null)
            {
                _lastShopTestSuccess = true;
                _lastShopTestMessage = $"å‡ºå”®æµ‹è¯•: {response.Data.Message}";
                _shopTestSuccessCount++;
                AddLog($"âœ… å‡ºå”®æµ‹è¯•ç»“æœ: {response.Data.Message}");
                AddLog($"ğŸ’° è·å¾—é‡‘å¸: {response.Data.GoldEarned}");
                AddLog($"ğŸ’° å‰©ä½™é‡‘å¸: {response.Data.RemainingGold}");
            }
            else
            {
                _lastShopTestSuccess = false;
                _lastShopTestMessage = response.Message;
                _shopTestFailureCount++;
                AddLog($"âš ï¸ å‡ºå”®æµ‹è¯•å¤±è´¥: {response.Message}");
                AddLog("â„¹ï¸ è¿™é€šå¸¸æ˜¯å› ä¸ºæµ‹è¯•è§’è‰²ä¸å­˜åœ¨æˆ–ç‰©å“ä¸è¶³ï¼Œè¿™æ˜¯æ­£å¸¸çš„");
            }
        }
        catch (Exception ex)
        {
            _lastShopTestSuccess = false;
            _lastShopTestMessage = $"å¼‚å¸¸: {ex.Message}";
            _shopTestFailureCount++;
            AddLog($"âŒ å‡ºå”®æµ‹è¯•å¼‚å¸¸: {ex.Message}");
        }
    }
    
    // ===== Reputation API Test Methods =====
    
    /// <summary>
    /// æµ‹è¯•è·å–å£°æœ›ä¿¡æ¯
    /// </summary>
    private async Task TestGetReputation()
    {
        try
        {
            AddLog("â­ è·å–å£°æœ›ä¿¡æ¯...");
            
            // ä½¿ç”¨æµ‹è¯•è§’è‰²IDï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            var testCharacterId = "test-character-id";
            var response = await ReputationApi.GetReputationAsync(testCharacterId);
            
            if (response.Success && response.Data != null)
            {
                var reputation = response.Data;
                _totalReputationValue = reputation.FactionReputation.Values.Sum();
                _lastReputationTestSuccess = true;
                _lastReputationTestMessage = $"æˆåŠŸè·å–å£°æœ›ä¿¡æ¯ï¼Œæ€»å£°æœ›: {_totalReputationValue}";
                _reputationTestSuccessCount++;
                
                AddLog($"âœ… è·å–å£°æœ›ä¿¡æ¯æˆåŠŸï¼Œæ€»å£°æœ›: {_totalReputationValue}");
                
                foreach (var faction in reputation.FactionReputation)
                {
                    AddLog($"   - {faction.Key}: {faction.Value} ç‚¹");
                }
            }
            else
            {
                _lastReputationTestSuccess = false;
                _lastReputationTestMessage = response.Message;
                _reputationTestFailureCount++;
                AddLog($"âš ï¸ è·å–å£°æœ›ä¿¡æ¯å¤±è´¥: {response.Message}");
            }
            
            _reputationStatus = "å·²æµ‹è¯•";
        }
        catch (Exception ex)
        {
            _lastReputationTestSuccess = false;
            _lastReputationTestMessage = $"å¼‚å¸¸: {ex.Message}";
            _reputationTestFailureCount++;
            AddLog($"âŒ å£°æœ›ä¿¡æ¯æµ‹è¯•å¼‚å¸¸: {ex.Message}");
            _reputationStatus = "æµ‹è¯•å¼‚å¸¸";
        }
    }
    
    /// <summary>
    /// æµ‹è¯•è·å–è¯¦ç»†å£°æœ›ä¿¡æ¯
    /// </summary>
    private async Task TestGetReputationDetails()
    {
        try
        {
            AddLog("â­ è·å–è¯¦ç»†å£°æœ›ä¿¡æ¯...");
            
            var testCharacterId = "test-character-id";
            var response = await ReputationApi.GetAllReputationDetailsAsync(testCharacterId);
            
            if (response.Success && response.Data != null)
            {
                _reputationDetailCount = response.Data.Count;
                _lastReputationTestSuccess = true;
                _lastReputationTestMessage = $"æˆåŠŸè·å– {_reputationDetailCount} ä¸ªé˜µè¥çš„è¯¦ç»†ä¿¡æ¯";
                _reputationTestSuccessCount++;
                
                AddLog($"âœ… è·å–åˆ° {_reputationDetailCount} ä¸ªé˜µè¥çš„è¯¦ç»†å£°æœ›ä¿¡æ¯");
                
                foreach (var detail in response.Data.Take(3)) // åªæ˜¾ç¤ºå‰3ä¸ª
                {
                    AddLog($"   - {detail.FactionName}: {detail.CurrentTier.Name} ({detail.CurrentValue}/{detail.CurrentTier.MaxValue})");
                    AddLog($"     è¿›åº¦: {detail.ProgressPercentage:F1}%");
                }
                
                if (response.Data.Count > 3)
                {
                    AddLog($"   ... è¿˜æœ‰ {response.Data.Count - 3} ä¸ªé˜µè¥");
                }
            }
            else
            {
                _lastReputationTestSuccess = false;
                _lastReputationTestMessage = response.Message;
                _reputationTestFailureCount++;
                AddLog($"âš ï¸ è·å–è¯¦ç»†å£°æœ›ä¿¡æ¯å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            _lastReputationTestSuccess = false;
            _lastReputationTestMessage = $"å¼‚å¸¸: {ex.Message}";
            _reputationTestFailureCount++;
            AddLog($"âŒ è¯¦ç»†å£°æœ›ä¿¡æ¯æµ‹è¯•å¼‚å¸¸: {ex.Message}");
        }
    }
    
    /// <summary>
    /// æµ‹è¯•å£°æœ›æ›´æ–°
    /// </summary>
    private async Task TestUpdateReputation()
    {
        try
        {
            AddLog("â­ æµ‹è¯•å£°æœ›æ›´æ–°...");
            
            var testCharacterId = "test-character-id";
            var updateRequest = new UpdateReputationRequest
            {
                CharacterId = testCharacterId,
                FactionName = "StormwindGuard",
                Amount = 100,
                Reason = "APIæµ‹è¯•å¥–åŠ±"
            };
            
            var response = await ReputationApi.UpdateReputationAsync(updateRequest);
            
            if (response.Success && response.Data != null)
            {
                _lastReputationTestSuccess = true;
                _lastReputationTestMessage = "å£°æœ›æ›´æ–°æµ‹è¯•æˆåŠŸ";
                _reputationTestSuccessCount++;
                
                AddLog($"âœ… å£°æœ›æ›´æ–°æˆåŠŸ: æš´é£åŸå«å…µ +100");
                
                // æ˜¾ç¤ºæ›´æ–°åçš„å£°æœ›å€¼
                var guardReputation = response.Data.FactionReputation.GetValueOrDefault("StormwindGuard", 0);
                AddLog($"ğŸ’° æš´é£åŸå«å…µå½“å‰å£°æœ›: {guardReputation}");
            }
            else
            {
                _lastReputationTestSuccess = false;
                _lastReputationTestMessage = response.Message;
                _reputationTestFailureCount++;
                AddLog($"âš ï¸ å£°æœ›æ›´æ–°æµ‹è¯•å¤±è´¥: {response.Message}");
                AddLog("â„¹ï¸ è¿™é€šå¸¸æ˜¯å› ä¸ºæµ‹è¯•è§’è‰²ä¸å­˜åœ¨ï¼Œè¿™æ˜¯æ­£å¸¸çš„");
            }
        }
        catch (Exception ex)
        {
            _lastReputationTestSuccess = false;
            _lastReputationTestMessage = $"å¼‚å¸¸: {ex.Message}";
            _reputationTestFailureCount++;
            AddLog($"âŒ å£°æœ›æ›´æ–°æµ‹è¯•å¼‚å¸¸: {ex.Message}");
        }
    }
    
    /// <summary>
    /// æµ‹è¯•å£°æœ›å¥–åŠ±ä¿¡æ¯
    /// </summary>
    private async Task TestReputationRewards()
    {
        try
        {
            AddLog("â­ è·å–å£°æœ›å¥–åŠ±ä¿¡æ¯...");
            
            var testCharacterId = "test-character-id";
            var response = await ReputationApi.GetAvailableRewardsAsync(testCharacterId);
            
            if (response.Success && response.Data != null)
            {
                var rewardCount = response.Data.Count;
                _lastReputationTestSuccess = true;
                _lastReputationTestMessage = $"è·å–åˆ° {rewardCount} ä¸ªå¯ç”¨å¥–åŠ±";
                _reputationTestSuccessCount++;
                
                AddLog($"âœ… è·å–åˆ° {rewardCount} ä¸ªå£°æœ›å¥–åŠ±");
                
                foreach (var reward in response.Data.Take(3))
                {
                    AddLog($"   - {reward.FactionName} {reward.TierName}:");
                    AddLog($"     éœ€è¦å£°æœ›: {reward.RequiredReputation}");
                    AddLog($"     å¥–åŠ±ç‰©å“: {reward.Items.Count} ä¸ª");
                    AddLog($"     ç‰¹æƒ: {string.Join(", ", reward.Perks)}");
                }
                
                if (response.Data.Count > 3)
                {
                    AddLog($"   ... è¿˜æœ‰ {response.Data.Count - 3} ä¸ªå¥–åŠ±");
                }
            }
            else
            {
                _lastReputationTestSuccess = false;
                _lastReputationTestMessage = response.Message;
                _reputationTestFailureCount++;
                AddLog($"âš ï¸ è·å–å£°æœ›å¥–åŠ±å¤±è´¥: {response.Message}");
                AddLog("â„¹ï¸ è¿™é€šå¸¸æ˜¯å› ä¸ºæµ‹è¯•è§’è‰²ä¸å­˜åœ¨ï¼Œè¿™æ˜¯æ­£å¸¸çš„");
            }
        }
        catch (Exception ex)
        {
            _lastReputationTestSuccess = false;
            _lastReputationTestMessage = $"å¼‚å¸¸: {ex.Message}";
            _reputationTestFailureCount++;
            AddLog($"âŒ å£°æœ›å¥–åŠ±æµ‹è¯•å¼‚å¸¸: {ex.Message}");
        }
    }
}
</div>