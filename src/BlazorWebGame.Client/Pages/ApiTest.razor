@page "/api-test"
@using BlazorWebGame.Client.Services.Api
@using BlazorWebGame.Shared.DTOs
@inject GameApiClient ApiClient
@inject GameApiService LegacyApi

<PageTitle>API æµ‹è¯•é¡µé¢</PageTitle>

<div class="container-fluid">
    <h3>ğŸ§ª API æœåŠ¡æµ‹è¯•é¡µé¢</h3>
    
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ” è®¤è¯æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary mb-2" @onclick="TestAuthentication">æµ‹è¯•æ¼”ç¤ºç™»å½•</button>
                    <button class="btn btn-info mb-2" @onclick="TestServerConnection">æ£€æŸ¥æœåŠ¡å™¨è¿æ¥</button>
                    <div class="alert alert-info small">
                        <strong>è®¤è¯çŠ¶æ€:</strong> @_authStatus
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>âš”ï¸ æˆ˜æ–—æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestGetActiveBattles">è·å–æ´»è·ƒæˆ˜æ–—</button>
                    <button class="btn btn-warning mb-2" @onclick="TestBattleOperations">æµ‹è¯•æˆ˜æ–—æ“ä½œ</button>
                    <div class="alert alert-success small">
                        <strong>æ´»è·ƒæˆ˜æ–—:</strong> @_activeBattleCount ä¸ª
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ‘¥ ç»„é˜ŸæœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestGetAllParties">è·å–æ‰€æœ‰é˜Ÿä¼</button>
                    <button class="btn btn-info mb-2" @onclick="TestPartyOperations">æµ‹è¯•ç»„é˜Ÿæ“ä½œ</button>
                    <div class="alert alert-success small">
                        <strong>æ´»è·ƒé˜Ÿä¼:</strong> @_partyCount ä¸ª
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ‘¤ è§’è‰²æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestGetCharacters">è·å–è§’è‰²åˆ—è¡¨</button>
                    <button class="btn btn-info mb-2" @onclick="TestCharacterDetails">è·å–è§’è‰²è¯¦æƒ…</button>
                    <div class="alert alert-success small">
                        <strong>è§’è‰²æ•°é‡:</strong> @_characterCount ä¸ª
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ’ åº“å­˜æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestInventoryOperations">æµ‹è¯•åº“å­˜æ“ä½œ</button>
                    <button class="btn btn-warning mb-2" @onclick="TestItemOperations">æµ‹è¯•ç‰©å“æ“ä½œ</button>
                    <div class="alert alert-info small">
                        <strong>åº“å­˜çŠ¶æ€:</strong> @_inventoryStatus
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>âš’ï¸ ç”Ÿäº§æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestGetGatheringNodes">è·å–é‡‡é›†èŠ‚ç‚¹</button>
                    <button class="btn btn-info mb-2" @onclick="TestProductionOperations">æµ‹è¯•ç”Ÿäº§æ“ä½œ</button>
                    <div class="alert alert-success small">
                        <strong>é‡‡é›†èŠ‚ç‚¹:</strong> @_nodeCount ä¸ª
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“‹ ä»»åŠ¡æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success mb-2" @onclick="TestQuestOperations">æµ‹è¯•ä»»åŠ¡æ“ä½œ</button>
                    <div class="alert alert-info small">
                        <strong>ä»»åŠ¡çŠ¶æ€:</strong> @_questStatus
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“Š ç›‘æ§æœåŠ¡æµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-info mb-2" @onclick="TestMonitoringServices">æµ‹è¯•ç›‘æ§æœåŠ¡</button>
                    <div class="alert alert-warning small">
                        <strong>æœåŠ¡å™¨çŠ¶æ€:</strong> @_serverStatus
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“ æµ‹è¯•æ—¥å¿—</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-secondary" style="max-height: 300px; overflow-y: auto;">
                        @foreach (var log in _testLogs)
                        {
                            <div>@log</div>
                        }
                    </div>
                    <button class="btn btn-secondary btn-sm" @onclick="ClearLogs">æ¸…ç©ºæ—¥å¿—</button>
                    <button class="btn btn-success btn-sm" @onclick="RunAllTests">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string _authStatus = "æœªè®¤è¯";
    private int _activeBattleCount = 0;
    private int _partyCount = 0;
    private int _characterCount = 0;
    private string _inventoryStatus = "æœªæµ‹è¯•";
    private int _nodeCount = 0;
    private string _questStatus = "æœªæµ‹è¯•";
    private string _serverStatus = "æœªçŸ¥";
    private List<string> _testLogs = new();

    private void AddLog(string message)
    {
        var timestamp = DateTime.Now.ToString("HH:mm:ss");
        _testLogs.Add($"[{timestamp}] {message}");
        StateHasChanged();
    }

    private void ClearLogs()
    {
        _testLogs.Clear();
        StateHasChanged();
    }

    private async Task TestAuthentication()
    {
        try
        {
            AddLog("ğŸ” å¼€å§‹æµ‹è¯•è®¤è¯æœåŠ¡...");
            var result = await ApiClient.SetupAuthenticationAsync();
            _authStatus = result.Contains("âœ…") ? "å·²è®¤è¯" : "è®¤è¯å¤±è´¥";
            AddLog($"è®¤è¯ç»“æœ: {result}");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ è®¤è¯æµ‹è¯•å¤±è´¥: {ex.Message}");
            _authStatus = "è®¤è¯å¼‚å¸¸";
        }
    }

    private async Task TestServerConnection()
    {
        try
        {
            AddLog("ğŸ”— æ£€æŸ¥æœåŠ¡å™¨è¿æ¥çŠ¶æ€...");
            var isAvailable = await ApiClient.IsServerAvailableAsync();
            _serverStatus = isAvailable ? "åœ¨çº¿" : "ç¦»çº¿";
            AddLog($"æœåŠ¡å™¨çŠ¶æ€: {_serverStatus}");
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æœåŠ¡å™¨è¿æ¥æ£€æŸ¥å¤±è´¥: {ex.Message}");
            _serverStatus = "è¿æ¥å¼‚å¸¸";
        }
    }

    private async Task TestGetActiveBattles()
    {
        try
        {
            AddLog("âš”ï¸ è·å–æ´»è·ƒæˆ˜æ–—åˆ—è¡¨...");
            var response = await ApiClient.Battle.GetActiveBattlesAsync();
            if (response.Success && response.Data != null)
            {
                _activeBattleCount = response.Data.Count;
                AddLog($"âœ… è·å–åˆ° {_activeBattleCount} ä¸ªæ´»è·ƒæˆ˜æ–—");
            }
            else
            {
                AddLog($"âš ï¸ è·å–æ´»è·ƒæˆ˜æ–—å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ æˆ˜æ–—æœåŠ¡æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }

    private async Task TestBattleOperations()
    {
        AddLog("âš”ï¸ æˆ˜æ–—æ“ä½œæµ‹è¯•...");
        AddLog("â„¹ï¸ æˆ˜æ–—æ“ä½œéœ€è¦å…·ä½“çš„è§’è‰²å’Œæ•ŒäººIDï¼Œæ­¤å¤„ä»…æµ‹è¯•æ¥å£å¯ç”¨æ€§");
        // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å…·ä½“çš„æˆ˜æ–—æ“ä½œæµ‹è¯•
    }

    private async Task TestGetAllParties()
    {
        try
        {
            AddLog("ğŸ‘¥ è·å–æ‰€æœ‰ç»„é˜Ÿ...");
            var response = await ApiClient.Party.GetAllPartiesAsync();
            if (response.Success && response.Data != null)
            {
                _partyCount = response.Data.Count;
                AddLog($"âœ… è·å–åˆ° {_partyCount} ä¸ªæ´»è·ƒé˜Ÿä¼");
            }
            else
            {
                AddLog($"âš ï¸ è·å–é˜Ÿä¼å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ ç»„é˜ŸæœåŠ¡æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }

    private async Task TestPartyOperations()
    {
        AddLog("ğŸ‘¥ ç»„é˜Ÿæ“ä½œæµ‹è¯•...");
        AddLog("â„¹ï¸ ç»„é˜Ÿæ“ä½œéœ€è¦å…·ä½“çš„è§’è‰²IDï¼Œæ­¤å¤„ä»…æµ‹è¯•æ¥å£å¯ç”¨æ€§");
        // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å…·ä½“çš„ç»„é˜Ÿæ“ä½œæµ‹è¯•
    }

    private async Task TestGetCharacters()
    {
        try
        {
            AddLog("ğŸ‘¤ è·å–è§’è‰²åˆ—è¡¨...");
            var response = await ApiClient.Character.GetCharactersAsync();
            if (response.Success && response.Data != null)
            {
                _characterCount = response.Data.Count;
                AddLog($"âœ… è·å–åˆ° {_characterCount} ä¸ªè§’è‰²");
            }
            else
            {
                AddLog($"âš ï¸ è·å–è§’è‰²å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ è§’è‰²æœåŠ¡æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }

    private async Task TestCharacterDetails()
    {
        AddLog("ğŸ‘¤ è§’è‰²è¯¦æƒ…æµ‹è¯•...");
        AddLog("â„¹ï¸ è§’è‰²è¯¦æƒ…æŸ¥è¯¢éœ€è¦å…·ä½“çš„è§’è‰²ID");
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…·ä½“çš„è§’è‰²è¯¦æƒ…æµ‹è¯•
    }

    private async Task TestInventoryOperations()
    {
        AddLog("ğŸ’ åº“å­˜æ“ä½œæµ‹è¯•...");
        _inventoryStatus = "æ¥å£å¯ç”¨";
        AddLog("â„¹ï¸ åº“å­˜æ“ä½œéœ€è¦å…·ä½“çš„è§’è‰²IDå’Œç‰©å“ID");
    }

    private async Task TestItemOperations()
    {
        AddLog("ğŸ”§ ç‰©å“æ“ä½œæµ‹è¯•...");
        AddLog("â„¹ï¸ ç‰©å“æ“ä½œåŒ…æ‹¬ä½¿ç”¨ã€è£…å¤‡ã€å‡ºå”®ç­‰åŠŸèƒ½");
    }

    private async Task TestGetGatheringNodes()
    {
        try
        {
            AddLog("âš’ï¸ è·å–é‡‡é›†èŠ‚ç‚¹...");
            var response = await ApiClient.Production.GetGatheringNodesAsync();
            if (response.Success && response.Data != null)
            {
                _nodeCount = response.Data.Count;
                AddLog($"âœ… è·å–åˆ° {_nodeCount} ä¸ªé‡‡é›†èŠ‚ç‚¹");
            }
            else
            {
                AddLog($"âš ï¸ è·å–é‡‡é›†èŠ‚ç‚¹å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ ç”Ÿäº§æœåŠ¡æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }

    private async Task TestProductionOperations()
    {
        AddLog("âš’ï¸ ç”Ÿäº§æ“ä½œæµ‹è¯•...");
        AddLog("â„¹ï¸ ç”Ÿäº§æ“ä½œåŒ…æ‹¬å¼€å§‹é‡‡é›†ã€åœæ­¢é‡‡é›†ã€æŸ¥è¯¢çŠ¶æ€ç­‰");
    }

    private async Task TestQuestOperations()
    {
        AddLog("ğŸ“‹ ä»»åŠ¡æ“ä½œæµ‹è¯•...");
        _questStatus = "æ¥å£å¯ç”¨";
        AddLog("â„¹ï¸ ä»»åŠ¡æ“ä½œåŒ…æ‹¬æ¥å—ã€å®Œæˆã€æ›´æ–°è¿›åº¦ç­‰åŠŸèƒ½");
    }

    private async Task TestMonitoringServices()
    {
        try
        {
            AddLog("ğŸ“Š ç›‘æ§æœåŠ¡æµ‹è¯•...");
            var response = await ApiClient.Monitoring.GetGameStatusAsync();
            if (response.Success && response.Data != null)
            {
                _serverStatus = response.Data.ServerStatus;
                AddLog($"âœ… æœåŠ¡å™¨çŠ¶æ€: {_serverStatus}");
                AddLog($"æ´»è·ƒç©å®¶: {response.Data.ActivePlayers}");
                AddLog($"æ´»è·ƒæˆ˜æ–—: {response.Data.ActiveBattles}");
            }
            else
            {
                AddLog($"âš ï¸ è·å–ç›‘æ§ä¿¡æ¯å¤±è´¥: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            AddLog($"âŒ ç›‘æ§æœåŠ¡æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }

    private async Task RunAllTests()
    {
        AddLog("ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...");
        ClearLogs();
        
        await TestAuthentication();
        await Task.Delay(500);
        
        await TestServerConnection();
        await Task.Delay(500);
        
        await TestGetActiveBattles();
        await Task.Delay(500);
        
        await TestGetAllParties();
        await Task.Delay(500);
        
        await TestGetCharacters();
        await Task.Delay(500);
        
        await TestGetGatheringNodes();
        await Task.Delay(500);
        
        await TestMonitoringServices();
        
        AddLog("âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ!");
    }
}