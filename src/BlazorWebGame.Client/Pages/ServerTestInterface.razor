@page "/server-api-test"
@using BlazorWebGame.Client.Services
@using BlazorWebGame.Shared.DTOs
@inject ServerApiTestService ApiTestService
@inject ServerConfigurationService ServerConfig
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>æœåŠ¡ç«¯åŠŸèƒ½æµ‹è¯•ç•Œé¢</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">ğŸ”§ æœåŠ¡ç«¯åŠŸèƒ½æµ‹è¯•ç•Œé¢</h1>
            <p class="text-muted">é€šè¿‡æ­¤ç•Œé¢å¯ä»¥æµ‹è¯•æ‰€æœ‰æœåŠ¡ç«¯APIåŠŸèƒ½ï¼Œç”¨äºå¼€å‘å’Œè°ƒè¯•ã€‚</p>
        </div>
    </div>

    <!-- æœåŠ¡å™¨è¿æ¥è®¾ç½® -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸŒ æœåŠ¡å™¨è¿æ¥è®¾ç½®</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text">æœåŠ¡å™¨åœ°å€</span>
                                <input type="text" class="form-control" @bind="serverUrl" placeholder="https://localhost:7000" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary" @onclick="UpdateServerUrl" disabled="@isLoading">
                                <i class="bi bi-arrow-clockwise"></i> æ›´æ–°åœ°å€
                            </button>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" @onchange="OnPresetServerSelected">
                                <option value="">é€‰æ‹©é¢„è®¾æœåŠ¡å™¨</option>
                                @foreach (var preset in presetServers)
                                {
                                    <option value="@preset.Url">@preset.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="text-end">
                                <small class="text-muted">å½“å‰: @ServerConfig.CurrentServerUrl</small>
                                <div class="mt-1">
                                    <button class="btn btn-sm btn-outline-info" @onclick="TestConnection" disabled="@isLoading">
                                        <i class="bi bi-wifi"></i> æµ‹è¯•è¿æ¥
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿæµ‹è¯•æŒ‰é’® -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">âš¡ å¿«é€Ÿæµ‹è¯•</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-success btn-lg w-100 mb-2" @onclick="RunAllBasicTests" disabled="@isLoading">
                                <i class="bi bi-play-circle"></i> è¿è¡Œæ‰€æœ‰åŸºç¡€æµ‹è¯•
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-warning btn-lg w-100 mb-2" @onclick="ClearResults" disabled="@isLoading">
                                <i class="bi bi-trash"></i> æ¸…ç©ºæµ‹è¯•ç»“æœ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯¦ç»†APIæµ‹è¯• -->
    <div class="row">
        <!-- å·¦ä¾§æµ‹è¯•é¢æ¿ -->
        <div class="col-lg-6">
            <!-- åŸºç¡€è¿æ¥æµ‹è¯• -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ¥ åŸºç¡€è¿æ¥æµ‹è¯•</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" @onclick="() => TestSingleFunction(TestHealthAsync)" disabled="@isLoading">
                            å¥åº·æ£€æŸ¥
                        </button>
                        <button class="btn btn-outline-primary" @onclick="() => TestSingleFunction(TestApiInfoAsync)" disabled="@isLoading">
                            APIä¿¡æ¯
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç›‘æ§APIæµ‹è¯• -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ“Š ç›‘æ§APIæµ‹è¯•</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-info" @onclick="() => TestSingleFunction(TestSystemMetricsAsync)" disabled="@isLoading">
                            ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
                        </button>
                        <button class="btn btn-outline-info" @onclick="() => TestSingleFunction(TestOperationMetricsAsync)" disabled="@isLoading">
                            æ“ä½œæ€§èƒ½ç»Ÿè®¡
                        </button>
                    </div>
                </div>
            </div>

            <!-- APIæ–‡æ¡£æµ‹è¯• -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ“– APIæ–‡æ¡£æµ‹è¯•</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-info" @onclick="() => TestSingleFunction(TestApiOverviewAsync)" disabled="@isLoading">
                            APIæ¦‚è¿°
                        </button>
                        <button class="btn btn-outline-info" @onclick="() => TestSingleFunction(TestServerInfoAsync)" disabled="@isLoading">
                            æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯
                        </button>
                    </div>
                </div>
            </div>

            <!-- è®¤è¯æµ‹è¯• -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ” è®¤è¯æµ‹è¯•</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-success" @onclick="() => TestSingleFunction(TestDemoLoginAsync)" disabled="@isLoading">
                            æ¼”ç¤ºç™»å½•
                        </button>
                    </div>
                </div>
            </div>

            <!-- è§’è‰²ç®¡ç† -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ‘¤ è§’è‰²ç®¡ç†</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2 mb-2">
                        <button class="btn btn-outline-secondary" @onclick="() => TestSingleFunction(TestGetCharactersAsync)" disabled="@isLoading">
                            è·å–è§’è‰²åˆ—è¡¨
                        </button>
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="newCharacterName" placeholder="è§’è‰²åç§°" />
                        <button class="btn btn-outline-secondary" @onclick="TestCreateCharacter" disabled="@isLoading">
                            åˆ›å»ºè§’è‰²
                        </button>
                    </div>
                </div>
            </div>

            <!-- æˆ˜æ–—ç³»ç»Ÿ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">âš”ï¸ æˆ˜æ–—ç³»ç»Ÿ</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="text" class="form-control form-control-sm" @bind="testCharacterId" placeholder="è§’è‰²ID" />
                        </div>
                        <div class="col-6">
                            <input type="text" class="form-control form-control-sm" @bind="testEnemyId" placeholder="æ•ŒäººID" />
                        </div>
                    </div>
                    <div class="d-grid gap-2 mb-2">
                        <button class="btn btn-outline-danger" @onclick="TestStartBattle" disabled="@isLoading">
                            å¼€å§‹æˆ˜æ–—
                        </button>
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="testBattleId" placeholder="æˆ˜æ–—ID" />
                        <button class="btn btn-outline-danger" @onclick="TestGetBattleState" disabled="@isLoading">
                            æŸ¥è¯¢æˆ˜æ–—çŠ¶æ€
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§æµ‹è¯•é¢æ¿ -->
        <div class="col-lg-6">
            <!-- ç»„é˜Ÿç³»ç»Ÿ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ‘¥ ç»„é˜Ÿç³»ç»Ÿ</h6>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="partyCharacterId" placeholder="è§’è‰²ID" />
                        <button class="btn btn-outline-warning" @onclick="TestCreateParty" disabled="@isLoading">
                            åˆ›å»ºé˜Ÿä¼
                        </button>
                    </div>
                </div>
            </div>

            <!-- è£…å¤‡ç³»ç»Ÿ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ›¡ï¸ è£…å¤‡ç³»ç»Ÿ</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" @onclick="() => TestSingleFunction(TestGenerateEquipmentAsync)" disabled="@isLoading">
                            ç”Ÿæˆéšæœºè£…å¤‡
                        </button>
                    </div>
                </div>
            </div>

            <!-- åº“å­˜ç³»ç»Ÿ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ’ åº“å­˜ç³»ç»Ÿ</h6>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="inventoryCharacterId" placeholder="è§’è‰²ID" />
                        <button class="btn btn-outline-info" @onclick="TestGetInventory" disabled="@isLoading">
                            è·å–åº“å­˜
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç”Ÿäº§ç³»ç»Ÿ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">â›ï¸ ç”Ÿäº§ç³»ç»Ÿ</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-success" @onclick="() => TestSingleFunction(TestGetGatheringNodesAsync)" disabled="@isLoading">
                            è·å–é‡‡é›†èŠ‚ç‚¹
                        </button>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡ç³»ç»Ÿ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ“‹ ä»»åŠ¡ç³»ç»Ÿ</h6>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="questCharacterId" placeholder="è§’è‰²ID" />
                        <button class="btn btn-outline-primary" @onclick="TestGetQuests" disabled="@isLoading">
                            è·å–ä»»åŠ¡çŠ¶æ€
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®å­˜å‚¨ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ’¾ æ•°æ®å­˜å‚¨</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-dark" @onclick="() => TestSingleFunction(TestDataStorageAsync)" disabled="@isLoading">
                            æ•°æ®å­˜å‚¨ç»Ÿè®¡
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æµ‹è¯•ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“‹ æµ‹è¯•ç»“æœ</h5>
                    <div>
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span class="text-muted">æµ‹è¯•è¿›è¡Œä¸­...</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">@testResults.Count æ¡ç»“æœ</span>
                        }
                    </div>
                </div>
                <div class="card-body">
                    @if (testResults.Any())
                    {
                        <div class="result-container" style="max-height: 500px; overflow-y: auto;">
                            @foreach (var result in testResults.AsEnumerable().Reverse())
                            {
                                <div class="alert @GetAlertClass(result) mb-2" role="alert">
                                    <small class="text-muted">@DateTime.Now.ToString("HH:mm:ss")</small>
                                    <div class="mt-1">@result</div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-clipboard" style="font-size: 2rem;"></i>
                            <p class="mt-2">æš‚æ— æµ‹è¯•ç»“æœï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•</p>
                        </div>
                    }
                </div>
                @if (testResults.Any())
                {
                    <div class="card-footer">
                        <button class="btn btn-sm btn-outline-secondary" @onclick="ExportResults">
                            <i class="bi bi-download"></i> å¯¼å‡ºç»“æœ
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private string serverUrl = "https://localhost:7000";
    private bool isLoading = false;
    private List<string> testResults = new();
    private List<ServerOption> presetServers = new();

    // æµ‹è¯•å‚æ•°
    private string newCharacterName = "TestCharacter";
    private string testCharacterId = "test-character-1";
    private string testEnemyId = "goblin";
    private string testBattleId = "";
    private string partyCharacterId = "test-character-1";
    private string inventoryCharacterId = "test-character-1";
    private string questCharacterId = "test-character-1";

    protected override async Task OnInitializedAsync()
    {
        // åˆå§‹åŒ–æœåŠ¡å™¨é…ç½®æœåŠ¡
        await ServerConfig.InitializeAsync();
        
        // è·å–é¢„è®¾æœåŠ¡å™¨é€‰é¡¹
        presetServers = ServerConfig.GetPresetServerOptions();
        
        // åŒæ­¥å½“å‰URL
        serverUrl = ServerConfig.CurrentServerUrl;

        // è®¢é˜…æœåŠ¡å™¨åœ°å€å˜æ›´äº‹ä»¶
        ServerConfig.ServerUrlChanged += OnServerUrlChanged;
    }

    private void OnServerUrlChanged(string newUrl)
    {
        serverUrl = newUrl;
        InvokeAsync(StateHasChanged);
        AddResult($"âœ… æœåŠ¡å™¨åœ°å€å·²è‡ªåŠ¨åŒæ­¥: {newUrl}");
    }

    private async Task UpdateServerUrl()
    {
        if (isLoading) return;
        
        try
        {
            isLoading = true;
            await ServerConfig.SetServerUrlAsync(serverUrl);
            AddResult($"âœ… æœåŠ¡å™¨åœ°å€å·²æ›´æ–°ä¸º: {serverUrl}");
        }
        catch (Exception ex)
        {
            AddResult($"âŒ æ›´æ–°æœåŠ¡å™¨åœ°å€å¤±è´¥: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnPresetServerSelected(ChangeEventArgs e)
    {
        if (e.Value?.ToString() is string selectedUrl && !string.IsNullOrEmpty(selectedUrl))
        {
            serverUrl = selectedUrl;
            await UpdateServerUrl();
        }
    }

    private async Task TestConnection()
    {
        if (isLoading) return;
        
        try
        {
            isLoading = true;
            AddResult("ğŸ”„ æ­£åœ¨æµ‹è¯•æœåŠ¡å™¨è¿æ¥...");
            
            var isConnected = await ServerConfig.TestServerConnectionAsync();
            if (isConnected)
            {
                AddResult($"âœ… æœåŠ¡å™¨è¿æ¥æµ‹è¯•æˆåŠŸ: {ServerConfig.CurrentServerUrl}");
            }
            else
            {
                AddResult($"âŒ æœåŠ¡å™¨è¿æ¥æµ‹è¯•å¤±è´¥: {ServerConfig.CurrentServerUrl}");
            }
        }
        catch (Exception ex)
        {
            AddResult($"âŒ è¿æ¥æµ‹è¯•å¼‚å¸¸: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    public async ValueTask DisposeAsync()
    {
        ServerConfig.ServerUrlChanged -= OnServerUrlChanged;
    }

    private async Task RunAllBasicTests()
    {
        if (isLoading) return;
        
        isLoading = true;
        AddResult("ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰åŸºç¡€æµ‹è¯•...");
        
        try
        {
            var results = await ApiTestService.RunAllBasicTestsAsync();
            foreach (var result in results)
            {
                AddResult(result);
            }
        }
        catch (Exception ex)
        {
            AddResult($"âŒ æ‰¹é‡æµ‹è¯•å¼‚å¸¸: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task TestSingleFunction(Func<Task<string>> testFunction)
    {
        if (isLoading) return;
        
        isLoading = true;
        try
        {
            var result = await testFunction();
            AddResult(result);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task TestCreateCharacter()
    {
        if (string.IsNullOrWhiteSpace(newCharacterName)) return;
        await TestSingleFunction(() => ApiTestService.TestCreateCharacterAsync(newCharacterName));
    }

    private async Task TestStartBattle()
    {
        if (string.IsNullOrWhiteSpace(testCharacterId) || string.IsNullOrWhiteSpace(testEnemyId)) return;
        await TestSingleFunction(() => ApiTestService.TestStartBattleAsync(testCharacterId, testEnemyId));
    }

    private async Task TestGetBattleState()
    {
        if (string.IsNullOrWhiteSpace(testBattleId)) return;
        await TestSingleFunction(() => ApiTestService.TestGetBattleStateAsync(testBattleId));
    }

    private async Task TestCreateParty()
    {
        if (string.IsNullOrWhiteSpace(partyCharacterId)) return;
        await TestSingleFunction(() => ApiTestService.TestCreatePartyAsync(partyCharacterId));
    }

    private async Task TestGetInventory()
    {
        if (string.IsNullOrWhiteSpace(inventoryCharacterId)) return;
        await TestSingleFunction(() => ApiTestService.TestGetInventoryAsync(inventoryCharacterId));
    }

    private async Task TestGetQuests()
    {
        if (string.IsNullOrWhiteSpace(questCharacterId)) return;
        await TestSingleFunction(() => ApiTestService.TestGetQuestsAsync(questCharacterId));
    }

    // åŒ…è£…å¼‚æ­¥æ–¹æ³•ä¸ºåŒæ­¥å§”æ‰˜
    private Task<string> TestHealthAsync() => ApiTestService.TestHealthAsync();
    private Task<string> TestApiInfoAsync() => ApiTestService.TestApiInfoAsync();
    private Task<string> TestApiOverviewAsync() => ApiTestService.TestApiOverviewAsync();
    private Task<string> TestServerInfoAsync() => ApiTestService.TestServerInfoAsync();
    private Task<string> TestSystemMetricsAsync() => ApiTestService.TestSystemMetricsAsync();
    private Task<string> TestOperationMetricsAsync() => ApiTestService.TestOperationMetricsAsync();
    private Task<string> TestDemoLoginAsync() => ApiTestService.TestDemoLoginAsync();
    private Task<string> TestGetCharactersAsync() => ApiTestService.TestGetCharactersAsync();
    private Task<string> TestGenerateEquipmentAsync() => ApiTestService.TestGenerateEquipmentAsync();
    private Task<string> TestGetGatheringNodesAsync() => ApiTestService.TestGetGatheringNodesAsync();
    private Task<string> TestDataStorageAsync() => ApiTestService.TestDataStorageAsync();

    private void AddResult(string result)
    {
        testResults.Add(result);
        InvokeAsync(StateHasChanged);
        
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        InvokeAsync(async () =>
        {
            await Task.Delay(100);
            await JSRuntime.InvokeVoidAsync("scrollToBottom", ".result-container");
        });
    }

    private void ClearResults()
    {
        testResults.Clear();
        AddResult("ğŸ—‘ï¸ æµ‹è¯•ç»“æœå·²æ¸…ç©º");
    }

    private string GetAlertClass(string result)
    {
        if (result.StartsWith("âœ…")) return "alert-success";
        if (result.StartsWith("âŒ")) return "alert-danger";
        if (result.StartsWith("âš ï¸")) return "alert-warning";
        if (result.StartsWith("===") || result.StartsWith("ğŸš€") || result.StartsWith("ğŸ—‘ï¸")) return "alert-info";
        return "alert-light";
    }

    private async Task ExportResults()
    {
        var exportData = string.Join("\n", testResults);
        var fileName = $"server-test-results-{DateTime.Now:yyyyMMdd-HHmmss}.txt";
        
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, exportData);
    }
}

<style>
    .result-container {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }
    
    .alert {
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.375rem;
    }
    
    .card-header h6 {
        color: #495057;
        font-weight: 600;
    }
    
    .btn-outline-primary:hover,
    .btn-outline-secondary:hover,
    .btn-outline-success:hover,
    .btn-outline-danger:hover,
    .btn-outline-warning:hover,
    .btn-outline-info:hover,
    .btn-outline-dark:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }
</style>

<script>
    window.scrollToBottom = (selector) => {
        const element = document.querySelector(selector);
        if (element) {
            element.scrollTop = element.scrollHeight;
        }
    };

    window.downloadFile = (filename, text) => {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    };
</script>