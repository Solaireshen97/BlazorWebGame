# BlazorWebGame.Rebuild 快速开始指南

## 1. 项目编译

### 恢复依赖包

```bash
cd src/BlazorWebGame.Rebuild
dotnet restore
```

### 编译项目

```bash
dotnet build
```

**预期结果**:
```
Build succeeded.
    102 Warning(s)
    0 Error(s)
```

## 2. 运行项目

### 基本运行

```bash
dotnet run
```

### 指定端口运行

```bash
dotnet run --urls="https://localhost:7052;http://localhost:5191"
```

**启动成功标志**:
```
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:7052
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5191
```

## 3. 访问 API

### Swagger UI

打开浏览器访问：
```
https://localhost:7052/swagger
```

您将看到完整的 API 文档，包括：
- 15 个控制器
- 80+ 个 API 端点
- 可交互的 API 测试界面

### 健康检查

```bash
curl https://localhost:7052/health
```

### 测试 API 端点

#### 1. 用户注册

```bash
curl -X POST https://localhost:7052/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "Test123456!",
    "email": "test@example.com"
  }'
```

#### 2. 用户登录

```bash
curl -X POST https://localhost:7052/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "Test123456!"
  }'
```

**返回示例**:
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userId": "123",
    "username": "testuser"
  }
}
```

#### 3. 创建角色（需要认证）

```bash
curl -X POST https://localhost:7052/api/character/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "name": "勇者"
  }'
```

#### 4. 获取角色列表

```bash
curl -X GET https://localhost:7052/api/character/list \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

## 4. 使用 SignalR 实时通信

### JavaScript 客户端示例

```javascript
// 安装 SignalR 客户端
// npm install @microsoft/signalr

import * as signalR from "@microsoft/signalr";

// 创建连接
const connection = new signalR.HubConnectionBuilder()
    .withUrl("https://localhost:7052/gamehub", {
        accessTokenFactory: () => "YOUR_JWT_TOKEN"
    })
    .withAutomaticReconnect()
    .build();

// 监听事件
connection.on("ReceiveBattleUpdate", (battleState) => {
    console.log("战斗状态更新:", battleState);
});

connection.on("ReceiveCharacterUpdate", (character) => {
    console.log("角色状态更新:", character);
});

// 建立连接
await connection.start();
console.log("SignalR 已连接");

// 发送消息
await connection.invoke("JoinBattle", "battle-id-123");
```

### C# 客户端示例

```csharp
using Microsoft.AspNetCore.SignalR.Client;

var connection = new HubConnectionBuilder()
    .WithUrl("https://localhost:7052/gamehub", options =>
    {
        options.AccessTokenProvider = () => Task.FromResult("YOUR_JWT_TOKEN");
    })
    .WithAutomaticReconnect()
    .Build();

// 监听事件
connection.On<BattleStateDto>("ReceiveBattleUpdate", battleState =>
{
    Console.WriteLine($"战斗状态更新: {battleState.BattleId}");
});

// 连接
await connection.StartAsync();
Console.WriteLine("SignalR 已连接");

// 调用方法
await connection.InvokeAsync("JoinBattle", "battle-id-123");
```

## 5. 数据库操作

### 查看数据库

项目使用 SQLite 数据库，文件位置：
```
src/BlazorWebGame.Rebuild/gamedata.db
```

### 使用 SQLite 工具查看

```bash
# 安装 SQLite
sudo apt install sqlite3

# 打开数据库
sqlite3 gamedata.db

# 查看所有表
.tables

# 查看表结构
.schema Users

# 查询数据
SELECT * FROM Users;
SELECT * FROM Players;
```

### Entity Framework Core 迁移

如果需要修改数据库结构：

```bash
# 添加迁移
dotnet ef migrations add YourMigrationName

# 更新数据库
dotnet ef database update

# 回滚迁移
dotnet ef database update PreviousMigration

# 删除最后一个迁移
dotnet ef migrations remove
```

## 6. 开发调试

### Visual Studio Code

1. 打开项目文件夹
```bash
code src/BlazorWebGame.Rebuild
```

2. 按 F5 开始调试

### Visual Studio

1. 打开解决方案
```bash
start BlazorWebGame.sln
```

2. 设置 BlazorWebGame.Rebuild 为启动项目

3. 按 F5 开始调试

### 日志查看

日志文件位置：
```
src/BlazorWebGame.Rebuild/logs/
```

实时查看日志：
```bash
tail -f logs/blazorwebgame-*.log
```

## 7. 测试

### 运行所有测试

```bash
dotnet test
```

### 运行特定测试

```bash
dotnet test --filter "ClassName=DataStorageServiceTests"
```

### 测试覆盖率

```bash
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura
```

## 8. 性能监控

### 访问监控端点

```bash
# 服务器状态
curl https://localhost:7052/api/monitoring/server-status

# 性能指标
curl https://localhost:7052/api/monitoring/performance-metrics

# 游戏统计
curl https://localhost:7052/api/monitoring/game-statistics
```

### 响应示例

```json
{
  "success": true,
  "data": {
    "uptime": "02:30:15",
    "memoryUsage": 125.5,
    "cpuUsage": 12.3,
    "activeConnections": 42,
    "requestsPerSecond": 150.2
  }
}
```

## 9. 常见问题

### Q1: 端口被占用

**错误**: `Failed to bind to address https://localhost:7052`

**解决**:
```bash
# 修改端口
dotnet run --urls="https://localhost:8052;http://localhost:6191"
```

或编辑 `appsettings.json`:
```json
{
  "Kestrel": {
    "Endpoints": {
      "Https": {
        "Url": "https://localhost:8052"
      }
    }
  }
}
```

### Q2: 数据库连接失败

**错误**: `Cannot open database`

**解决**:
1. 确保有写入权限
```bash
chmod 664 gamedata.db
```

2. 删除并重新创建数据库
```bash
rm gamedata.db
dotnet run
```

### Q3: JWT 认证失败

**错误**: `401 Unauthorized`

**解决**:
1. 检查 JWT 配置（appsettings.json）
2. 确保 token 未过期
3. 验证 Bearer token 格式：`Authorization: Bearer YOUR_TOKEN`

### Q4: CORS 错误

**错误**: `CORS policy blocked`

**解决**:
编辑 `appsettings.json`:
```json
{
  "Security": {
    "Cors": {
      "AllowedOrigins": [
        "https://localhost:7051",
        "http://localhost:5190",
        "https://your-domain.com"
      ]
    }
  }
}
```

## 10. 生产部署

### 发布版本

```bash
dotnet publish -c Release -o ./publish
```

### Docker 部署

创建 `Dockerfile`:
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
COPY ./publish .
EXPOSE 80
EXPOSE 443
ENTRYPOINT ["dotnet", "BlazorWebGame.Rebuild.dll"]
```

构建镜像：
```bash
docker build -t blazorwebgame-rebuild .
```

运行容器：
```bash
docker run -d -p 8080:80 -p 8443:443 blazorwebgame-rebuild
```

### 环境变量配置

```bash
export ASPNETCORE_ENVIRONMENT=Production
export ConnectionStrings__GameDatabase="Data Source=/data/gamedata.db"
export Jwt__Key="your-super-secret-key-min-32-chars"
export Jwt__Issuer="BlazorWebGame"
export Jwt__Audience="BlazorWebGame.Client"
```

## 11. 开发工作流

### 典型的开发流程

1. **启动项目**
```bash
dotnet run
```

2. **修改代码**（实时重新加载已启用）

3. **测试 API**（使用 Swagger 或 Postman）

4. **查看日志**
```bash
tail -f logs/blazorwebgame-*.log
```

5. **运行测试**
```bash
dotnet test
```

6. **提交代码**
```bash
git add .
git commit -m "Your changes"
git push
```

## 12. 推荐工具

### API 测试
- **Swagger UI** (内置): https://localhost:7052/swagger
- **Postman**: 导入 Swagger JSON
- **curl**: 命令行测试

### 数据库管理
- **DB Browser for SQLite**: GUI 工具
- **DBeaver**: 通用数据库工具
- **SQLite CLI**: 命令行工具

### 日志分析
- **Seq**: 结构化日志服务器
- **Serilog**: 已集成
- **grep/awk**: 命令行工具

### 性能分析
- **dotnet-trace**: 性能跟踪
- **dotnet-counters**: 性能计数器
- **Application Insights**: Azure 监控

## 13. 下一步

现在您已经成功运行了 BlazorWebGame.Rebuild 项目，可以：

1. ✅ 浏览和测试所有 API 端点
2. ✅ 研究事件系统的工作原理
3. ✅ 了解数据库结构
4. ✅ 学习服务架构设计
5. ✅ 修改和扩展功能
6. ✅ 创建自己的实现版本

## 参考资源

- **项目说明**: `README.md`
- **架构对比**: `架构对比说明.md`
- **总体说明**: `/BlazorWebGame.Rebuild项目说明.md`
- **API 文档**: https://localhost:7052/swagger
- **.NET 文档**: https://docs.microsoft.com/dotnet
- **SignalR 文档**: https://docs.microsoft.com/aspnet/core/signalr

---

**祝开发顺利！** 🚀
